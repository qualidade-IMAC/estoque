<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque e Produção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: {
                        ios: {
                            bg: '#000000', card: '#1c1c1e', cardHover: '#2c2c2e', blue: '#0a84ff',
                            green: '#30d158', red: '#ff453a', orange: '#ff9f0a', text: '#ffffff',
                            textMuted: 'rgba(235, 235, 245, 0.6)', border: '#38383a', input: '#2c2c2e'
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer components {
            body { @apply bg-ios-bg text-ios-text font-sans antialiased pb-16; }
            .card { @apply bg-ios-card p-6 rounded-2xl shadow-sm border border-ios-border; }
            .title-lg { @apply text-3xl font-bold text-white mb-6 tracking-tight; }
            .title-md { @apply text-xl font-semibold text-white mb-4 tracking-tight; }
            .form-label { @apply block text-sm font-medium text-ios-textMuted mb-1; }
            .form-input { @apply block w-full bg-ios-input text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-ios-blue transition-all border border-ios-border/50; }
            .btn-primary { @apply bg-ios-blue hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center cursor-pointer; }
            .btn-secondary { @apply bg-ios-cardHover hover:bg-gray-700 text-white font-semibold py-3 px-5 rounded-xl transition-all border border-ios-border flex items-center justify-center cursor-pointer; }
            .btn-danger { @apply bg-ios-red hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all flex items-center justify-center cursor-pointer; }
            .btn-success { @apply bg-ios-green hover:opacity-90 text-white font-semibold py-3 px-5 rounded-xl transition-all cursor-pointer; }
            .table-container { @apply overflow-x-auto rounded-xl border border-ios-border bg-ios-card; }
            .base-table { @apply w-full text-sm text-left text-ios-textMuted; }
            .base-thead { @apply text-xs uppercase bg-ios-cardHover text-gray-400 border-b border-ios-border; }
            .base-tr { @apply border-b border-ios-border hover:bg-ios-cardHover transition-colors; }
            .base-th { @apply px-5 py-4 font-semibold whitespace-nowrap; }
            .base-td { @apply px-5 py-4; }
            .modal-content { @apply bg-ios-card border border-ios-border rounded-3xl shadow-2xl p-6 w-full transform transition-all; }
            .badge { @apply text-xs font-semibold px-2 py-1 rounded-md; }
        }
    </style>
    <style>
        .sidebar { transition: width 0.3s ease-in-out; }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        .table-header-sortable { cursor: pointer; user-select: none; }
        .table-header-sortable:hover { color: #ffffff; }
        
        .searchable-container { position: relative; width: 100%; }
        .searchable-dropdown { 
            position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; max-height: 280px; 
            overflow-y: auto; background-color: #2c2c2e; border: 1px solid #38383a; 
            border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-top: 4px;
        }
        .searchable-item { padding: 0.85rem 1rem; cursor: pointer; color: #ffffff; border-bottom: 1px solid #38383a; transition: background-color 0.2s; }
        .searchable-item:last-child { border-bottom: none; }
        .searchable-item:hover { background-color: #0a84ff; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #48484a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #636366; }

        .toggle-status { appearance: none; width: 40px; height: 20px; background: #38383a; border-radius: 20px; position: relative; cursor: pointer; outline: none; transition: background 0.3s; margin: 0; }
        .toggle-status::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .toggle-status:checked { background: #30d158; }
        .toggle-status:checked::after { transform: translateX(20px); }

        .timer-active { color: #ff9f0a; animation: pulse-text 1.5s infinite; }
        @keyframes pulse-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-up-active { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .ui-checkbox {
            appearance: none; -webkit-appearance: none; background-color: #2c2c2e; border: 2px solid #48484a; 
            width: 24px; height: 24px; border-radius: 6px; cursor: pointer; position: relative; transition: all 0.2s; display: inline-block; vertical-align: middle; margin: 0;
        }
        .ui-checkbox:checked { background-color: #0a84ff; border-color: #0a84ff; }
        .ui-checkbox:checked::after {
            content: ''; position: absolute; left: 7px; top: 3px; width: 6px; height: 12px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }
        .ui-checkbox-success:checked { background-color: #30d158; border-color: #30d158; }
        
        .form-input { transition: all 0.4s ease; }
        #main-camera-reader video, #picking-camera-reader video, #entry-camera-reader video, #entry-loc-camera-reader video, #address-camera-reader video { border-radius: 0.75rem; width: 100% !important; height: auto !important; object-fit: cover;}
    </style>
</head>
<body class="bg-ios-bg text-ios-text font-sans antialiased flex h-screen overflow-hidden w-full relative">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-black bg-opacity-80 backdrop-blur-md transition-opacity">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-ios-cardHover border-t-ios-blue mb-4"></div>
        <p class="text-ios-textMuted font-medium" id="loading-text">Processando...</p>
    </div>

    <!-- Notification -->
    <div id="notification-modal" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[2000] hidden py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-sm backdrop-blur-md"></div>

    <!-- Tela de Login -->
    <div id="login-wrapper" class="absolute inset-0 z-[999] flex flex-col items-center justify-center bg-ios-bg text-center px-4 hidden">
        <div class="card max-w-md w-full py-10 px-6 border border-ios-border/50 shadow-2xl">
            <div class="w-20 h-20 rounded-2xl bg-ios-blue flex items-center justify-center text-white font-bold text-4xl shadow-lg shadow-ios-blue/30 mx-auto mb-6"><i class="fa-solid fa-layer-group"></i></div>
            <h2 class="title-lg mb-2 text-white">Estoque OS</h2>
            <p class="text-ios-textMuted mb-8 text-sm">Faça login para nuvem ou acesse localmente em modo offline.</p>
            <button id="btn-login-google" class="btn-primary w-full py-4 text-lg font-bold"><i class="fa-brands fa-google mr-2"></i>Entrar com o Google</button>
            <button id="btn-bypass-login" class="btn-secondary w-full py-3 mt-4 text-sm"><i class="fa-solid fa-wifi mr-2"></i>Acessar Modo Offline (Local)</button>
            <div id="mensagem-erro" class="text-ios-red mt-4 font-medium text-sm text-left bg-ios-red/10 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app-wrapper" class="flex h-screen overflow-hidden w-full hidden">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-[#000000] border-r border-ios-border flex flex-col py-6 transition-all duration-300 z-40">
            <div class="px-4 mb-8 flex items-center justify-center lg:justify-start">
                <div class="w-10 h-10 rounded-xl bg-ios-blue flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-ios-blue/30"><i class="fa-solid fa-layer-group"></i></div>
                <span class="ml-3 font-bold text-xl text-white hidden lg:block tracking-tight">Estoque OS</span>
            </div>
            <nav class="flex-1 w-full px-3 space-y-2 overflow-y-auto">
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="dashboard"><i class="fa-solid fa-home w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Início</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="addressing"><i class="fa-solid fa-map-location-dot w-6 text-center text-lg text-ios-blue"></i><span class="ml-3 hidden lg:block font-medium text-ios-blue">Endereçamento</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="scanner"><i class="fa-solid fa-barcode w-6 text-center text-lg text-ios-green"></i><span class="ml-3 hidden lg:block font-medium text-ios-green">Cód. Barras (Item)</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="entry"><i class="fa-solid fa-box-open w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Entrada Lote</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="inventory"><i class="fa-solid fa-boxes-stacked w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Estoque Geral</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="recipes"><i class="fa-solid fa-book-bookmark w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Receitas</span></a>
                <div class="border-t border-ios-border my-2 mx-2"></div>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="picking">
                    <i class="fa-solid fa-dolly w-6 text-center text-lg text-ios-orange"></i><span class="ml-3 hidden lg:block font-medium text-ios-orange">Separação (Picking)</span>
                    <span id="badge-nav-picking" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-orange rounded-full animate-pulse hidden"></span>
                </a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all relative" data-target="production">
                    <i class="fa-solid fa-hammer w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Produção (OP)</span>
                    <span id="badge-nav-prod" class="absolute top-3 right-3 w-2.5 h-2.5 bg-ios-blue rounded-full animate-pulse hidden"></span>
                </a>
                <div class="border-t border-ios-border my-2 mx-2"></div>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="requisitions"><i class="fa-solid fa-arrow-right-from-bracket w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Requisição Avulsa</span></a>
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="adjustments"><i class="fa-solid fa-sliders w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Ajuste de Lote</span></a>
            </nav>
            <div class="mt-auto w-full px-3 pt-4 border-t border-ios-border">
                <a href="#" class="nav-item p-3 rounded-xl flex items-center w-full text-ios-textMuted hover:bg-ios-card hover:text-white transition-all" data-target="settings"><i class="fa-solid fa-gear w-6 text-center text-lg"></i><span class="ml-3 hidden lg:block font-medium">Ajustes App</span></a>
                <div class="flex items-center justify-between mt-4 px-2 py-3 bg-ios-card rounded-xl border border-ios-border/50">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-ios-blue/20 text-ios-blue flex items-center justify-center shrink-0"><i class="fa-solid fa-user text-xs"></i></div>
                        <span id="nome-usuario" class="text-xs text-white font-bold truncate">...</span>
                    </div>
                    <button id="btn-sair" class="text-ios-red hover:text-red-400 p-2 shrink-0 bg-ios-red/10 rounded-lg transition-colors" title="Sair do Sistema"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-6 lg:p-10 overflow-y-auto bg-ios-bg relative z-0 h-full">
            
            <!-- Home / Dash Leve -->
            <div id="screen-dashboard" class="screen-panel flex-col gap-6">
                <h1 class="title-lg mb-0">Menu Rápido</h1>
                <p class="text-ios-textMuted mb-2 italic">"Não se gerencia o que não se mede, não se mede o que não se define, não se define o que não se entende..."</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <button class="card flex flex-col items-center justify-center p-6 hover:bg-ios-cardHover transition border border-transparent hover:border-ios-green" onclick="window.navTo('scanner')">
                        <i class="fa-solid fa-barcode text-4xl text-ios-green mb-3"></i><span class="font-semibold text-white">Ler Código</span>
                    </button>
                    <button class="card flex flex-col items-center justify-center p-6 hover:bg-ios-cardHover transition border border-transparent hover:border-ios-blue" onclick="window.navTo('entry')">
                        <i class="fa-solid fa-box-open text-4xl text-ios-blue mb-3"></i><span class="font-semibold text-white">Nova Entrada</span>
                    </button>
                    <button class="card flex flex-col items-center justify-center p-6 hover:bg-ios-cardHover transition border border-transparent hover:border-ios-orange" onclick="window.navTo('picking')">
                        <i class="fa-solid fa-dolly text-4xl text-ios-orange mb-3"></i><span class="font-semibold text-white">Separação</span>
                    </button>
                    <button class="card flex flex-col items-center justify-center p-6 hover:bg-ios-cardHover transition border border-transparent hover:border-ios-blue" onclick="window.navTo('addressing')">
                        <i class="fa-solid fa-map-location-dot text-4xl text-ios-blue mb-3"></i><span class="font-semibold text-white">Endereços</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                    <div class="card flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="title-md text-ios-red mb-0"><i class="fa-solid fa-clock mr-2"></i>Vencimento (Próx. 45 dias)</h2>
                            <span class="badge bg-ios-red/20 text-ios-red" id="home-count-expiring">0</span>
                        </div>
                        <ul id="home-expiring-list" class="space-y-3 overflow-y-auto max-h-96 pr-2"></ul>
                    </div>
                    <div class="card flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="title-md text-ios-orange mb-0"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Estoque Baixo</h2>
                            <span class="badge bg-ios-orange/20 text-ios-orange" id="home-count-low">0</span>
                        </div>
                        <ul id="home-low-stock-list" class="space-y-3 overflow-y-auto max-h-96 pr-2"></ul>
                    </div>
                </div>
            </div>

            <!-- Endereçamento -->
            <div id="screen-addressing" class="screen-panel hidden flex-col items-center max-w-5xl mx-auto py-10">
                <div class="w-full flex justify-between items-center mb-6">
                    <div>
                        <h1 class="title-lg text-ios-blue mb-2"><i class="fa-solid fa-map-location-dot mr-3"></i>Consulta de Endereçamento</h1>
                        <p class="text-ios-textMuted">Bipe o local (Rua/Prateleira) para ver os insumos armazenados e as reservas.</p>
                    </div>
                    <button id="btn-manage-locations" class="btn-secondary whitespace-nowrap"><i class="fa-solid fa-list-ul mr-2"></i>Gerenciar Locais</button>
                </div>
                <div class="flex gap-4 w-full max-w-md mx-auto mb-4">
                    <button id="btn-start-camera-address" class="btn-secondary w-full py-4 text-ios-blue border-ios-blue/30 bg-ios-blue/10"><i class="fa-solid fa-camera mr-2"></i>Ler Câmera</button>
                </div>
                <div id="address-camera-reader" class="w-full max-w-md mx-auto hidden mb-6 border border-ios-border rounded-xl bg-black overflow-hidden"></div>
                <div class="w-full card bg-ios-cardHover border-2 border-ios-blue/30 p-8 shadow-2xl relative overflow-hidden">
                    <input type="text" id="address-input" class="w-full bg-ios-bg border-2 border-ios-border text-white text-3xl font-mono text-center py-6 rounded-2xl focus:border-ios-blue focus:ring-4 focus:ring-ios-blue/20 transition-all outline-none uppercase" placeholder="Bipe o Código do Local..." autocomplete="off">
                </div>

                <div id="address-result-box" class="w-full card mt-6 hidden flex-col transition-all duration-300 opacity-0 transform translate-y-4">
                    <div class="flex justify-between items-center border-b border-ios-border pb-4 mb-4">
                        <h2 class="text-2xl font-bold text-white mb-1"><i class="fa-solid fa-location-dot mr-2 text-ios-blue"></i> Local: <span id="address-res-name" class="text-ios-blue"></span></h2>
                        <span class="badge bg-ios-cardHover border border-ios-border text-ios-textMuted px-3 py-1" id="address-res-count">0 Lotes</span>
                    </div>
                    <div class="table-container">
                        <table class="base-table">
                            <thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th">Lote</th><th class="base-th">Validade</th><th class="base-th text-right">Físico Total</th><th class="base-th text-right text-ios-orange">Reservado (OP)</th><th class="base-th text-right text-ios-green">Saldo Livre</th></tr></thead>
                            <tbody id="address-table-body" class="divide-y divide-ios-border"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Scanner (Item) -->
            <div id="screen-scanner" class="screen-panel hidden flex-col items-center max-w-4xl mx-auto py-10">
                <h1 class="title-lg w-full text-center text-ios-green mb-2"><i class="fa-solid fa-barcode mr-3"></i>Leitor de Código de Barras</h1>
                <p class="text-ios-textMuted mb-8 text-center">Bipe a embalagem da matéria-prima. O sistema mostrará todos os lotes e locais onde o item está guardado.</p>
                <div class="flex gap-4 w-full max-w-md mx-auto mb-4">
                    <button id="btn-start-camera-main" class="btn-secondary w-full py-4 text-ios-blue border-ios-blue/30 bg-ios-blue/10"><i class="fa-solid fa-camera mr-2"></i>Usar Câmera do Dispositivo</button>
                </div>
                <div id="main-camera-reader" class="w-full max-w-md mx-auto hidden mb-6 border border-ios-border rounded-xl bg-black overflow-hidden"></div>
                <div class="w-full card bg-ios-cardHover border-2 border-ios-green/30 p-8 shadow-2xl relative overflow-hidden">
                    <div class="absolute inset-0 border-b-2 border-ios-green animate-[slideUp_2s_ease-in-out_infinite] opacity-20 pointer-events-none" style="height: 10px;"></div>
                    <input type="text" id="scanner-input" class="w-full bg-ios-bg border-2 border-ios-border text-white text-3xl font-mono text-center py-6 rounded-2xl focus:border-ios-green transition-all outline-none" placeholder="Aguardando código..." autocomplete="off">
                </div>

                <div id="scanner-result-box" class="w-full card mt-6 hidden flex-col transition-all duration-300 opacity-0 transform translate-y-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-ios-border pb-4 mb-4 gap-4">
                        <div>
                            <span class="badge bg-ios-blue/20 text-ios-blue mb-2 block w-max" id="scan-res-type">Insumo</span>
                            <h2 class="text-2xl font-bold text-white mb-1" id="scan-res-name">Nome do Produto</h2>
                            <p class="text-ios-textMuted text-sm">Cód Sistema: <span id="scan-res-code" class="text-white font-mono"></span> | Código Barras: <span id="scan-res-barcode" class="text-white font-mono"></span></p>
                        </div>
                        <div class="text-left md:text-right bg-ios-bg p-4 rounded-xl border border-ios-border w-full md:w-auto">
                            <p class="text-xs text-ios-textMuted uppercase font-bold tracking-wide mb-1">Saldo Consolidado Global</p>
                            <p class="text-3xl font-bold text-ios-green" id="scan-res-stock">0.00</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Distribuição por Lote e Local</h3>
                        <div class="table-container max-h-64 overflow-y-auto">
                            <table class="base-table w-full text-left">
                                <thead class="base-thead"><tr><th class="base-th">Lote</th><th class="base-th">Local (Rua)</th><th class="base-th text-right">Qtd Física</th><th class="base-th text-right">Livre</th></tr></thead>
                                <tbody id="scan-res-batches" class="divide-y divide-ios-border"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="scanner-associate-box" class="w-full card mt-6 hidden flex-col border-ios-orange/50 transition-all duration-300 opacity-0 transform translate-y-4">
                    <div class="flex items-center text-ios-orange mb-4">
                        <i class="fa-solid fa-triangle-exclamation text-2xl mr-3"></i>
                        <div><h3 class="text-lg font-bold text-white leading-tight">Código Não Reconhecido</h3><p class="text-sm">O código <strong class="font-mono text-white" id="unrecognized-code"></strong> não pertence a nenhum produto.</p></div>
                    </div>
                    <div class="bg-ios-bg p-5 rounded-2xl border border-ios-border">
                        <label class="form-label text-white font-bold mb-2">A qual insumo do sistema este código pertence?</label>
                        <div id="associate-searchable-container" class="relative z-50 mb-4"></div>
                        <button id="btn-associate-code" class="btn-primary w-full py-4"><i class="fa-solid fa-link mr-2"></i>Vincular Código ao Produto</button>
                    </div>
                </div>
            </div>

            <!-- Entrada -->
            <div id="screen-entry" class="screen-panel hidden">
                <h1 class="title-lg">Nova Entrada Físico (Lote Específico)</h1>
                <div class="card max-w-3xl mx-auto">
                    <form id="entry-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="md:col-span-1">
                                <label class="form-label flex justify-between items-end mb-1">
                                    <span>Cód. Produto / Barras</span>
                                    <button type="button" id="btn-start-camera-entry" class="text-ios-blue text-xs flex items-center bg-ios-blue/10 px-2 py-1 rounded hover:bg-ios-blue/20 transition-colors"><i class="fa-solid fa-camera mr-1"></i>Ler Câmera</button>
                                </label>
                                <input type="text" id="entry-product-code" name="product-code" class="form-input text-lg font-mono placeholder:text-sm placeholder:font-sans" placeholder="Busca automática...">
                                <div id="entry-camera-reader" class="w-full hidden mt-2 border border-ios-border rounded-xl bg-black overflow-hidden"></div>
                            </div>
                            <div class="md:col-span-1">
                                <label class="form-label flex justify-between items-end mb-1">
                                    <span>Endereço (Rua/Prateleira)</span>
                                    <button type="button" id="btn-start-camera-entry-loc" class="text-ios-blue text-xs flex items-center bg-ios-blue/10 px-2 py-1 rounded hover:bg-ios-blue/20 transition-colors"><i class="fa-solid fa-camera mr-1"></i>Ler Câmera</button>
                                </label>
                                <input type="text" id="entry-location" name="location" class="form-input uppercase" placeholder="Ex: RUA-A-01" autocomplete="off">
                                <div id="entry-loc-camera-reader" class="w-full hidden mt-2 border border-ios-border rounded-xl bg-black overflow-hidden"></div>
                            </div>
                            <div class="md:col-span-2"><label class="form-label">Nome do Produto</label><input type="text" name="product-name" id="entry-product-name" required class="form-input"></div>
                            <div><label class="form-label">Tipo</label><select name="product-type" id="entry-product-type" required class="form-input"><option value="insumo">Insumo</option><option value="semi_acabado">Semi-acabado</option></select></div>
                            <div><label class="form-label">Fornecedor</label><input type="text" name="supplier" id="entry-supplier" required class="form-input" placeholder="Ex: Fornecedor X"></div>
                            <div><label class="form-label">Prazo Entrega (Dias)</label><input type="number" name="lead-time" id="entry-lead-time" min="0" class="form-input text-ios-blue" placeholder="Ex: 5"></div>
                            <div><label class="form-label">Estoque Mínimo (Alerta)</label><input type="number" name="min-stock" id="entry-min-stock" min="0" step="0.01" class="form-input text-ios-orange" placeholder="Opcional"></div>
                            <div><label class="form-label">Quantidade FÍSICA</label><input type="number" name="quantity" id="entry-quantity" required min="0.01" step="0.01" class="form-input text-ios-blue font-bold"></div>
                            <div><label class="form-label">Data de Recebimento</label><input type="date" id="receipt-date" required class="form-input"></div>
                            <div><label class="form-label">Data de Fabricação</label><input type="date" id="mfg-date" class="form-input"></div>
                            <div><label class="form-label">Data de Validade</label><input type="date" id="expiry-date" class="form-input"></div>
                        </div>
                        <div class="mt-8 flex justify-end"><button type="submit" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i>Registrar Entrada</button></div>
                    </form>
                </div>
            </div>

            <!-- Estoque -->
            <div id="screen-inventory" class="screen-panel hidden">
                <h1 class="title-lg">Estoque Atual</h1>
                <div class="card p-0 overflow-hidden border-none bg-transparent">
                    <div class="flex flex-wrap gap-3 mb-5 p-1">
                        <input type="text" id="search-inventory" placeholder="Pesquisar itens..." class="form-input w-full md:w-64">
                        <select id="type-filter" class="form-input w-auto"><option value="">Todos Tipos</option><option value="insumo">Insumos</option><option value="semi_acabado">Semi-acabados</option></select>
                        <select id="supplier-filter" class="form-input w-auto"><option value="">Fornecedores</option></select>
                        <button id="btn-export-excel" class="btn-secondary ml-auto"><i class="fa-solid fa-arrow-up-from-bracket mr-2"></i>Exportar</button>
                    </div>
                    <div class="table-container">
                        <table class="base-table"><thead class="base-thead"><tr>
                            <th class="base-th table-header-sortable" data-sort="name">Produto <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                            <th class="base-th">Tipo</th>
                            <th class="base-th table-header-sortable" data-sort="supplier">Fornecedor <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                            <th class="base-th text-right table-header-sortable" data-sort="totalQuantity">Saldo Consolidado <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                            <th class="base-th table-header-sortable" data-sort="expiry">Próx. Validade <i class="fa-solid fa-sort ml-1 text-ios-textMuted"></i></th>
                        </tr></thead><tbody id="inventory-table-body"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- Receitas -->
            <div id="screen-recipes" class="screen-panel hidden">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h1 class="title-lg mb-0">Fichas Técnicas / Receitas</h1>
                    <div class="flex gap-3">
                        <input type="text" id="search-recipe" placeholder="Buscar receita..." class="form-input w-64">
                        <button id="btn-export-recipe-book" class="btn-secondary"><i class="fa-solid fa-file-pdf mr-2"></i>Livro PDF</button>
                        
                        <button id="btn-import-recipe-image" class="btn-secondary text-ios-blue border-ios-blue/50 hover:bg-ios-blue/10"><i class="fa-solid fa-camera mr-2"></i>Ler Foto</button>
                        <input type="file" id="recipe-image-input" class="hidden" accept="image/*">

                        <button id="btn-import-recipes" class="btn-secondary text-ios-green border-ios-green/50 hover:bg-ios-green/10"><i class="fa-solid fa-file-excel mr-2"></i>Importar Excel</button>
                        <input type="file" id="recipe-file-input" class="hidden" accept=".xlsx, .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                        <button id="btn-new-recipe" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i>Criar Receita</button>
                    </div>
                </div>
                <div class="flex flex-col xl:flex-row gap-6">
                    <div class="w-full xl:w-1/4 card self-start"><h2 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Linhas de Produção</h2><ul id="recipe-categories-list" class="space-y-1"></ul></div>
                    <div id="recipes-grid" class="w-full xl:w-3/4 grid grid-cols-1 md:grid-cols-2 gap-5 self-start"></div>
                </div>
            </div>

            <!-- Separação (Picking) -->
            <div id="screen-picking" class="screen-panel hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="title-lg mb-0 text-ios-orange"><i class="fa-solid fa-dolly mr-3"></i>Separação (Kitting por Linha)</h1>
                        <p class="text-ios-textMuted mt-1 text-sm">Organize as matérias-primas por setor. Cronômetros independentes.</p>
                    </div>
                </div>
                <div id="picking-lines-container" class="space-y-6"></div>
            </div>

            <!-- Produção (OP) -->
            <div id="screen-production" class="screen-panel hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="title-lg mb-0">Ordens de Produção (OP)</h1>
                    <div class="flex gap-3">
                        <button id="btn-confirm-production" class="btn-success"><i class="fa-solid fa-check-double mr-2"></i>Efetivar OPs</button>
                        <button id="btn-new-production-order" class="btn-primary"><i class="fa-solid fa-plus mr-2"></i>Nova OP</button>
                    </div>
                </div>
                <div class="card mb-5 flex flex-wrap gap-4 items-center border-l-4 border-l-ios-blue">
                    <label class="text-sm font-medium text-ios-textMuted"><i class="fa-solid fa-filter mr-2"></i>Filtrar Programação:</label>
                    <input type="date" id="search-po-by-date" class="form-input w-auto py-2">
                    <button id="btn-clear-po-date" class="text-xs text-ios-blue underline px-2 py-1">Mostrar Todas</button>
                </div>
                <div id="production-orders-list" class="grid grid-cols-1 xl:grid-cols-2 gap-5"></div>
            </div>

            <!-- Consumo Mensal -->
            <div id="screen-consumption" class="screen-panel hidden">
                <h1 class="title-lg">Relatório de Consumo</h1>
                <div class="card p-0 bg-transparent border-none">
                    <div class="flex gap-3 mb-5">
                        <select id="consumption-month-filter" class="form-input w-auto py-2"></select>
                        <select id="consumption-year-filter" class="form-input w-auto py-2"></select>
                        <input type="text" id="search-consumption" placeholder="Buscar produto..." class="form-input flex-1 py-2">
                    </div>
                    <div class="table-container"><table class="base-table"><thead class="base-thead"><tr><th class="base-th">Produto</th><th class="base-th text-right">Volume Consumido</th></tr></thead><tbody id="consumption-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- Requisições -->
            <div id="screen-requisitions" class="screen-panel hidden">
                <h1 class="title-lg">Baixa Avulsa (Requisição)</h1>
                <div class="card max-w-4xl mx-auto">
                    <div class="bg-ios-orange/10 border border-ios-orange/30 rounded-xl p-4 mb-6"><p class="text-sm text-ios-orange font-medium"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Atenção: O sistema bloqueará a requisição se não houver saldo físico suficiente nos lotes ou se os lotes estiverem bloqueados em quarentena.</p></div>
                    <form id="requisition-form">
                        <div class="grid grid-cols-2 gap-5 mb-6">
                            <div><label class="form-label">Destino / Motivo</label><input type="text" id="requisition-reason" required class="form-input" placeholder="Ex: Quebra, Teste, Refeição"></div>
                            <div><label class="form-label">Solicitante</label><input type="text" id="requisition-responsible" required class="form-input" placeholder="Nome"></div>
                        </div>
                        <div class="border-t border-ios-border pt-4">
                            <h3 class="title-md text-sm uppercase text-ios-textMuted mb-4">Itens da Requisição</h3>
                            <div id="requisition-items-container" class="space-y-3 mb-5"></div>
                            <button type="button" id="add-requisition-item-btn" class="text-ios-blue hover:text-blue-400 font-medium text-sm flex items-center"><i class="fa-solid fa-circle-plus mr-2 text-lg"></i>Adicionar Insumo</button>
                        </div>
                        <div class="mt-8 flex justify-end"><button type="submit" class="btn-primary">Confirmar Saída Avulsa</button></div>
                    </form>
                </div>
            </div>

            <!-- Ajustes Lote -->
            <div id="screen-adjustments" class="screen-panel hidden">
                <h1 class="title-lg">Ajuste Manual de Lote</h1>
                <div class="card max-w-2xl mx-auto">
                    <form id="adjustment-form" class="space-y-5">
                        <div class="z-50 relative"><label class="form-label">Buscar Produto</label><div id="adjustment-searchable-container" class="searchable-container"></div></div>
                        <div><label class="form-label">Selecionar Lote Físico</label><select id="adjustment-batch" required class="form-input"><option value="">Aguardando produto...</option></select></div>
                        <div><label class="form-label">Nova Quantidade Real (Física)</label><input type="number" id="adjustment-new-quantity" required min="0" step="0.01" class="form-input text-lg font-bold text-ios-blue"></div>
                        <div><label class="form-label">Motivo do Ajuste</label><input type="text" id="adjustment-reason" required class="form-input" placeholder="Ex: Recontagem de inventário"></div>
                        <div><label class="form-label">Responsável</label><input type="text" id="adjustment-responsible" required class="form-input"></div>
                        <div class="mt-8 flex justify-end"><button type="submit" class="btn-primary">Registrar Ajuste</button></div>
                    </form>
                </div>
            </div>

            <!-- Configurações -->
            <div id="screen-settings" class="screen-panel hidden">
                <h1 class="title-lg">Ajustes do Aplicativo</h1>
                <div class="card max-w-2xl mx-auto space-y-8 divide-y divide-ios-border">
                    <div class="pt-2">
                        <h2 class="title-md mb-1"><i class="fa-solid fa-cloud-arrow-down mr-2 text-ios-blue"></i>Exportar Backup</h2>
                        <p class="text-sm text-ios-textMuted mb-4">Gera um arquivo seguro (.json) contendo toda a base de dados.</p>
                        <button id="btn-download-backup" class="w-full btn-secondary text-ios-blue border-ios-blue/30 bg-ios-blue/10">Baixar Cópia do Banco</button>
                    </div>
                    <div class="pt-8">
                        <h2 class="title-md mb-1"><i class="fa-solid fa-file-excel mr-2 text-ios-green"></i>Importar Planilha (Entrada em Massa)</h2>
                        <p class="text-sm text-ios-textMuted mb-3">Faça o upload do seu relatório de estoque (<b>.csv</b> ou <b>.xlsx</b>).</p>
                        <button id="btn-upload-backup" class="w-full btn-secondary text-ios-green border-ios-green/30 bg-ios-green/10"><i class="fa-solid fa-file-import mr-2"></i>Selecionar Arquivo</button>
                        <input type="file" id="backup-file-input" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                    </div>
                    <div class="pt-8">
                        <h2 class="title-md text-ios-red mb-1"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Zona de Perigo</h2>
                        <button id="btn-reset-database" class="w-full btn-danger bg-ios-red/20 text-ios-red border border-ios-red border-opacity-50 hover:bg-ios-red hover:text-white">Zerar Sistema Completamente</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais de Cadastro e Gestão (Unificados para evitar bugs) -->
    
    <div id="manage-locations-modal" class="modal z-[70]"><div class="modal-content max-w-2xl max-h-[90vh] flex flex-col p-0 bg-ios-bg border border-ios-border"><div class="flex justify-between items-center p-6 border-b border-ios-border bg-ios-cardHover"><h2 class="title-md mb-0 text-white"><i class="fa-solid fa-list-ul mr-2 text-ios-blue"></i>Gerenciar Locais</h2><button class="text-ios-textMuted hover:text-white text-3xl close-modal leading-none" data-target="manage-locations-modal">&times;</button></div><div class="p-6 overflow-y-auto"><div class="table-container"><table class="base-table w-full"><thead class="base-thead"><tr><th class="base-th">Código</th><th class="base-th">Nome de Exibição (Rua)</th><th class="base-th text-center">Ações</th></tr></thead><tbody id="locations-table-body" class="divide-y divide-ios-border"></tbody></table></div></div></div></div>
    
    <div id="edit-location-modal" class="modal z-[80]"><div class="modal-content max-w-sm bg-ios-card border border-ios-border"><h2 class="title-md mb-4 text-white">Editar Local</h2><form id="edit-location-form" class="space-y-4"><input type="hidden" id="edit-loc-id"><input type="hidden" id="edit-loc-old-name"><div><label class="form-label">Código Lido (QR/Barras)</label><input type="text" id="edit-loc-code" required class="form-input bg-ios-bg border-ios-border text-ios-textMuted" readonly></div><div><label class="form-label">Nome do Local</label><input type="text" id="edit-loc-name" required class="form-input uppercase bg-ios-bg border-ios-blue text-white font-bold" placeholder="Digite o nome..."></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="edit-location-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar Edição</button></div></form></div></div>
    
    <div id="register-location-modal" class="modal z-[80]"><div class="modal-content max-w-sm bg-ios-card border border-ios-border"><h2 class="title-md mb-4 text-white">Cadastrar Novo Local</h2><form id="register-location-form" class="space-y-4"><p class="text-sm text-ios-textMuted mb-4">O código escaneado não existe. Dê um nome para esta Rua/Prateleira.</p><div><label class="form-label">Código Lido</label><input type="text" id="loc-code" class="form-input bg-ios-bg border-ios-border text-ios-textMuted" readonly></div><div><label class="form-label">Nome do Local (Ex: Prateleira 10)</label><input type="text" id="loc-name" required class="form-input uppercase bg-ios-bg border-ios-blue text-white font-bold" placeholder="Digite o nome do local..."></div><div class="flex justify-end gap-2 mt-4"><button type="button" class="btn-secondary close-modal" data-target="register-location-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar Local</button></div></form></div></div>

    <div id="recipe-modal" class="modal z-[60]"><div class="modal-content max-w-2xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h2 id="recipe-modal-title" class="title-md mb-0">Nova Receita</h2><button class="text-ios-textMuted hover:text-white text-2xl close-modal" data-target="recipe-modal">&times;</button></div><form id="recipe-form" class="space-y-5"><input type="hidden" id="edit-recipe-id"><div><label class="form-label">Nome da Ficha Técnica / Receita</label><input type="text" id="recipe-name" required class="form-input font-semibold text-lg" placeholder="Ex: Massa de Coxinha ou Bolo de Cenoura"></div><div><label class="form-label">Linha Produtiva</label><input type="text" id="recipe-category" list="category-options" required class="form-input" placeholder="Selecione ou digite..."><datalist id="category-options"><option value="Salgados"></option><option value="Pães"></option><option value="Confeitaria"></option><option value="Bases"></option></datalist></div><div class="p-5 bg-ios-blue/10 border border-ios-blue/30 rounded-xl"><label class="flex items-center space-x-3 cursor-pointer mb-2"><input type="checkbox" id="recipe-is-semi" class="ui-checkbox"><span class="text-sm font-semibold text-white ml-1">Esta receita gera um produto Semi-Acabado</span></label><div id="yield-wrapper" class="hidden pt-4 border-t border-ios-blue/20"><label class="form-label text-ios-blue font-bold">Rendimento (Qtd FÍSICA que entra no estoque)</label><input type="number" id="recipe-yield" min="0.001" step="0.001" value="1" class="form-input text-ios-blue font-bold text-lg" placeholder="Ex: 2.5"></div></div><div class="pt-2"><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Composição (Ingredientes)</h3><div id="ingredients-container" class="space-y-3 mb-4"></div><button type="button" id="add-ingredient-btn" class="text-ios-blue font-medium text-sm flex items-center"><i class="fa-solid fa-circle-plus mr-1"></i>Adicionar Ingrediente</button></div><div class="mt-6 flex justify-end"><button type="submit" class="btn-primary" id="save-recipe-btn">Salvar Ficha Técnica</button></div></form></div></div>
    
    <div id="production-order-modal" class="modal z-[60]"><div class="modal-content max-w-5xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h2 id="production-order-modal-title" class="title-md mb-0">Gerar Ordem de Produção (OP)</h2><button class="text-ios-textMuted hover:text-white text-2xl close-modal" data-target="production-order-modal">&times;</button></div><form id="production-order-form"><input type="hidden" id="edit-po-id"><div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-ios-bg border border-ios-border p-5 rounded-2xl mb-6 shadow-inner items-start relative z-50"><div class="md:col-span-2 relative"><label class="form-label">Receita / Produto a Fabricar</label><div id="po-recipe-searchable-container" class="searchable-container"></div></div><div><label class="form-label">Multiplicador</label><input type="number" id="po-quantity" value="1" min="0.01" step="0.01" required class="form-input text-ios-blue font-bold text-lg"></div><div class="md:col-span-1 mt-2"><label class="form-label">Data Agendada</label><input type="date" id="po-date" required class="form-input"></div><div class="md:col-span-4 mt-2"><label class="flex items-center gap-3 cursor-pointer bg-ios-orange/10 p-3 rounded-xl border border-ios-orange/30 w-max hover:bg-ios-orange/20 transition-colors"><input type="checkbox" id="po-is-extra" class="ui-checkbox"><span class="text-sm font-bold text-ios-orange ml-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> OP Extra / Urgente</span></label></div><div id="po-output-fields" class="col-span-1 md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 pt-4 border-t border-ios-border hidden"><div><label class="form-label">Total Gerado</label><input type="text" id="po-total-output" readonly class="form-input bg-gray-800 text-ios-green font-bold text-lg border-none" value="0.0000"></div><div><label class="form-label">Lote Sugerido</label><input type="text" id="po-output-batch" class="form-input"></div><div><label class="form-label">Validade Gerado</label><input type="date" id="po-output-expiry" class="form-input"></div></div></div><h3 class="title-md text-sm uppercase text-ios-textMuted mb-3">Previsão de Consumo</h3><div class="table-container mb-6"><table class="base-table"><thead class="base-thead"><tr><th class="base-th">Insumo</th><th class="base-th">Estoque Atual</th><th class="base-th">Qtd a Descontar</th><th class="base-th">Lotes Reservados</th></tr></thead><tbody id="po-ingredients-body"></tbody></table></div><div class="flex justify-end"><button type="submit" class="btn-primary">Salvar OP na Fila</button></div></form></div></div>

    <div id="item-details-modal" class="modal z-[60]"><div class="modal-content max-w-5xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-start mb-6"><div><h2 class="title-md flex items-center mb-1 text-2xl tracking-tight"><span id="details-product-name"></span></h2><span id="details-product-type-badge" class="badge bg-ios-cardHover text-ios-textMuted border border-ios-border"></span></div><div class="flex items-center gap-3"><button id="btn-edit-item" class="text-ios-blue bg-ios-blue/10 p-3 rounded-full hover:bg-ios-blue/20 transition-colors"><i class="fa-solid fa-pen"></i></button><button id="btn-delete-item" class="text-ios-red bg-ios-red/10 p-3 rounded-full hover:bg-ios-red/20 transition-colors"><i class="fa-solid fa-trash"></i></button><button class="text-ios-textMuted hover:text-white text-3xl ml-2 close-modal" data-target="item-details-modal">&times;</button></div></div><div id="item-details-view" class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm bg-ios-bg p-5 rounded-2xl mb-6 shadow-inner border border-ios-border"><div><span class="text-ios-textMuted block mb-1">Cód Padrão</span><span id="details-product-code" class="text-white font-medium font-mono"></span></div><div><span class="text-ios-textMuted block mb-1">Cód Leitor</span><span id="details-product-barcode" class="text-white font-medium font-mono"></span></div><div class="md:col-span-2"><span class="text-ios-textMuted block mb-1">Fornecedor</span><span id="details-supplier" class="text-white font-medium"></span></div><div><span class="text-ios-textMuted block mb-1">Estoque Mín.</span><span id="details-min-stock" class="text-ios-orange font-medium"></span></div><div><span class="text-ios-textMuted block mb-1">Saldo Físico</span><span id="details-total-quantity" class="text-ios-green font-bold text-xl"></span></div></div><div id="item-details-edit" class="hidden mb-6 bg-ios-bg p-5 rounded-2xl border border-ios-border shadow-inner"><form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-5"><input type="hidden" id="edit-item-id"><div class="md:col-span-6"><label class="form-label">Classificação</label><select id="edit-product-type" required class="form-input"><option value="insumo">Insumo</option><option value="semi_acabado">Semi-acabado</option></select></div><div class="md:col-span-6"><label class="form-label">Nome</label><input type="text" id="edit-product-name" required class="form-input"></div><div class="md:col-span-3"><label class="form-label">Cód. Interno</label><input type="text" id="edit-product-code" class="form-input"></div><div class="md:col-span-3"><label class="form-label">Cód. Barras</label><input type="text" id="edit-product-barcode" class="form-input text-ios-green"></div><div class="md:col-span-3"><label class="form-label">Fornecedor</label><input type="text" id="edit-supplier" class="form-input"></div><div class="md:col-span-1"><label class="form-label">Prazo (Dias)</label><input type="number" id="edit-lead-time" min="0" class="form-input"></div><div class="md:col-span-2 relative border border-ios-border p-3 rounded-xl bg-ios-cardHover"><div class="flex gap-2 mb-2 items-end"><div class="flex-1"><label class="text-[10px] text-ios-textMuted uppercase mb-1 block">Margem Seg. (Dias)</label><input type="number" id="edit-safety-margin" min="0" class="form-input py-1 px-2 text-sm" value="2"></div><button type="button" id="btn-calc-min-stock" class="text-ios-blue text-[10px] bg-ios-blue/10 px-2 py-1 rounded hover:bg-ios-blue/20 transition-colors h-8"><i class="fa-solid fa-calculator mr-1"></i>Sugerir</button></div><label class="text-xs text-ios-orange font-bold mb-1 block">Estoque Mínimo</label><input type="number" step="0.01" id="edit-min-stock" class="form-input text-ios-orange font-bold"></div><div class="md:col-span-6 flex justify-end gap-3 mt-2"><button type="button" id="btn-cancel-edit" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Salvar Edição</button></div></form></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3">Lotes Físicos na Prateleira</h3><div class="table-container mb-8 max-h-96 overflow-y-auto"><table class="base-table"><thead class="base-thead"><tr><th class="base-th">Lote</th><th class="base-th">Local (Rua)</th><th class="base-th">Status</th><th class="base-th">Volume</th><th class="base-th text-center">Gestão</th></tr></thead><tbody id="details-batches-table"></tbody></table></div></div><div><h3 class="text-sm font-semibold text-ios-textMuted uppercase mb-3 flex justify-between items-center">Extrato de Movimentação <button id="btn-clear-hist-filters" class="text-xs text-ios-blue hover:text-blue-300 font-normal underline hidden">Limpar Filtros</button></h3><div class="flex flex-wrap gap-2 mb-3 bg-ios-bg p-3 rounded-xl border border-ios-border shadow-inner"><input type="date" id="hist-filter-start" class="form-input py-1 px-2 text-xs w-auto border-ios-border"><span class="text-ios-textMuted flex items-center text-xs">até</span><input type="date" id="hist-filter-end" class="form-input py-1 px-2 text-xs w-auto border-ios-border"><select id="hist-filter-type" class="form-input py-1 px-2 text-xs w-auto border-ios-border ml-auto"><option value="">Todas</option><option value="entrada">Entradas</option><option value="saída">Saídas</option><option value="requisição">Requisição</option><option value="ajuste">Ajustes</option></select></div><div class="table-container max-h-72 overflow-y-auto bg-ios-bg p-2" id="details-history-container"></div></div></div></div></div>

    <div id="edit-batch-modal" class="modal z-[70]"><div class="modal-content max-w-sm"><h2 class="title-md mb-4">Editar Lote</h2><form id="edit-batch-form" class="space-y-4"><input type="hidden" id="edit-batch-id"><input type="hidden" id="edit-batch-product-id"><div><label class="form-label">Código do Lote</label><input type="text" id="edit-batch-code" required class="form-input bg-ios-bg border-ios-border"></div><div><label class="form-label">Local (Rua/Endereço)</label><input type="text" id="edit-batch-location" class="form-input uppercase bg-ios-bg border-ios-border"></div><div><label class="form-label">Quantidade</label><input type="number" step="0.001" id="edit-batch-qty" required class="form-input text-ios-blue font-bold bg-ios-bg border-ios-border"></div><div><label class="form-label">Validade</label><input type="date" id="edit-batch-expiry" class="form-input bg-ios-bg border-ios-border"></div><div class="flex justify-end gap-2 mt-2"><button type="button" class="btn-secondary close-modal" data-target="edit-batch-modal">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form></div></div>

    <div id="batch-selector-modal" class="modal z-[70]"><div class="modal-content max-w-xl"><h2 id="batch-selector-title" class="title-md mb-4">Descontar de quais lotes?</h2><div class="bg-ios-bg border border-ios-border p-4 rounded-xl flex justify-between mb-5 items-center"><span class="text-ios-textMuted text-sm">Alvo: <span id="batch-selector-needed" class="text-white font-semibold"></span></span><span class="text-ios-textMuted text-sm">Marcado: <span id="batch-selector-selected" class="font-bold text-lg text-ios-blue"></span></span></div><div id="batch-selector-list" class="max-h-64 overflow-y-auto mb-6 pr-2 space-y-2"></div><div class="flex justify-end gap-3"><button class="btn-secondary close-modal" data-target="batch-selector-modal">Cancelar</button><button id="confirm-batch-selection" class="btn-primary">Aplicar Seleção</button></div></div></div>

    <div id="confirm-action-modal" class="modal z-[9999]"><div class="modal-content max-w-md text-center flex flex-col items-center"><div class="w-16 h-16 rounded-full bg-ios-cardHover border border-ios-border flex items-center justify-center mb-5"><i class="fa-solid fa-circle-question text-3xl text-ios-blue"></i></div><h3 id="confirm-title" class="title-md mb-2"></h3><p id="confirm-message" class="text-ios-textMuted text-sm mb-8 leading-relaxed"></p><div class="flex gap-3 w-full justify-center"><button id="cancel-action-btn" class="btn-secondary flex-1">Cancelar</button><button id="confirm-action-btn" class="btn-primary flex-1">Sim, Continuar</button></div></div></div>

<script type="module">
    const id = n => document.getElementById(n);
    const show = el => { if(el) { el.style.display = 'flex'; el.classList.remove('hidden'); } };
    const hide = el => { if(el) { el.style.display = 'none'; el.classList.add('hidden'); } };
    const addEvt = (elId, evType, h) => { const el = id(elId); if(el) el.addEventListener(evType, h); };
    const capitalize = (str) => { if(!str) return ''; return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' '); };

    // --- FIREBASE IMPORTS E INIT ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "", authDomain: "estoque-b50df.firebaseapp.com", projectId: "estoque-b50df", storageBucket: "estoque-b50df.firebasestorage.app", messagingSenderId: "634756791567", appId: "1:634756791567:web:993e61243b57b7e057d27a" };

    let app, auth, provider, db;
    // Tenta inicializar Firebase, caso falhe (como em ambientes de preview com CORS), força LocalDB
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        provider = new GoogleAuthProvider();
        db = getFirestore(app);
    } catch(e) {
        console.warn("Firebase Init Failed - Forcing Offline Mode", e);
    }

    let isOfflineMode = false; // Começará como false, mas será mudado se o Firebase não responder

    const LocalDB = {
        data: { inventory: [], batches: [], history: [], recipes: [], productionOrders: [], monthlyConsumption: [], locations: [] },
        init() { const saved = localStorage.getItem('estoque_db'); if(saved) this.data = JSON.parse(saved); },
        save() { localStorage.setItem('estoque_db', JSON.stringify(this.data)); },
        async add(coll, item) { item.id = crypto.randomUUID(); if(!this.data[coll]) this.data[coll] = []; this.data[coll].push(item); this.save(); return item.id; },
        async update(coll, item) { if(!this.data[coll]) return; const idx = this.data[coll].findIndex(x => x.id == item.id); if(idx > -1) { this.data[coll][idx] = item; this.save(); } },
        async remove(coll, id) { if(!this.data[coll]) return; this.data[coll] = this.data[coll].filter(x => x.id != id); this.save(); },
        async get(coll, id) { return (this.data[coll] || []).find(x => x.id == id); },
        async getAll(coll) { return [...(this.data[coll] || [])]; },
        async getByIndex(coll, idx, val) { return (this.data[coll] || []).find(x => x[idx] == val); },
        async clear(coll) { this.data[coll] = []; this.save(); },
        async restoreBackup(newData) { this.data = {...this.data, ...newData}; this.save(); }
    };

    const FirebaseDB = {
        async add(coll, data) { const ref = await addDoc(collection(db, coll), data); await setDoc(ref, { id: ref.id }, { merge: true }); return ref.id; },
        async update(coll, data) { if(!data.id) return; await setDoc(doc(db, coll, String(data.id)), data, { merge: true }); },
        async remove(coll, idStr) { if(!idStr) return; await deleteDoc(doc(db, coll, String(idStr))); },
        async get(coll, idStr) { if(!idStr) return null; const d = await getDoc(doc(db, coll, String(idStr))); return d.exists() ? d.data() : null; },
        async getAll(coll) { const qs = await getDocs(collection(db, coll)); return qs.docs.map(d => d.data()); },
        async getByIndex(coll, idx, val) { const q = query(collection(db, coll), where(idx, "==", val)); const qs = await getDocs(q); return qs.empty ? null : qs.docs[0].data(); },
        async clear(coll) { const qs = await getDocs(collection(db, coll)); const batch = writeBatch(db); qs.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); },
        async restoreBackup(data) {
            for (const s of ['inventory', 'batches', 'history', 'recipes', 'productionOrders', 'monthlyConsumption', 'locations']) {
                const qs = await getDocs(collection(db, s)); for (const d of qs.docs) { await deleteDoc(d.ref); } 
                if (data[s] && Array.isArray(data[s])) {
                    for (const item of data[s]) { const idStr = item.id ? String(item.id) : null; if (idStr) { await setDoc(doc(db, s, idStr), item); } else { const ref = await addDoc(collection(db, s), item); await setDoc(ref, { id: ref.id }, { merge: true }); } }
                }
            }
        }
    };

    const DB = {
        async add(c, d) { return isOfflineMode ? await LocalDB.add(c, d) : await FirebaseDB.add(c, d); },
        async update(c, d) { return isOfflineMode ? await LocalDB.update(c, d) : await FirebaseDB.update(c, d); },
        async remove(c, i) { return isOfflineMode ? await LocalDB.remove(c, i) : await FirebaseDB.remove(c, i); },
        async get(c, i) { return isOfflineMode ? await LocalDB.get(c, i) : await FirebaseDB.get(c, i); },
        async getAll(c) { return isOfflineMode ? await LocalDB.getAll(c) : await FirebaseDB.getAll(c); },
        async getByIndex(c, idx, v) { return isOfflineMode ? await LocalDB.getByIndex(c, idx, v) : await FirebaseDB.getByIndex(c, idx, v); },
        async clear(c) { return isOfflineMode ? await LocalDB.clear(c) : await FirebaseDB.clear(c); },
        async restoreBackup(d) { return isOfflineMode ? await LocalDB.restoreBackup(d) : await FirebaseDB.restoreBackup(d); }
    };

    // --- FUNÇÕES DE UI GLOBALS ---
    window.showNotif = function(msg, isErr=false) {
        const nf = id('notification-modal'); if(!nf) return;
        nf.innerHTML = `<i class="fa-solid ${isErr?'fa-triangle-exclamation':'fa-check-circle'} mr-2"></i> ${msg}`;
        nf.className = `fixed top-6 left-1/2 transform -translate-x-1/2 z-[2000] py-3 px-6 rounded-full shadow-2xl font-semibold text-white transition-all text-sm backdrop-blur-md ${isErr?'bg-ios-red':'bg-ios-green'}`;
        show(nf); setTimeout(() => hide(nf), 3000);
    }

    window.showConfirmationModal = function(title, msg, onConfirm) {
        if(id('confirm-title')) id('confirm-title').innerHTML = title;
        if(id('confirm-message')) id('confirm-message').innerHTML = msg;
        show(id('confirm-action-modal'));
        const btnOk = id('confirm-action-btn'); const btnCancel = id('cancel-action-btn');
        const newBtnOk = btnOk.cloneNode(true); const newBtnCancel = btnCancel.cloneNode(true);
        btnOk.parentNode.replaceChild(newBtnOk, btnOk); btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);
        newBtnOk.addEventListener('click', () => { hide(id('confirm-action-modal')); onConfirm(); });
        newBtnCancel.addEventListener('click', () => { hide(id('confirm-action-modal')); });
    }

    let qrCodeInstance = null;
    window.toggleCamera = async function(readerId, inputId) {
        const readerEl = id(readerId); const inputEl = id(inputId);
        if(typeof Html5Qrcode === 'undefined') return window.showNotif("Biblioteca da câmera não carregada.", true);
        if (qrCodeInstance) { try { await qrCodeInstance.stop(); } catch(e) {} qrCodeInstance = null; hide(readerEl); return; }
        show(readerEl); qrCodeInstance = new Html5Qrcode(readerId);
        try {
            await qrCodeInstance.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
            async (decodedText) => {
                try { await qrCodeInstance.stop(); } catch(e) {}
                qrCodeInstance = null; hide(readerEl);
                if(inputEl) {
                    inputEl.value = decodedText;
                    inputEl.dispatchEvent(new Event('input', { bubbles: true }));
                    inputEl.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', keyCode: 13, which: 13, bubbles: true }));
                }
            }, (err) => { });
        } catch(e) { window.showNotif('Erro ao acessar a câmera.', true); hide(readerEl); }
    }

    // --- CADASTRO DE LOCAIS ---
    addEvt('btn-manage-locations', 'click', () => { renderLocationsManager(); show(id('manage-locations-modal')); });
    function renderLocationsManager() {
        const tbody = id('locations-table-body');
        if(!localLocations || !localLocations.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-ios-textMuted">Nenhum local cadastrado.</td></tr>'; return; }
        tbody.innerHTML = localLocations.map(l => `
            <tr class="base-tr hover:bg-ios-card/50"><td class="base-td font-mono text-xs text-ios-textMuted">${l.code || '-'}</td><td class="base-td font-bold text-white">${l.name}</td><td class="base-td text-center"><button class="text-ios-blue hover:text-blue-400 p-2 edit-loc-btn bg-ios-bg rounded-lg border border-ios-border mr-1" data-id="${l.id}"><i class="fa-solid fa-pen"></i></button><button class="text-ios-red hover:text-red-400 p-2 del-loc-btn bg-ios-bg rounded-lg border border-ios-border" data-id="${l.id}"><i class="fa-solid fa-trash"></i></button></td></tr>
        `).join('');
    }

    addEvt('locations-table-body', 'click', async e => {
        const delBtn = e.target.closest('.del-loc-btn');
        if(delBtn) { window.showConfirmationModal('Excluir Local?', 'Tem certeza que deseja apagar este local do sistema?', async () => { show(id('loading-overlay')); await DB.remove('locations', delBtn.dataset.id); await refreshData(); renderLocationsManager(); hide(id('loading-overlay')); window.showNotif('Local apagado'); }); }
        const editBtn = e.target.closest('.edit-loc-btn');
        if(editBtn) {
            const loc = localLocations.find(l => l.id == editBtn.dataset.id);
            if(loc) { id('edit-loc-id').value = loc.id; id('edit-loc-code').value = loc.code; id('edit-loc-name').value = loc.name; id('edit-loc-old-name').value = loc.name; show(id('edit-location-modal')); }
        }
    });

    addEvt('edit-location-form', 'submit', async e => {
        e.preventDefault(); show(id('loading-overlay'));
        try {
            const lId = id('edit-loc-id').value; const newCode = id('edit-loc-code').value.trim(); const newName = id('edit-loc-name').value.trim().toUpperCase(); const oldName = id('edit-loc-old-name').value;
            const loc = await DB.get('locations', lId);
            if(loc) {
                loc.code = newCode; loc.name = newName; await DB.update('locations', loc);
                if(oldName && oldName !== newName) { const affectedBatches = localBatches.filter(b => b.location === oldName); for(let b of affectedBatches) { b.location = newName; await DB.update('batches', b); } }
                await refreshData(); hide(id('edit-location-modal')); renderLocationsManager(); window.showNotif('Local atualizado com sucesso!');
            }
        } catch(err) { window.showNotif('Erro ao atualizar local.', true); } finally { hide(id('loading-overlay')); }
    });

    addEvt('register-location-form', 'submit', async e => {
        e.preventDefault(); show(id('loading-overlay'));
        try {
            const code = id('loc-code').value.trim(); const name = id('loc-name').value.trim().toUpperCase();
            await DB.add('locations', { code, name }); await refreshData(); hide(id('register-location-modal')); window.showNotif('Local cadastrado!');
            if(id('entry-location') && !id('screen-entry').classList.contains('hidden')) { id('entry-location').value = name; } 
            else if(id('address-input') && !id('screen-addressing').classList.contains('hidden')) { id('address-input').value = name; id('address-input').dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', keyCode: 13 })); }
        } catch(err) { window.showNotif('Erro ao cadastrar local', true); } finally { hide(id('loading-overlay')); }
    });

    addEvt('entry-location', 'keypress', e => {
        if(e.key === 'Enter') {
            e.preventDefault(); const val = e.target.value.trim().toUpperCase(); if(!val) return;
            const loc = localLocations.find(l => String(l.code).toUpperCase() === val || String(l.name).toUpperCase() === val);
            if(loc) { e.target.value = loc.name; window.showNotif('Local reconhecido: ' + loc.name); } 
            else { id('loc-code').value = val; id('loc-name').value = ''; show(id('register-location-modal')); }
        }
    });

    document.querySelectorAll('.nav-item').forEach(link => {
        link.addEventListener('click', async () => {
            if(qrCodeInstance) {
                try { await qrCodeInstance.stop(); } catch(e) {}
                qrCodeInstance = null;
                hide(id('main-camera-reader')); hide(id('entry-camera-reader')); hide(id('picking-camera-reader')); hide(id('entry-loc-camera-reader')); hide(id('address-camera-reader'));
            }
        });
    });

    addEvt('btn-start-camera-main', 'click', () => window.toggleCamera('main-camera-reader', 'scanner-input'));
    addEvt('btn-start-camera-entry', 'click', () => window.toggleCamera('entry-camera-reader', 'entry-product-code'));
    addEvt('btn-start-camera-picking', 'click', () => window.toggleCamera('picking-camera-reader', 'picking-scanner'));
    addEvt('btn-start-camera-entry-loc', 'click', () => window.toggleCamera('entry-loc-camera-reader', 'entry-location'));
    addEvt('btn-start-camera-address', 'click', () => window.toggleCamera('address-camera-reader', 'address-input'));

    // --- AUTENTICAÇÃO E INÍCIO ---
    async function startOfflineMode() {
        isOfflineMode = true; LocalDB.init(); 
        hide(id('login-wrapper')); show(id('app-wrapper'));
        const nu = id('nome-usuario'); if(nu) nu.innerText = 'Modo Local (Offline)';
        window.showNotif('Você está usando o banco de dados Local.', false);
        const t = new Date().toISOString().split('T')[0];
        if(id('receipt-date')) id('receipt-date').value = t; if(id('mfg-date')) id('mfg-date').value = t;
        window.navTo('dashboard'); 
        show(id('loading-overlay')); await refreshData(); hide(id('loading-overlay'));
    }

    addEvt('btn-login-google', 'click', () => {
        if(!auth) return window.showNotif("Módulo de autenticação offline.", true);
        const msg = id('mensagem-erro'); if(msg) { msg.innerText = "Abrindo pop-up..."; show(msg); }
        signInWithPopup(auth, provider).catch((error) => {
            if(msg) {
                if (error.code === 'auth/unauthorized-domain') { msg.innerHTML = "<b>Domínio não autorizado.</b> Use Modo Offline."; } 
                else { msg.innerText = "Erro: " + error.message; }
                show(msg);
            }
        });
    });

    addEvt('btn-bypass-login', 'click', startOfflineMode);

    addEvt('btn-sair', 'click', () => {
        if(isOfflineMode || !auth) { location.reload(); }
        else { signOut(auth).then(() => location.reload()).catch(console.error); }
    });

    if(auth) {
        onAuthStateChanged(auth, async (user) => {
            if (user && !isOfflineMode) {
                hide(id('login-wrapper')); show(id('app-wrapper'));
                const nu = id('nome-usuario'); if(nu) nu.innerText = user.displayName || 'Estoquista';
                show(id('loading-overlay'));
                const t = new Date().toISOString().split('T')[0];
                if(id('receipt-date')) id('receipt-date').value = t; if(id('mfg-date')) id('mfg-date').value = t;
                window.navTo('dashboard'); 
                try { 
                    await refreshData(); 
                } catch(e) { 
                    console.error("Falha ao carregar Firebase após login, caindo para Offline", e);
                    startOfflineMode();
                } 
                hide(id('loading-overlay'));
            } else if(!isOfflineMode) {
                show(id('login-wrapper')); hide(id('app-wrapper')); hide(id('loading-overlay'));
            }
        });
    } else {
        // Se falhou o init do firebase por completo, mostre a tela de login para forçar o clique em "offline"
        show(id('login-wrapper')); hide(id('app-wrapper')); hide(id('loading-overlay'));
    }

    // --- VARIÁVEIS GLOBAIS DE ESTADO E NAVEGAÇÃO ---
    let localInventory=[], localBatches=[], localHistory=[], localRecipes=[], localProductionOrders=[], localMonthlyConsumption=[], localLocations=[];
    let currentBatchTarget=null;
    let invSort = { col: 'name', asc: true };
    let currentHistoryProductId = null;
    let currentRecipeCategory = 'Todos';
    let activePickingLine = null, activePickingOpIds = [];
    const typeLabels = { insumo: 'Insumo', semi_acabado: 'Semi-acabado' };

    document.querySelectorAll('.close-modal').forEach(btn => { btn.addEventListener('click', () => { hide(id(btn.dataset.target)); }); });

    const screens = ['dashboard','addressing','scanner','entry','inventory','recipes','production','requisitions','adjustments','consumption','settings','picking'];
    
    // Função NAVTO Global
    window.navTo = function(target) {
        screens.forEach(s => { id('screen-'+s)?.classList.add('hidden'); });
        document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('bg-ios-card', 'text-white'); n.classList.add('text-ios-textMuted'); });
        const screenEl = id('screen-'+target); if(screenEl) screenEl.classList.remove('hidden', 'flex-col');
        if(target === 'scanner' || target === 'addressing') screenEl.classList.add('flex', 'flex-col');
        
        const activeLink = document.querySelector(`.nav-item[data-target="${target}"]`);
        if(activeLink) { activeLink.classList.remove('text-ios-textMuted'); activeLink.classList.add('bg-ios-card', 'text-white'); }
        
        if(target==='adjustments') { createSearchableSelect(id('adjustment-searchable-container'), localInventory, 'Buscar produto...', p => { const batchEl = id('adjustment-batch'); if(batchEl) batchEl.innerHTML = '<option value="">Selecione Lote...</option>' + localBatches.filter(b=>b.productId==p.id && b.quantity>0).map(b=>`<option value="${b.id}">${b.code}</option>`).join(''); }); }
        if(target==='requisitions') { const reqCont = id('requisition-items-container'); if (reqCont) { reqCont.innerHTML=''; window.addIngRowReq(reqCont); } }
        if(target==='picking') { window.renderPickingScreen(); }
        if(target==='scanner') { setTimeout(() => id('scanner-input')?.focus(), 100); }
        if(target==='addressing') { setTimeout(() => id('address-input')?.focus(), 100); }
    }
    
    document.querySelectorAll('.nav-item').forEach(link => { link.addEventListener('click', e => { e.preventDefault(); window.navTo(link.dataset.target); }); });

    function createSearchableSelect(container, items, placeholder, onSelect) {
        if(!container) return;
        container.innerHTML = `<div class="searchable-container"><input type="text" class="form-input bg-ios-input text-white border-ios-border w-full" placeholder="${placeholder}" autocomplete="off"><div class="searchable-dropdown hidden"></div></div>`;
        const input = container.querySelector('input'); const dropdown = container.querySelector('.searchable-dropdown');
        if(!input || !dropdown) return;
        
        const renderList = (searchTerm) => {
            let filtered = items;
            if(searchTerm) { const term = searchTerm.toLowerCase(); filtered = filtered.filter(i => (i.searchName || i.name).toLowerCase().includes(term) || (i.code && String(i.code).toLowerCase().includes(term)) || (i.barcode && String(i.barcode).includes(term))); }
            if(filtered.length) { dropdown.innerHTML = filtered.map(i => `<div class="searchable-item flex justify-between items-center" data-id="${i.id}"><span class="font-medium">${i.searchName || i.name}</span>${i.type ? `<span class="text-xs text-ios-textMuted bg-black/30 px-2 py-1 rounded">${typeLabels[i.type]||''}</span>` : ''}</div>`).join(''); dropdown.classList.remove('hidden'); } 
            else { dropdown.innerHTML = `<div class="p-3 text-ios-textMuted text-sm">Nenhum resultado...</div>`; dropdown.classList.remove('hidden'); }
        };
        input.addEventListener('focus', () => renderList(input.value)); input.addEventListener('input', () => renderList(input.value));
        dropdown.addEventListener('click', e => { const row = e.target.closest('.searchable-item'); if(row) { const item = items.find(i => i.id == row.dataset.id); input.value = item.searchName || item.name; input.dataset.selectedId = item.id; dropdown.classList.add('hidden'); if(onSelect) onSelect(item); } });
        document.addEventListener('click', e => { if(!container.contains(e.target)) dropdown.classList.add('hidden'); });
    }

    function getReservedQty(batchId, ignoreOpId = null) {
        let res = 0;
        localProductionOrders.forEach(op => {
            if (op.id == ignoreOpId) return;
            if (op.status === 'pendente' || op.status === 'em_andamento') {
                (op.ingredients || []).forEach(ing => {
                    (ing.consumptionPlan || []).forEach(pl => {
                        if (pl.batchId == batchId) res += Number(pl.quantity) || 0;
                    });
                });
            }
        });
        return res;
    }

    function getFIFOPlan(productId, qtyNeeded, currentOpId = null) {
        const batches = localBatches.filter(b => b.productId == productId && b.isReleased !== false).map(b => {
            const reserved = getReservedQty(b.id, currentOpId);
            const available = (Number(b.quantity) || 0) - reserved;
            return { ...b, available: available > 0 ? available : 0 };
        }).filter(b => b.available > 0).sort((a,b) => new Date(a.expiryDate || '9999-01-01') - new Date(b.expiryDate || '9999-01-01'));
        
        let remaining = qtyNeeded; let plan = [];
        for (let b of batches) { 
            if (remaining <= 0) break; 
            const take = Math.min(b.available, remaining); 
            plan.push({ batchId: b.id, batchCode: b.code, quantity: take }); 
            remaining -= take; 
        }
        return { plan, isSufficient: remaining <= 0.0001 };
    }

    async function refreshData() {
        try {
            // Fallback imediato se não for offline mas também DB for undefined
            if(!isOfflineMode && typeof db === 'undefined') {
                isOfflineMode = true; LocalDB.init();
            }

            const results = await Promise.allSettled([
                DB.getAll('inventory'), DB.getAll('batches'), DB.getAll('history'), 
                DB.getAll('recipes'), DB.getAll('productionOrders'), DB.getAll('monthlyConsumption'), DB.getAll('locations')
            ]);
            
            localInventory = results[0].status === 'fulfilled' ? results[0].value || [] : [];
            localBatches = results[1].status === 'fulfilled' ? results[1].value || [] : [];
            localHistory = results[2].status === 'fulfilled' ? results[2].value || [] : [];
            localRecipes = results[3].status === 'fulfilled' ? results[3].value || [] : [];
            localProductionOrders = results[4].status === 'fulfilled' ? results[4].value || [] : [];
            localMonthlyConsumption = results[5].status === 'fulfilled' ? results[5].value || [] : [];
            localLocations = results[6].status === 'fulfilled' ? results[6].value || [] : [];

            localInventory = localInventory.filter(Boolean); localBatches = localBatches.filter(Boolean);
            localRecipes = localRecipes.filter(Boolean); localProductionOrders = localProductionOrders.filter(Boolean);
            localLocations = localLocations.filter(Boolean);
            
            let inventoryUpdates = [];
            for(let i of localInventory) {
                if(!i || !i.id) continue;
                let changed = false;
                if(!i.type || i.type === 'acabado') { i.type = 'insumo'; changed = true; } 
                const batches = localBatches.filter(b => b && b.productId == i.id); 
                const batchSum = batches.reduce((sum, b) => sum + Math.max(0, Number(b.quantity) || 0), 0);
                if (Math.abs((Number(i.totalQuantity) || 0) - batchSum) > 0.001) { i.totalQuantity = batchSum; changed = true; }
                if(changed) inventoryUpdates.push(DB.update('inventory', i));
            }
            if(inventoryUpdates.length > 0) await Promise.allSettled(inventoryUpdates);

            renderAll();
        } catch(e) { 
            console.error("Erro Crítico ao ler DB:", e); 
            window.showNotif(`Erro na leitura do Banco. Verifique sua conexão.`, true); 
        }
    }

    function renderAll() {
        populateFilters(); renderInv(); renderRecipes(); window.renderPO(); renderHome(); window.renderConsum(); window.updateSidebarBadges();
        const scrPicking = id('screen-picking'); if(scrPicking && !scrPicking.classList.contains('hidden')) window.renderPickingScreen();
        if(currentHistoryProductId) renderItemDetailsHistory();
    }

    function populateFilters() {
        const curSup = id('supplier-filter')?.value; const suppliers = [...new Set(localInventory.map(i=>i.supplier))].filter(Boolean).sort();
        const sf = id('supplier-filter'); if(sf) { sf.innerHTML = '<option value="">Fornecedores</option>' + suppliers.map(s=>`<option value="${s}">${s}</option>`).join(''); sf.value = curSup; }
        const cy = id('consumption-year-filter')?.value || new Date().getFullYear().toString(); const cm = id('consumption-month-filter')?.value || (new Date().getMonth()+1).toString();
        const cYears = [...new Set(localMonthlyConsumption.map(c=>c.period.substring(0,4)))].filter(Boolean).sort((a,b)=>b-a); if(!cYears.includes(cy)) cYears.push(cy);
        const yf = id('consumption-year-filter'); if(yf) { yf.innerHTML = cYears.map(y=>`<option value="${y}">${y}</option>`).join(''); yf.value = cy; }
        const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const mf = id('consumption-month-filter'); if(mf) { mf.innerHTML = months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join(''); mf.value = cm; }
    }

    // --- HOME (MENU LEVE E CARDS) ---
    function renderHome() {
        const quarentaECincoDias = new Date(); quarentaECincoDias.setDate(quarentaECincoDias.getDate() + 45);
        const expiringBatches = localBatches.filter(b => Number(b.quantity) > 0 && b.expiryDate && new Date(b.expiryDate + 'T00:00:00') <= quarentaECincoDias);
        const lowStockItems = localInventory.filter(i => (Number(i.minStock) || 0) > 0 && (Number(i.totalQuantity) || 0) <= Number(i.minStock));

        if(id('home-count-expiring')) id('home-count-expiring').innerText = expiringBatches.length;
        if(id('home-count-low')) id('home-count-low').innerText = lowStockItems.length;

        const expList = id('home-expiring-list');
        if(expList) {
            if(expiringBatches.length > 0) {
                expList.innerHTML = expiringBatches.map(b => {
                    const p = localInventory.find(i => i.id == b.productId);
                    const diffDays = Math.ceil((new Date(b.expiryDate+'T00:00:00') - new Date()) / (1000 * 60 * 60 * 24));
                    let color = diffDays <= 7 ? 'text-ios-red' : 'text-ios-orange';
                    return `<li class="bg-ios-cardHover p-3 rounded-xl border-l-4 border-l-ios-red flex justify-between items-center cursor-pointer hover:bg-ios-border transition alert-item" data-id="${p?.id}">
                        <div><h4 class="font-bold text-white text-sm">${p?.name || '?'}</h4><p class="text-[10px] text-ios-textMuted font-mono">Lote: ${b.code} | Qtd: ${Number(b.quantity).toFixed(2)}</p></div>
                        <div class="text-right"><span class="font-bold ${color} text-sm">${diffDays} dias</span><br><span class="text-[10px] text-ios-textMuted">${new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR')}</span></div>
                    </li>`;
                }).join('');
            } else { expList.innerHTML = '<li class="text-center text-ios-textMuted py-4 text-sm"><i class="fa-solid fa-check-circle text-ios-green mr-2"></i>Nenhum vencimento próximo.</li>'; }
        }

        const lowList = id('home-low-stock-list');
        if(lowList) {
            if(lowStockItems.length > 0) {
                lowList.innerHTML = lowStockItems.map(item => `
                    <li class="bg-ios-cardHover p-3 rounded-xl border-l-4 border-l-ios-orange flex justify-between items-center cursor-pointer hover:bg-ios-border transition alert-item" data-id="${item.id}">
                        <div><h4 class="font-bold text-white text-sm">${item.name}</h4><p class="text-[10px] text-ios-textMuted">${item.supplier || '-'}</p></div>
                        <div class="text-right"><p class="font-mono"><span class="text-ios-orange font-bold text-sm">${(Number(item.totalQuantity) || 0).toFixed(2)}</span> <span class="text-ios-textMuted text-xs">/ ${Number(item.minStock).toFixed(2)}</span></p></div>
                    </li>`).join('');
            } else { lowList.innerHTML = '<li class="text-center text-ios-textMuted py-4 text-sm"><i class="fa-solid fa-check-circle text-ios-green mr-2"></i>Todos os itens acima do mínimo.</li>'; }
        }
    }

    addEvt('home-expiring-list', 'click', e => { const item = e.target.closest('.alert-item'); if (item) { window.navTo('inventory'); window.openDetails(item.dataset.id); } });
    addEvt('home-low-stock-list', 'click', e => { const item = e.target.closest('.alert-item'); if (item) { window.navTo('inventory'); window.openDetails(item.dataset.id); } });

    // --- ENDEREÇAMENTO ---
    addEvt('address-input', 'keypress', e => {
        if(e.key === 'Enter') {
            const code = e.target.value.trim().toUpperCase(); if(!code) return;
            let loc = localLocations.find(l => String(l.code).toUpperCase() === code || String(l.name).toUpperCase() === code);
            const locationName = loc ? loc.name.toUpperCase() : code;

            const box = id('address-result-box');
            const foundBatches = localBatches.filter(b => b.location && String(b.location).toUpperCase() === locationName && Number(b.quantity) > 0);
            
            if(foundBatches.length > 0 || loc) {
                id('address-res-name').innerText = locationName;
                id('address-res-count').innerText = `${foundBatches.length} Lote(s)`;
                
                const tbody = id('address-table-body');
                tbody.innerHTML = foundBatches.map(b => {
                    const p = localInventory.find(i => i.id == b.productId); const pName = p ? String(p.name) : 'Insumo Excluído';
                    const reserved = getReservedQty(b.id); const livre = Number(b.quantity) - reserved;
                    const expFormat = b.expiryDate ? new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR') : '-';
                    
                    return `
                    <tr class="base-tr hover:bg-ios-cardHover/50 transition">
                        <td class="base-td font-bold text-white">${pName}</td>
                        <td class="base-td font-mono text-xs text-ios-textMuted">${b.code}</td>
                        <td class="base-td">${expFormat}</td>
                        <td class="base-td text-right font-bold">${Number(b.quantity).toFixed(2)}</td>
                        <td class="base-td text-right font-bold text-ios-orange">${reserved > 0 ? reserved.toFixed(2) : '-'}</td>
                        <td class="base-td text-right font-bold text-ios-green">${livre > 0 ? livre.toFixed(2) : '0.00'}</td>
                    </tr>`;
                }).join('');
                
                show(box); setTimeout(() => box.classList.remove('opacity-0', 'translate-y-4'), 10);
            } else {
                hide(box); box.classList.add('opacity-0', 'translate-y-4');
                id('loc-code').value = code; id('loc-name').value = ''; show(id('register-location-modal'));
            }
            e.target.value = '';
        }
    });

    // --- LEITOR GERAL (ITEM / ASSOCIAÇÃO) ---
    let lastScannedCode = '';
    addEvt('scanner-input', 'keypress', e => {
        if(e.key === 'Enter') {
            const code = e.target.value.trim(); if(!code) return;
            lastScannedCode = code;
            const p = localInventory.find(i => i.barcode === code || String(i.code) === code);
            const boxResult = id('scanner-result-box'); const boxAssociate = id('scanner-associate-box');
            
            if(p) {
                hide(boxAssociate); boxAssociate.classList.add('opacity-0', 'translate-y-4');
                id('scan-res-name').innerText = String(p.name || 'N/A'); id('scan-res-code').innerText = p.code || 'N/D'; id('scan-res-barcode').innerText = p.barcode || 'N/D'; id('scan-res-type').innerText = typeLabels[p.type] || 'Insumo'; id('scan-res-stock').innerText = (Number(p.totalQuantity)||0).toFixed(2);
                
                const foundBatches = localBatches.filter(b => b.productId == p.id && Number(b.quantity) > 0);
                const tbody = id('scan-res-batches');
                tbody.innerHTML = foundBatches.map(b => {
                    const reserved = getReservedQty(b.id); const livre = Number(b.quantity) - reserved;
                    return `
                    <tr class="base-tr">
                        <td class="base-td font-mono text-xs text-ios-textMuted">${b.code}</td>
                        <td class="base-td font-bold text-white text-xs">${b.location || 'Sem Local'}</td>
                        <td class="base-td text-right font-bold text-ios-textMuted">${Number(b.quantity).toFixed(2)}</td>
                        <td class="base-td text-right font-bold text-ios-green">${livre > 0 ? livre.toFixed(2) : '0.00'}</td>
                    </tr>`;
                }).join('');
                if(!foundBatches.length) tbody.innerHTML = `<tr><td colspan="4" class="base-td text-center py-4 text-ios-textMuted">Nenhum lote físico encontrado.</td></tr>`;
                
                show(boxResult); setTimeout(() => boxResult.classList.remove('opacity-0', 'translate-y-4'), 10);
            } else {
                hide(boxResult); boxResult.classList.add('opacity-0', 'translate-y-4');
                id('unrecognized-code').innerText = code; createSearchableSelect(id('associate-searchable-container'), localInventory, 'Pesquise pelo nome do insumo...');
                show(boxAssociate); setTimeout(() => boxAssociate.classList.remove('opacity-0', 'translate-y-4'), 10);
                window.showNotif('Código não reconhecido no sistema.', true);
            }
            e.target.value = '';
        }
    });

    addEvt('btn-associate-code', 'click', async () => {
        const searchInput = id('associate-searchable-container').querySelector('input'); if(!searchInput) return;
        const selectedId = searchInput.dataset.selectedId; if(!selectedId) return window.showNotif('Selecione um produto antes de vincular!', true);
        show(id('loading-overlay'));
        try {
            const item = await DB.get('inventory', selectedId);
            if(item) {
                item.barcode = lastScannedCode; await DB.update('inventory', item); await refreshData();
                window.showNotif(`Código salvo com sucesso para ${item.name}!`);
                hide(id('scanner-associate-box')); id('scanner-associate-box').classList.add('opacity-0', 'translate-y-4'); id('scanner-input').focus();
            }
        } catch(e) { window.showNotif('Erro ao vincular código.', true); } finally { hide(id('loading-overlay')); }
    });

    // --- FORMULÁRIO DE NOVA ENTRADA ---
    addEvt('entry-form', 'submit', async (e) => {
        e.preventDefault();
        show(id('loading-overlay'));
        try {
            const pCode = id('entry-product-code').value.trim();
            const pName = id('entry-product-name').value.trim();
            const pType = id('entry-product-type').value;
            const supplier = id('entry-supplier').value;
            const loc = id('entry-location').value.toUpperCase();
            const qty = parseFloat(id('entry-quantity').value);
            const rDate = id('receipt-date').value;
            const expDate = id('expiry-date').value;
            const minStock = parseFloat(id('entry-min-stock').value) || 0;
            const leadTime = parseInt(id('entry-lead-time').value) || 0;

            if (qty <= 0) throw new Error("Quantidade inválida.");

            let p = null;
            if (pCode) p = localInventory.find(i => String(i.code) === pCode || String(i.barcode) === pCode);
            if (!p) p = localInventory.find(i => String(i.name).toLowerCase() === pName.toLowerCase());

            if (!p) {
                p = { code: pCode, name: pName, type: pType, supplier, totalQuantity: 0, minStock, leadTime };
                p.id = await DB.add('inventory', p);
            } else {
                p.totalQuantity = (Number(p.totalQuantity) || 0); 
            }

            const batchCode = 'LT-' + crypto.randomUUID().substring(0,6).toUpperCase();
            await DB.add('batches', { productId: p.id, code: batchCode, location: loc, quantity: qty, expiryDate: expDate, isReleased: true });
            await DB.add('history', { productId: p.id, batchCode, type: 'entrada', quantity: qty, date: rDate, reason: `Entrada Manual` });

            await refreshData();
            window.showNotif('Entrada registrada com sucesso!');
            id('entry-form').reset();
            const t = new Date().toISOString().split('T')[0];
            id('receipt-date').value = t; id('mfg-date').value = t;
            window.navTo('inventory');

        } catch(err) { window.showNotif(err.message || 'Erro ao registrar', true); }
        finally { hide(id('loading-overlay')); }
    });

    addEvt('entry-product-code', 'keypress', e => {
        if(e.key === 'Enter') {
            e.preventDefault();
            const code = e.target.value.trim();
            if(!code) return;
            const p = localInventory.find(i => String(i.code) === code || String(i.barcode) === code);
            if(p) {
                id('entry-product-name').value = p.name || '';
                id('entry-product-type').value = p.type || 'insumo';
                id('entry-supplier').value = p.supplier || '';
                id('entry-lead-time').value = p.leadTime || 0;
                id('entry-min-stock').value = p.minStock || 0;
                window.showNotif('Produto encontrado!');
                id('entry-location').focus();
            } else {
                window.showNotif('Produto não cadastrado. Preencha os dados manualmente.', true);
                id('entry-product-name').focus();
            }
        }
    });

    // --- ESTOQUE E DETALHES ---
    addEvt('search-inventory', 'input', renderInv); addEvt('supplier-filter', 'input', renderInv); addEvt('type-filter', 'input', renderInv);
    document.querySelectorAll('#screen-inventory .table-header-sortable').forEach(th => { th.addEventListener('click', () => { if (invSort.col === th.dataset.sort) invSort.asc = !invSort.asc; else { invSort.col = th.dataset.sort; invSort.asc = true; } renderInv(); }); });
    function renderInv() {
        const tbody = id('inventory-table-body'); if(!tbody) return;
        const term = id('search-inventory')?.value.toLowerCase() || ''; const sup = id('supplier-filter')?.value || ''; const typ = id('type-filter')?.value || '';
        document.querySelectorAll('#screen-inventory .table-header-sortable').forEach(th => { const icon = th.querySelector('i'); if(icon) { if (th.dataset.sort === invSort.col) icon.className = invSort.asc ? 'fa-solid fa-sort-up ml-1 text-ios-blue' : 'fa-solid fa-sort-down ml-1 text-ios-blue'; else icon.className = 'fa-solid fa-sort ml-1 text-ios-textMuted'; } });
        let list = localInventory.filter(i => String(i.name).toLowerCase().includes(term) && (!sup || i.supplier === sup) && (!typ || i.type === typ));
        const getExp = item => localBatches.filter(bt=>bt.productId==item.id && Number(bt.quantity)>0 && bt.expiryDate).sort((x,y)=>new Date(x.expiryDate)-new Date(y.expiryDate))[0]?.expiryDate || '9999-12-31';
        list.sort((a,b) => { let valA, valB; if(invSort.col === 'name') { valA = String(a.name).toLowerCase(); valB = String(b.name).toLowerCase(); } else if(invSort.col === 'supplier') { valA = String(a.supplier||'').toLowerCase(); valB = String(b.supplier||'').toLowerCase(); } else if(invSort.col === 'totalQuantity') { valA = Number(a.totalQuantity)||0; valB = Number(b.totalQuantity)||0; } else if(invSort.col === 'expiry') { valA = getExp(a); valB = getExp(b); } if(valA < valB) return invSort.asc ? -1 : 1; if(valA > valB) return invSort.asc ? 1 : -1; return 0; });
        if(!list.length) { tbody.innerHTML = `<tr><td colspan="5" class="base-td text-center text-ios-textMuted py-8">Nenhum item em estoque.</td></tr>`; return; }
        tbody.innerHTML = list.map(item => {
            const exp = getExp(item); const expFormat = exp !== '9999-12-31' ? new Date(exp+'T00:00:00').toLocaleDateString('pt-BR') : '-';
            const typeClass = item.type==='semi_acabado' ? 'bg-ios-orange/20 text-ios-orange border-ios-orange/30' : 'bg-gray-800 text-gray-300 border-gray-600';
            return `<tr class="base-tr cursor-pointer" data-id="${item.id}"><td class="base-td text-white font-medium">${item.name}</td><td class="base-td"><span class="badge border ${typeClass}">${typeLabels[item.type] || 'Insumo'}</span></td><td class="base-td text-ios-textMuted">${item.supplier || '-'}</td><td class="base-td text-right font-bold text-white">${(Number(item.totalQuantity)||0).toFixed(2)}</td><td class="base-td text-ios-textMuted">${expFormat}</td></tr>`;
        }).join('');
    }
    addEvt('inventory-table-body', 'click', e => { const row = e.target.closest('tr'); if(row && row.dataset.id) window.openDetails(row.dataset.id); });

    addEvt('hist-filter-start', 'change', renderItemDetailsHistory); addEvt('hist-filter-end', 'change', renderItemDetailsHistory); addEvt('hist-filter-type', 'change', renderItemDetailsHistory);
    addEvt('btn-clear-hist-filters', 'click', () => { if(id('hist-filter-start')) id('hist-filter-start').value = ''; if(id('hist-filter-end')) id('hist-filter-end').value = ''; if(id('hist-filter-type')) id('hist-filter-type').value = ''; renderItemDetailsHistory(); });

    function renderItemDetailsHistory() {
        const pId = currentHistoryProductId; if(!pId) return; const p = localInventory.find(i=>i.id==pId); if(!p) return;
        const cont = id('details-history-container'); if(!cont) return;
        let hist = localHistory.filter(h=>h.productId==pId).sort((a,b)=>new Date(b.date)-new Date(a.date));
        const start = id('hist-filter-start')?.value; const end = id('hist-filter-end')?.value; const type = id('hist-filter-type')?.value;
        if (start || end || type) show(id('btn-clear-hist-filters')); else hide(id('btn-clear-hist-filters'));
        if(start) hist = hist.filter(h => h.date >= start); if(end) hist = hist.filter(h => h.date <= end);
        if(type) { if(type === 'entrada') hist = hist.filter(h => String(h.type).includes('entrada')); else if(type === 'saída') hist = hist.filter(h => h.type === 'saída'); else hist = hist.filter(h => h.type === type); }
        if(!hist.length) { cont.innerHTML = '<div class="py-5 text-center text-ios-textMuted text-xs">Nenhuma movimentação no período.</div>'; return; }
        cont.innerHTML = hist.map(h=>`<div class="py-3 border-b border-ios-border text-sm flex justify-between items-center hover:bg-ios-card transition-colors px-2 rounded"><div><span class="font-bold text-xs uppercase ${String(h.type).includes('entrada')?'text-ios-green':h.type==='saída'||h.type==='requisição'?'text-ios-red':'text-ios-blue'}">${h.type}</span><p class="text-xs text-ios-textMuted mt-1 w-48 truncate" title="${h.reason||'Movimentação'}">${h.reason||'Movimentação'}</p></div><div class="text-right"><span class="font-bold text-white ${String(h.type).includes('entrada')?'':'text-ios-red'}">${String(h.type).includes('entrada')?'+':'-'} ${Number(h.quantity).toFixed(2)}</span><br><span class="text-xs text-ios-textMuted"><i class="fa-regular fa-calendar mr-1"></i>${new Date(h.date+'T00:00:00').toLocaleDateString('pt-BR')}</span></div></div>`).join('');
    }

    window.openDetails = function(pId) {
        currentHistoryProductId = pId; const p = localInventory.find(i=>i.id==pId); if(!p) return;
        if(id('details-product-name')) id('details-product-name').innerText = p.name; 
        if(id('details-product-type-badge')) id('details-product-type-badge').innerText = typeLabels[p.type||'insumo']; 
        if(id('details-product-code')) id('details-product-code').innerText = p.code||'-'; 
        if(id('details-product-barcode')) id('details-product-barcode').innerText = p.barcode||'Não cadastrado'; 
        if(id('details-supplier')) id('details-supplier').innerText = p.supplier||'-'; 
        if(id('details-lead-time')) id('details-lead-time').innerText = (p.leadTime||0) + ' dias';
        if(id('details-min-stock')) id('details-min-stock').innerText = (Number(p.minStock)||0).toFixed(2);
        if(id('details-total-quantity')) id('details-total-quantity').innerText = (Number(p.totalQuantity)||0).toFixed(2);
        
        if(id('edit-item-id')) id('edit-item-id').value = p.id; 
        if(id('edit-product-name')) id('edit-product-name').value = p.name; 
        if(id('edit-product-type')) id('edit-product-type').value = p.type||'insumo'; 
        if(id('edit-product-code')) id('edit-product-code').value = p.code||''; 
        if(id('edit-product-barcode')) id('edit-product-barcode').value = p.barcode||''; 
        if(id('edit-supplier')) id('edit-supplier').value = p.supplier||'';
        if(id('edit-lead-time')) id('edit-lead-time').value = p.leadTime||0;
        if(id('edit-min-stock')) id('edit-min-stock').value = p.minStock||0;
        
        const is8110 = String(p.code) === '8110';
        const batchesTable = id('details-batches-table');
        if(batchesTable) {
            batchesTable.innerHTML = localBatches.filter(b=>b.productId==pId && Number(b.quantity)>0).map(b=>{
                let statusHtml = `<span class="text-xs text-ios-green font-bold"><i class="fa-solid fa-check mr-1"></i>Liberado</span>`;
                if(is8110) { statusHtml = `<div class="flex items-center gap-2" title="Lotes não liberados não entram em OP nem Requisição"><input type="checkbox" class="toggle-status toggle-release-batch" data-bid="${b.id}" ${b.isReleased?'checked':''}><span class="text-xs font-bold ${b.isReleased?'text-ios-green':'text-ios-orange'} w-16">${b.isReleased?'Liberado':'Quarentena'}</span></div>`; } 
                else if (b.isReleased === false) { statusHtml = `<div class="flex items-center gap-2"><input type="checkbox" class="toggle-status toggle-release-batch" data-bid="${b.id}"><span class="text-xs font-bold text-ios-orange w-16">Bloqueado</span></div>`; }
                return `<tr class="base-tr"><td class="base-td font-medium text-white">${b.code}</td><td class="base-td text-ios-textMuted uppercase font-mono text-xs">${b.location||'-'}</td><td class="base-td">${statusHtml}</td><td class="base-td font-bold text-ios-blue">${Number(b.quantity).toFixed(2)}</td><td class="base-td text-ios-textMuted">${b.expiryDate?new Date(b.expiryDate+'T00:00:00').toLocaleDateString('pt-BR'):'-'}</td><td class="base-td text-center"><button class="text-ios-blue hover:text-blue-400 p-2 edit-batch-btn bg-ios-bg rounded-lg border border-ios-border mr-1" data-id="${b.id}"><i class="fa-solid fa-pen"></i></button><button class="text-ios-red hover:text-red-400 p-2 del-batch-btn bg-ios-bg rounded-lg border border-ios-border" data-id="${b.id}"><i class="fa-solid fa-trash"></i></button></td></tr>`
            }).join('');
        }
        renderItemDetailsHistory(); show(id('item-details-view')); hide(id('item-details-edit')); show(id('item-details-modal'));
    }

    // --- FORMULÁRIO DE EDIÇÃO DE DETALHES ---
    addEvt('btn-edit-item', 'click', () => { hide(id('item-details-view')); show(id('item-details-edit')); });
    addEvt('btn-cancel-edit', 'click', () => { show(id('item-details-view')); hide(id('item-details-edit')); });
    
    addEvt('edit-item-form', 'submit', async (e) => {
        e.preventDefault(); show(id('loading-overlay'));
        try {
            const pId = id('edit-item-id').value;
            const p = await DB.get('inventory', pId);
            if(p) {
                p.name = id('edit-product-name').value;
                p.type = id('edit-product-type').value;
                p.code = id('edit-product-code').value;
                p.barcode = id('edit-product-barcode').value;
                p.supplier = id('edit-supplier').value;
                p.leadTime = parseInt(id('edit-lead-time').value) || 0;
                p.minStock = parseFloat(id('edit-min-stock').value) || 0;
                await DB.update('inventory', p);
                await refreshData();
                window.showNotif('Insumo atualizado!');
                window.openDetails(pId);
            }
        } catch(err) { window.showNotif('Erro ao editar', true); }
        finally { hide(id('loading-overlay')); }
    });

    // --- RECEITAS (IMPORTAÇÃO INTELIGENTE DE EXCEL MULTIPLAS ABAS) ---
    addEvt('search-recipe', 'input', renderRecipes);
    function renderRecipes() {
        const grid = id('recipes-grid'); if(!grid) return;
        const term = id('search-recipe')?.value.toLowerCase() || '';
        let f = localRecipes.filter(r => currentRecipeCategory==='Todos' || r.category===currentRecipeCategory);
        if(term) f = f.filter(r => String(r.name).toLowerCase().includes(term) || String(r.category).toLowerCase().includes(term));

        const catList = id('recipe-categories-list');
        if(catList) {
            catList.innerHTML = ['Todos', ...new Set(localRecipes.map(r=>r.category))].map(c => 
                `<li><a href="#" class="block p-3 rounded-lg text-sm text-ios-textMuted hover:bg-ios-card transition-colors ${c===currentRecipeCategory?'bg-ios-card text-white font-semibold':''}" data-cat="${c}">${c}</a></li>`
            ).join('');
        }
        
        grid.innerHTML = f.map(r => {
            const isSemi = r.isSemi;
            const ingredientsHTML = (r.ingredients || []).map(i=> {
                const prod = localInventory.find(p=>p.id==i.productId);
                const isWarning = prod && String(prod.name).startsWith('⚠️');
                return `<li class="flex justify-between py-1 border-b border-ios-border/30 last:border-0"><span class="truncate pr-2 ${isWarning ? 'text-ios-orange font-bold' : ''}">${prod?prod.name:'?'}</span><span class="font-bold text-ios-blue bg-ios-bg px-2 rounded">${i.quantity}</span></li>`;
            }).join('');
            
            return `
            <div class="card relative flex flex-col border border-transparent ${isSemi ? 'hover:border-ios-orange/50' : 'hover:border-ios-cardHover'} transition-all">
                <div class="absolute top-4 right-4 flex gap-2">
                    <button class="edit-rec-btn text-ios-blue bg-ios-blue/10 p-2 w-8 h-8 rounded-full hover:bg-ios-blue/20 flex items-center justify-center" data-id="${r.id}"><i class="fa-solid fa-pen text-xs"></i></button>
                    <button class="del-rec-btn text-ios-red bg-ios-red/10 p-2 w-8 h-8 rounded-full hover:bg-ios-red/20 flex items-center justify-center" data-id="${r.id}"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>
                <h3 class="text-lg font-bold text-white mb-1 pr-20 leading-tight">${r.name}</h3>
                <div class="mb-4 mt-1 inline-flex">
                    ${isSemi ? `<span class="bg-ios-orange/10 border border-ios-orange/50 text-ios-orange text-xs px-2 py-1 rounded-md"><i class="fa-solid fa-box mr-1"></i>Semi-Acabado (Rende: ${r.outputYield||1})</span>` : `<span class="bg-gray-800 border border-gray-600 text-gray-300 text-xs px-2 py-1 rounded-md"><i class="fa-solid fa-utensils mr-1"></i>Produto Acabado</span>`}
                </div>
                <div class="mt-auto border-t border-ios-border pt-4 bg-ios-bg -mx-6 -mb-6 px-6 pb-6 rounded-b-2xl">
                    <p class="text-[10px] text-ios-textMuted uppercase font-bold mb-3 tracking-wider"><i class="fa-solid fa-list-ul mr-1"></i> Ingredientes</p>
                    <ul class="text-sm text-ios-textMuted">${ingredientsHTML}</ul>
                </div>
            </div>`;
        }).join('');
    }

    addEvt('recipe-categories-list', 'click', e => { if(e.target.tagName==='A') { e.preventDefault(); currentRecipeCategory = e.target.dataset.cat; renderRecipes(); }});
    addEvt('recipes-grid', 'click', e => {
        const delBtn = e.target.closest('.del-rec-btn'); const editBtn = e.target.closest('.edit-rec-btn');
        if(delBtn) window.showConfirmationModal('Apagar Ficha?', 'Confirma a exclusão da receita?', async () => { show(id('loading-overlay')); await DB.remove('recipes', delBtn.dataset.id); await refreshData(); hide(id('loading-overlay')); window.showNotif('Excluída'); });
        if(editBtn) openEditRecipe(editBtn.dataset.id);
    });
    addEvt('recipe-is-semi', 'change', e => { if(e.target.checked) show(id('yield-wrapper')); else hide(id('yield-wrapper')); });

    addEvt('btn-import-recipes', 'click', () => id('recipe-file-input')?.click());
    addEvt('btn-import-recipe-image', 'click', () => id('recipe-image-input')?.click());

    async function fetchWithRetry(url, options, retries = 5) {
        let delay = 1000;
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return await res.json();
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
    }

    addEvt('recipe-image-input', 'change', e => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
            try {
                show(id('loading-overlay'));
                if(id('loading-text')) id('loading-text').innerText = "Extraindo dados da Imagem com IA...";
                
                const base64Data = ev.target.result.split(',')[1];
                const mimeType = file.type;
                const apiKey = ""; 

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const prompt = `Você é um assistente de leitura de fichas técnicas para a indústria. Extraia os ingredientes desta tabela de receita. Procure especificamente pela coluna 'CÓDIGO' (ou 'COD') e a coluna de quantidade final requerida na receita ('QTD/RECEITA' ou 'QTD').
                Retorne estritamente um array JSON de objetos, onde cada objeto tenha:
                - "codigo": string (o código exato do produto, sem formatações estranhas)
                - "nome": string (o nome e descrição do produto)
                - "quantidade": number (a quantidade formatada apenas como número de ponto flutuante, não inclua "kg" ou "L")`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: mimeType, data: base64Data } }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const result = await fetchWithRetry(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("A IA não conseguiu interpretar a imagem.");
                
                const items = JSON.parse(text);
                if (!items || items.length === 0) throw new Error("Nenhum item detectado na imagem.");

                // Clica no botão para abrir o Modal de nova receita
                id('btn-new-recipe').click();
                if(id('recipe-name')) id('recipe-name').value = "Receita Importada (Foto)";
                const ingCont = id('ingredients-container');
                ingCont.innerHTML = ''; // Limpa as linhas padões vazias

                let missingCodes = 0;

                for(let item of items) {
                    if (!item.codigo) continue;
                    // Procura o item no estoque pelo código
                    let p = localInventory.find(i => String(i.code).toUpperCase() === String(item.codigo).toUpperCase());
                    
                    if(!p) {
                        missingCodes++;
                        const alertName = '⚠️ ' + (item.nome || 'Desconhecido');
                        p = { id: crypto.randomUUID(), code: String(item.codigo), name: alertName, type: 'insumo', supplier: 'A DEFINIR', totalQuantity: 0, minStock: 0, leadTime: 0 };
                        // Registra código faltante preventivamente para o usuário conseguir ver o erro na tela e editar
                        await DB.add('inventory', p);
                        localInventory.push(p);
                    }
                    
                    window.addIngRowReq(ingCont, p.id, item.quantidade || 0);
                }

                await refreshData();
                
                if (missingCodes > 0) {
                    window.showNotif(`Foto Lida! CUIDADO: ${missingCodes} código(s) da receita não existem no seu estoque. Foram marcados com ⚠️.`, true);
                } else {
                    window.showNotif('Leitura perfeita! Todos os códigos foram cruzados com o estoque.');
                }

            } catch (err) {
                console.error(err);
                window.showNotif('Falha ao processar imagem. Tente novamente com uma foto mais nítida.', true);
            } finally {
                if(id('recipe-image-input')) id('recipe-image-input').value = '';
                if(id('loading-text')) id('loading-text').innerText = "Processando...";
                hide(id('loading-overlay'));
            }
        };
        reader.readAsDataURL(file); 
    });

    addEvt('recipe-file-input', 'change', e => {
        const file = e.target.files[0]; if(!file) return; 
        const reader = new FileReader();
        
        reader.onload = async ev => {
            try {
                show(id('loading-overlay'));
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                let importedCount = 0;
                
                for (const sheetName of workbook.SheetNames) {
                    const worksheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
                    
                    if(rows.length < 2) continue; 
                    
                    let recipeName = sheetName;
                    let yieldQty = 1;
                    let ingredients = [];
                    let readingIngs = false;
                    let colIng = -1, colCode = -1, colQty = -1;
                    
                    for (const row of rows) {
                        const rowStr = row.join(' ').toUpperCase();
                        if(rowStr.includes('PREPARAÇÃO:')) {
                            const cell = row.find(c => String(c).toUpperCase().includes('PREPARAÇÃO:'));
                            if(cell) recipeName = String(cell).replace(/PREPARAÇÃO:/i, '').trim();
                        }
                        if(rowStr.includes('RENDIMENTO')) {
                            const idxRend = row.findIndex(c => String(c).toUpperCase().includes('RENDIMENTO'));
                            if(idxRend !== -1) { yieldQty = parseFloat(row[idxRend+1]) || parseFloat(row[idxRend+2]) || 1; }
                        }
                        if(!readingIngs && rowStr.includes('INGREDIENTE') && rowStr.includes('QUANTIDADE')) {
                            colIng = row.findIndex(c => String(c).toUpperCase().trim() === 'INGREDIENTE');
                            colQty = row.findIndex(c => String(c).toUpperCase().trim() === 'QUANTIDADE');
                            colCode = row.findIndex(c => String(c).toUpperCase().trim() === 'CÓDIGO');
                            readingIngs = true; continue;
                        }
                        if(readingIngs && colIng !== -1 && colQty !== -1) {
                            const ingNameRaw = String(row[colIng]).trim();
                            const qtyRaw = parseFloat(String(row[colQty]).replace(',', '.')); 
                            
                            if(ingNameRaw.toUpperCase() === 'TOTAL' || ingNameRaw.toUpperCase() === 'RENDIMENTO' || ingNameRaw.toUpperCase().includes('KG')) {
                                readingIngs = false; continue;
                            }
                            
                            if(ingNameRaw && !isNaN(qtyRaw) && qtyRaw > 0) {
                                let code = colCode !== -1 ? String(row[colCode]).trim() : '';
                                let p = null;
                                if(code) p = localInventory.find(i => String(i.code) === code);
                                if(!p) p = localInventory.find(i => String(i.name).toLowerCase() === ingNameRaw.toLowerCase());
                                
                                if(!p) {
                                    const alertName = '⚠️ ' + ingNameRaw;
                                    p = localInventory.find(i => String(i.name) === alertName);
                                    if(!p) {
                                        p = { id: crypto.randomUUID(), code: code || '', name: alertName, type: 'insumo', supplier: 'A DEFINIR', totalQuantity: 0, minStock: 0, leadTime: 0 };
                                        await DB.add('inventory', p);
                                        localInventory.push(p); 
                                    }
                                }
                                ingredients.push({ productId: p.id, quantity: qtyRaw });
                            }
                        }
                    }
                    
                    if(ingredients.length > 0) {
                        let existingRecipe = localRecipes.find(r => r.name === recipeName);
                        if(existingRecipe) {
                            existingRecipe.ingredients = ingredients; existingRecipe.outputYield = yieldQty;
                            await DB.update('recipes', existingRecipe);
                        } else {
                            await DB.add('recipes', { name: recipeName, category: 'Importadas', outputProductId: null, outputYield: yieldQty, isSemi: false, ingredients: ingredients });
                        }
                        importedCount++;
                    }
                }
                await refreshData();
                window.showNotif(`Sucesso! ${importedCount} receitas importadas.`);
            } catch(err) {
                console.error(err); window.showNotif('Erro na leitura do arquivo Excel.', true); 
            } finally { 
                if(id('recipe-file-input')) id('recipe-file-input').value=''; hide(id('loading-overlay'));
            }
        }; 
        reader.readAsArrayBuffer(file);
    });

    function openEditRecipe(rId) {
        const r = localRecipes.find(x => x.id == rId); if(!r) return;
        if(id('edit-recipe-id')) id('edit-recipe-id').value = r.id; 
        if(id('recipe-name')) id('recipe-name').value = r.name; 
        if(id('recipe-category')) id('recipe-category').value = r.category;
        const chkSemi = id('recipe-is-semi'); if(chkSemi) { chkSemi.checked = !!r.isSemi; chkSemi.dispatchEvent(new Event('change')); }
        if(r.isSemi && id('recipe-yield')) id('recipe-yield').value = r.outputYield || 1; 
        const ingCont = id('ingredients-container');
        if(ingCont) { ingCont.innerHTML = ''; (r.ingredients || []).forEach(ing => { window.addIngRowReq(ingCont, ing.productId, ing.quantity); }); }
        if(id('recipe-modal-title')) id('recipe-modal-title').innerText = 'Editar Receita'; 
        show(id('recipe-modal'));
    }

    addEvt('btn-new-recipe', 'click', () => {
        const rf = id('recipe-form'); if(rf) rf.reset(); 
        if(id('edit-recipe-id')) id('edit-recipe-id').value=''; 
        const ingCont = id('ingredients-container'); if(ingCont) ingCont.innerHTML=''; 
        const chkSemi = id('recipe-is-semi'); if(chkSemi) { chkSemi.checked = false; chkSemi.dispatchEvent(new Event('change')); }
        if(id('recipe-yield')) id('recipe-yield').value = 1;
        if(ingCont) window.addIngRowReq(ingCont); 
        if(id('recipe-modal-title')) id('recipe-modal-title').innerText = 'Nova Receita'; 
        show(id('recipe-modal'));
    });

    // --- FUNÇÕES COMPLEMENTARES QUE FALTAVAM (LINHA DINÂMICA) ---
    window.addIngRowReq = function(container, productId = '', qty = '') {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center';
        div.innerHTML = `
            <div class="flex-1 searchable-container relative"></div>
            <input type="number" min="0.01" step="0.01" class="form-input w-24 text-center ing-qty" placeholder="Qtd" value="${qty}" required>
            <button type="button" class="text-ios-red p-2 hover:bg-ios-red/10 rounded-lg transition-colors remove-ing-btn"><i class="fa-solid fa-trash"></i></button>
        `;
        container.appendChild(div);
        createSearchableSelect(div.querySelector('.searchable-container'), localInventory, 'Buscar insumo...', (item) => { div.dataset.productId = item.id; });
        if(productId) {
            const p = localInventory.find(i=>i.id == productId);
            if(p) {
                const input = div.querySelector('input[type="text"]');
                if(input) { input.value = p.name; input.dataset.selectedId = p.id; div.dataset.productId = p.id; }
            }
        }
        div.querySelector('.remove-ing-btn').addEventListener('click', () => div.remove());
    }

    addEvt('add-requisition-item-btn', 'click', () => window.addIngRowReq(id('requisition-items-container')));
    addEvt('add-ingredient-btn', 'click', () => window.addIngRowReq(id('ingredients-container')));

    // --- REQUISIÇÃO E BAIXA AVULSA ---
    addEvt('requisition-form', 'submit', async (e) => {
        e.preventDefault();
        const reason = id('requisition-reason').value;
        const resp = id('requisition-responsible').value;
        const rows = document.querySelectorAll('#requisition-items-container > div');
        let items = [];
        for(let row of rows) {
            const input = row.querySelector('input[type="text"]');
            const pId = input?.dataset.selectedId;
            const qty = parseFloat(row.querySelector('.ing-qty').value);
            if(pId && qty > 0) items.push({pId, qty});
        }
        if(!items.length) return window.showNotif('Adicione pelo menos um item', true);

        show(id('loading-overlay'));
        try {
            for(let item of items) {
                let {plan, isSufficient} = getFIFOPlan(item.pId, item.qty);
                if(!isSufficient) throw new Error('Saldo insuficiente ou bloqueado para um dos itens selecionados.');
                for(let p of plan) {
                    let b = await DB.get('batches', p.batchId);
                    b.quantity -= p.quantity;
                    await DB.update('batches', b);
                    await DB.add('history', { productId: item.pId, batchCode: b.code, type: 'requisição', quantity: p.quantity, date: new Date().toISOString().split('T')[0], reason: reason + ' - ' + resp });
                }
            }
            await refreshData();
            window.showNotif('Requisição concluída!');
            id('requisition-form').reset();
            window.navTo('inventory');
        } catch(err) {
            window.showNotif(err.message, true);
        } finally {
            hide(id('loading-overlay'));
        }
    });

    // --- AJUSTE MANUAL DE LOTE ---
    addEvt('adjustment-form', 'submit', async (e) => {
        e.preventDefault();
        const bId = id('adjustment-batch').value;
        const newQty = parseFloat(id('adjustment-new-quantity').value);
        const reason = id('adjustment-reason').value;
        const resp = id('adjustment-responsible').value;

        if(!bId) return window.showNotif('Selecione um lote.', true);

        show(id('loading-overlay'));
        try {
            const b = await DB.get('batches', bId);
            const diff = newQty - (Number(b.quantity)||0);
            
            b.quantity = newQty;
            await DB.update('batches', b);
            
            if(diff !== 0) {
                await DB.add('history', { 
                    productId: b.productId, 
                    batchCode: b.code, 
                    type: 'ajuste', 
                    quantity: Math.abs(diff), 
                    date: new Date().toISOString().split('T')[0], 
                    reason: `Ajuste (${diff > 0 ? '+' : ''}${diff}): ${reason} - Resp: ${resp}` 
                });
            }
            await refreshData();
            window.showNotif('Lote ajustado com sucesso!');
            id('adjustment-form').reset();
            window.navTo('inventory');
        } catch(err) { window.showNotif('Erro no ajuste.', true); }
        finally { hide(id('loading-overlay')); }
    });

    // --- PRODUÇÃO (OP) - EVENTOS E LÓGICA ---
    window.currentPoPlan = {};

    window.updatePoPreview = function(recipeId) {
        const rec = localRecipes.find(r => r.id == recipeId);
        const mult = parseFloat(id('po-quantity').value) || 1;
        window.currentPoPlan = {};
        
        if(!rec) return;
        
        if(rec.isSemi) {
            show(id('po-output-fields'));
            id('po-total-output').value = ((parseFloat(rec.outputYield)||1) * mult).toFixed(4);
        } else {
            hide(id('po-output-fields'));
        }
        
        if(rec.ingredients && rec.ingredients.length > 0) {
            rec.ingredients.forEach(ing => {
                const reqQty = ing.quantity * mult;
                const { plan, isSufficient } = getFIFOPlan(ing.productId, reqQty);
                window.currentPoPlan[ing.productId] = { reqQty, plan, isSufficient };
            });
        }
        window.renderPoTableOnly(rec);
    };

    window.renderPoTableOnly = function(rec) {
        const tbody = id('po-ingredients-body');
        if(!rec || !rec.ingredients || rec.ingredients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="base-td text-center text-ios-textMuted">Receita sem ingredientes.</td></tr>';
            return;
        }

        const mult = parseFloat(id('po-quantity').value) || 1;
        
        tbody.innerHTML = rec.ingredients.map(ing => {
            const p = localInventory.find(i => i.id == ing.productId);
            const pName = p ? p.name : 'Insumo Excluído';
            const reqQty = ing.quantity * mult;
            const avail = p ? (Number(p.totalQuantity)||0) : 0;
            const planData = window.currentPoPlan[ing.productId];
            
            let badges = `<span class="text-ios-textMuted">-</span>`;
            if(planData && planData.plan && planData.plan.length > 0) {
                badges = planData.plan.map(pl => `<span class="bg-ios-blue/20 text-ios-blue border border-ios-blue/50 px-2 py-0.5 rounded-md text-[10px] whitespace-nowrap">${pl.batchCode}: ${pl.quantity.toFixed(2)}</span>`).join(' ');
            } else if (planData && planData.reqQty > 0) {
                badges = `<span class="text-ios-red text-xs">Estoque Insuficiente</span>`;
            }

            const planHtml = `<div class="flex items-center flex-wrap gap-1">${badges} <button type="button" class="btn-edit-po-batch text-ios-textMuted hover:text-white p-1 ml-1 rounded transition" data-pid="${ing.productId}" title="Editar Lotes"><i class="fa-solid fa-pen"></i></button></div>`;

            return `<tr>
                <td class="base-td font-medium text-white">${pName}</td>
                <td class="base-td">${avail.toFixed(2)}</td>
                <td class="base-td font-bold ${planData?.isSufficient?'text-white':'text-ios-red'}">${reqQty.toFixed(4)}</td>
                <td class="base-td">${planHtml}</td>
            </tr>`;
        }).join('');
    };

    addEvt('po-ingredients-body', 'click', e => {
        const btn = e.target.closest('.btn-edit-po-batch');
        if(btn) {
            const pId = btn.dataset.pid;
            const planData = window.currentPoPlan[pId];
            if(!planData) return;
            
            const p = localInventory.find(i=>i.id == pId);
            id('batch-selector-title').innerText = `Lotes: ${p?.name}`;
            id('batch-selector-needed').innerText = planData.reqQty.toFixed(4);
            currentBatchTarget = pId;

            const allBatches = localBatches.filter(b => b.productId == pId && Number(b.quantity) > 0 && b.isReleased !== false);
            const list = id('batch-selector-list');
            
            list.innerHTML = allBatches.map(b => {
                const reservedOther = getReservedQty(b.id);
                const available = (Number(b.quantity) || 0) - reservedOther;
                const inPlan = planData.plan.find(x => x.batchId == b.id);
                const qtyVal = inPlan ? inPlan.quantity : 0;
                const maxAllowed = available + qtyVal;
                
                return `<div class="flex justify-between items-center bg-ios-cardHover p-3 rounded-xl border border-ios-border mb-2">
                    <div><p class="font-bold text-white text-sm">${b.code} <span class="text-[10px] text-ios-textMuted bg-black px-1 rounded ml-1">${b.location||'Sem local'}</span></p><p class="text-xs text-ios-textMuted">Livre: ${available.toFixed(4)}</p></div>
                    <input type="number" class="form-input w-24 text-right batch-select-input text-ios-blue font-bold" data-bid="${b.id}" data-bcode="${b.code}" max="${maxAllowed}" min="0" step="0.001" value="${qtyVal > 0 ? qtyVal : ''}">
                </div>`;
            }).join('');
            
            if(!allBatches.length) list.innerHTML = '<div class="text-center text-ios-textMuted py-4">Nenhum lote liberado disponível.</div>';
            
            show(id('batch-selector-modal'));
        }
    });

    addEvt('confirm-batch-selection', 'click', () => {
        const pId = currentBatchTarget;
        const inputs = document.querySelectorAll('.batch-select-input');
        let newPlan = [];
        let total = 0;
        inputs.forEach(inp => {
            const val = parseFloat(inp.value);
            if(val > 0) {
                newPlan.push({ batchId: inp.dataset.bid, batchCode: inp.dataset.bcode, quantity: val });
                total += val;
            }
        });
        window.currentPoPlan[pId].plan = newPlan;
        window.currentPoPlan[pId].isSufficient = (total >= window.currentPoPlan[pId].reqQty - 0.001);
        
        hide(id('batch-selector-modal'));
        const container = id('po-recipe-searchable-container');
        const recipeInput = container?.querySelector('input');
        const rId = recipeInput?.dataset.selectedId;
        const rec = localRecipes.find(r => r.id == rId);
        window.renderPoTableOnly(rec);
    });

    addEvt('po-quantity', 'input', () => {
        const container = id('po-recipe-searchable-container');
        const input = container?.querySelector('input');
        if(input && input.dataset.selectedId) {
            window.updatePoPreview(input.dataset.selectedId);
        }
    });

    addEvt('btn-new-production-order', 'click', () => {
        const poForm = id('production-order-form'); if(poForm) poForm.reset();
        id('edit-po-id').value = '';
        id('po-ingredients-body').innerHTML = '<tr><td colspan="4" class="base-td text-center text-ios-textMuted py-4">Selecione uma receita primeiro.</td></tr>';
        hide(id('po-output-fields'));
        id('po-total-output').value = '0.0000';
        id('po-date').value = new Date().toISOString().split('T')[0];
        window.currentPoPlan = {};
        
        createSearchableSelect(id('po-recipe-searchable-container'), localRecipes, 'Buscar receita...', (item) => {
            window.updatePoPreview(item.id);
        });
        
        show(id('production-order-modal'));
    });

    addEvt('production-order-form', 'submit', async (e) => {
        e.preventDefault();
        const container = id('po-recipe-searchable-container');
        const recipeInput = container?.querySelector('input');
        const rId = recipeInput?.dataset.selectedId;
        
        if(!rId) return window.showNotif('Selecione uma receita válida.', true);
        
        const rec = localRecipes.find(r => r.id == rId);
        if(!rec) return;

        const hasShortage = rec.ingredients.some(ing => !window.currentPoPlan[ing.productId]?.isSufficient);
        if(hasShortage) return window.showNotif('Estoque insuficiente para um ou mais ingredientes!', true);

        const mult = parseFloat(id('po-quantity').value) || 1;
        const poDate = id('po-date').value;
        const isExtra = id('po-is-extra').checked;
        const outBatch = id('po-output-batch').value || ('OP-' + crypto.randomUUID().substring(0,6).toUpperCase());
        const outExpiry = id('po-output-expiry').value;

        show(id('loading-overlay'));
        try {
            const mappedIngredients = rec.ingredients.map(ing => ({
                productId: ing.productId,
                quantity: ing.quantity,
                consumptionPlan: window.currentPoPlan[ing.productId]?.plan || []
            }));

            const newOp = {
                recipeId: rId,
                recipeCategory: rec.category || 'Diversos',
                quantityMultiplier: mult,
                date: poDate,
                isExtra: isExtra,
                status: 'pendente',
                ingredients: mappedIngredients,
                outputBatch: outBatch,
                outputExpiry: outExpiry,
                totalOutput: parseFloat(id('po-total-output').value) || 0,
                picking: { status: 'pendente', responsible: '', start: null, end: null, duration: 0, pickedItems: {} }
            };
            
            await DB.add('productionOrders', newOp);
            await refreshData();
            hide(id('production-order-modal'));
            window.showNotif('OP Gerada com Sucesso e Itens Reservados!');
        } catch(err) {
            window.showNotif('Erro ao gerar OP.', true);
        } finally {
            hide(id('loading-overlay'));
        }
    });

    // --- EFETIVAR (CONSUMIR/GERAR) OPs ---
    window.renderPO = function() {
        const list = id('production-orders-list');
        if(!list) return;
        
        const activeOps = localProductionOrders.filter(o => o.status === 'pendente' || o.status === 'em_andamento').sort((a,b) => new Date(a.date) - new Date(b.date));
        
        if(activeOps.length === 0) {
            list.innerHTML = `<div class="md:col-span-2 text-center py-10 text-ios-textMuted border border-dashed border-ios-border rounded-xl">Nenhuma Ordem de Produção pendente.</div>`;
            return;
        }
        
        list.innerHTML = activeOps.map(op => {
            const r = localRecipes.find(x => x.id === op.recipeId);
            const poDate = new Date(op.date+'T00:00:00').toLocaleDateString('pt-BR');
            return `
            <div class="card p-5 hover:border-ios-blue transition-colors flex gap-4 items-start ${op.isExtra ? 'border-ios-orange/50 bg-ios-orange/5' : ''}">
                <div class="mt-1">
                    <input type="checkbox" class="ui-checkbox ui-checkbox-success po-checkbox" value="${op.id}">
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-white leading-tight">${r ? r.name : 'Desconhecida'}</h3>
                        ${op.isExtra ? `<span class="badge bg-ios-orange text-white text-[10px] ml-2 shrink-0">Extra</span>` : ''}
                    </div>
                    <p class="text-sm text-ios-textMuted mb-2">Multiplicador: <span class="font-bold text-white">${op.quantityMultiplier}x</span> | Data: ${poDate}</p>
                    <div class="bg-ios-bg p-3 rounded-lg border border-ios-border text-xs">
                        <p class="text-ios-textMuted mb-1 font-semibold uppercase">Progresso Separação (Picking):</p>
                        ${renderPickingProgressMini(op)}
                    </div>
                </div>
            </div>`;
        }).join('');
    };

    function renderPickingProgressMini(op) {
        let req = 0, picked = 0;
        if(op.ingredients) {
            op.ingredients.forEach(i => {
                req += (i.quantity * op.quantityMultiplier);
                picked += (op.picking?.pickedItems?.[i.productId] || 0);
            });
        }
        if (req === 0) return '<span class="text-ios-textMuted">Sem insumos</span>';
        
        const displayPct = Math.round((picked / req) * 100);
        let color = displayPct >= 100 ? 'bg-ios-green' : 'bg-ios-blue';
        return `
            <div class="w-full bg-ios-cardHover rounded-full h-2 mt-1 relative overflow-hidden">
                <div class="${color} h-2 rounded-full transition-all" style="width: ${Math.min(100, displayPct)}%"></div>
            </div>
            <p class="text-right text-[10px] mt-1 ${displayPct >= 100 ? 'text-ios-green font-bold' : 'text-ios-textMuted'}">${displayPct}% Completo</p>
        `;
    }

    addEvt('btn-confirm-production', 'click', async () => {
        const checkboxes = document.querySelectorAll('.po-checkbox:checked');
        if(checkboxes.length === 0) return window.showNotif('Selecione pelo menos uma OP marcando a caixa.', true);

        window.showConfirmationModal('Efetivar OPs Selecionadas?', 'Isso consumirá os insumos considerando o volume SEPARADO. Para semi-acabados, gerará saldo no estoque.', async () => {
            show(id('loading-overlay'));
            try {
                for(let cb of checkboxes) {
                    const op = localProductionOrders.find(o => o.id === cb.value);
                    if(!op) continue;
                    const rec = localRecipes.find(r => r.id === op.recipeId);
                    
                    // 1. Dar saída (consumir) ingredientes baseados no que foi SEPARADO
                    for(let ing of (op.ingredients || [])) {
                        const pickedAmount = op.picking?.pickedItems?.[ing.productId];
                        const amountToConsume = pickedAmount !== undefined ? pickedAmount : (ing.quantity * op.quantityMultiplier);

                        if(amountToConsume <= 0) continue; 

                        let remainingToConsume = amountToConsume;
                        
                        // A. Consome primeiro dos lotes que haviam sido reservados no plano
                        for(let plan of (ing.consumptionPlan || [])) {
                            if(remainingToConsume <= 0) break;
                            const batch = await DB.get('batches', plan.batchId);
                            if(batch) {
                                const planDeduct = Math.min(plan.quantity, remainingToConsume);
                                if(planDeduct > 0) {
                                    batch.quantity -= planDeduct;
                                    await DB.update('batches', batch);
                                    await DB.add('history', { productId: ing.productId, batchCode: batch.code, type: 'saída', quantity: planDeduct, date: new Date().toISOString().split('T')[0], reason: `OP: ${rec?.name}` });
                                    remainingToConsume -= planDeduct;
                                }
                            }
                        }

                        // B. Se sobrou quantidade para consumir (excesso na separação), consome via FIFO dos lotes disponíveis
                        if(remainingToConsume > 0) {
                            const { plan: extraPlan } = getFIFOPlan(ing.productId, remainingToConsume);
                            for(let p of extraPlan) {
                                const batch = await DB.get('batches', p.batchId);
                                if(batch) {
                                    batch.quantity -= p.quantity;
                                    await DB.update('batches', batch);
                                    await DB.add('history', { productId: ing.productId, batchCode: batch.code, type: 'saída', quantity: p.quantity, date: new Date().toISOString().split('T')[0], reason: `OP (Excesso): ${rec?.name}` });
                                    remainingToConsume -= p.quantity;
                                }
                            }
                            
                            // C. Se o estoque físico zerou mas ainda tem que consumir, força um lote para absorver o negativo
                            if(remainingToConsume > 0) {
                                let anyBatch = (await DB.getAll('batches')).find(b => b.productId === ing.productId);
                                if(!anyBatch) {
                                    anyBatch = { productId: ing.productId, code: 'LT-FANTASMA', location: 'S/ LOCAL', quantity: 0, expiryDate: null, isReleased: true };
                                    anyBatch.id = await DB.add('batches', anyBatch);
                                }
                                anyBatch.quantity -= remainingToConsume;
                                await DB.update('batches', anyBatch);
                                await DB.add('history', { productId: ing.productId, batchCode: anyBatch.code, type: 'saída', quantity: remainingToConsume, date: new Date().toISOString().split('T')[0], reason: `OP (Falta Estoque): ${rec?.name}` });
                            }
                        }
                    }

                    // 2. Dar entrada do produto se for semi-acabado
                    if(rec && rec.isSemi) {
                        let prod = localInventory.find(i => String(i.name).toLowerCase() === String(rec.name).toLowerCase() && i.type === 'semi_acabado');
                        if(!prod) {
                            prod = { code: '', name: rec.name, type: 'semi_acabado', supplier: 'Produção Interna', totalQuantity: 0, minStock: 0, leadTime: 0 };
                            prod.id = await DB.add('inventory', prod);
                        }
                        const outQty = parseFloat(op.totalOutput) || (parseFloat(rec.outputYield || 1) * op.quantityMultiplier);
                        await DB.add('batches', { productId: prod.id, code: op.outputBatch, location: 'PRODUÇÃO', quantity: outQty, expiryDate: op.outputExpiry, isReleased: true });
                        await DB.add('history', { productId: prod.id, batchCode: op.outputBatch, type: 'entrada', quantity: outQty, date: new Date().toISOString().split('T')[0], reason: `OP Concluída` });
                    }

                    // 3. Muda Status da OP
                    op.status = 'concluida';
                    await DB.update('productionOrders', op);
                }

                await refreshData();
                window.showNotif('OPs Efetivadas com Sucesso! Estoque atualizado.');
            } catch(e) {
                console.error(e);
                window.showNotif('Erro ao efetivar OP. Tente novamente.', true);
            } finally {
                hide(id('loading-overlay'));
            }
        });
    });

    // --- SEPARAÇÃO (PICKING) ---
    window.lastPickerName = '';

    window.renderPickingScreen = function() {
        const cont = id('picking-lines-container');
        if(!cont) return;
        
        const activeOps = localProductionOrders.filter(o => o.status === 'pendente' || o.status === 'em_andamento');
        if(activeOps.length === 0) {
            cont.innerHTML = `<div class="card border border-dashed border-ios-border flex items-center justify-center p-10"><div class="text-center"><i class="fa-solid fa-dolly text-4xl text-ios-textMuted mb-4"></i><p class="text-ios-textMuted font-medium">Nenhuma OP ativa para separação.</p></div></div>`;
            return;
        }

        const lines = {};
        activeOps.forEach(op => {
            const cat = op.recipeCategory || 'Diversos';
            if(!lines[cat]) lines[cat] = { ops: [], items: {} };
            lines[cat].ops.push(op.id);
            
            (op.ingredients || []).forEach(ing => {
                if(!lines[cat].items[ing.productId]) {
                    const p = localInventory.find(i=>i.id===ing.productId);
                    lines[cat].items[ing.productId] = { req: 0, picked: 0, name: p?.name || 'Desconhecido', barcode: p?.barcode || p?.code || '' };
                }
                lines[cat].items[ing.productId].req += (ing.quantity * op.quantityMultiplier);
                lines[cat].items[ing.productId].picked += (op.picking?.pickedItems?.[ing.productId] || 0);
            });
        });

        let html = '';
        for(let cat in lines) {
            const line = lines[cat];
            
            const itemsHtml = Object.keys(line.items).map(pId => {
                const item = line.items[pId];
                const isComplete = item.picked >= item.req;
                return `<div class="flex justify-between items-center py-3 border-b border-ios-border last:border-0">
                    <div>
                        <p class="font-bold text-sm text-white ${isComplete ? 'line-through text-ios-green' : ''}">${item.name}</p>
                        <p class="text-xs text-ios-textMuted font-mono">Cód: ${item.barcode || 'N/D'}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-ios-textMuted">Separado:</span> 
                        <span class="font-bold text-lg ${isComplete ? 'text-ios-green' : 'text-ios-blue'}">${item.picked.toFixed(2)}</span> 
                        <span class="text-xs text-ios-textMuted">/ ${item.req.toFixed(2)}</span>
                    </div>
                </div>`;
            }).join('');

            html += `<div class="card mb-6 border-l-4 border-l-ios-orange">
                <div class="flex justify-between items-center mb-4 border-b border-ios-border pb-4">
                    <h2 class="title-md mb-0 text-white"><i class="fa-solid fa-layer-group mr-2 text-ios-orange"></i>Linha: ${cat}</h2>
                    <span class="badge bg-ios-orange/20 text-ios-orange">${line.ops.length} OPs na fila</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-5 bg-ios-bg p-4 rounded-xl border border-ios-border items-end">
                    <div class="md:col-span-1">
                        <label class="form-label text-xs">Responsável</label>
                        <input type="text" id="picker-name-${cat.replace(/\s+/g, '-')}" class="form-input py-2 text-sm picker-name-input" placeholder="Seu Nome" value="${window.lastPickerName || ''}">
                    </div>
                    <div class="md:col-span-2 relative">
                        <label class="form-label text-xs flex justify-between">
                            <span>Cód. Insumo / Barras</span>
                            <button type="button" class="text-ios-blue text-[10px] bg-ios-blue/10 px-2 py-0.5 rounded hover:bg-ios-blue/20 btn-scan-cam-pick" data-cat="${cat.replace(/\s+/g, '-')}"><i class="fa-solid fa-camera mr-1"></i>Câmera</button>
                        </label>
                        <input type="text" id="picking-scan-${cat.replace(/\s+/g, '-')}" class="form-input py-2 text-sm font-mono text-ios-green focus:border-ios-green" placeholder="Bipe o item...">
                        <div id="cam-reader-${cat.replace(/\s+/g, '-')}" class="w-full hidden mt-2 border border-ios-border rounded-xl bg-black overflow-hidden absolute z-50 shadow-2xl"></div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="form-label text-xs">Quantidade</label>
                            <input type="number" id="picking-qty-${cat.replace(/\s+/g, '-')}" class="form-input py-2 text-sm text-center font-bold" value="1" min="0.01" step="0.01">
                        </div>
                        <button class="btn-primary py-2 px-4 h-[38px] w-[38px] flex items-center justify-center btn-pick-add shrink-0" data-cat="${cat}" data-cid="${cat.replace(/\s+/g, '-')}">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xs font-semibold text-ios-textMuted uppercase mb-2">Lista Agregada de Insumos</h3>
                    <div class="bg-ios-bg border border-ios-border rounded-xl px-4 py-1">${itemsHtml}</div>
                </div>
            </div>`;
        }
        cont.innerHTML = html;
    };

    addEvt('picking-lines-container', 'click', async e => {
        const btnCam = e.target.closest('.btn-scan-cam-pick');
        if(btnCam) {
            const cid = btnCam.dataset.cat;
            window.toggleCamera(`cam-reader-${cid}`, `picking-scan-${cid}`);
            return;
        }

        const btnAdd = e.target.closest('.btn-pick-add');
        if(!btnAdd) return;
        
        const cat = btnAdd.dataset.cat;
        const cid = btnAdd.dataset.cid;
        const pickerName = id(`picker-name-${cid}`).value.trim();
        const scanCode = id(`picking-scan-${cid}`).value.trim();
        const qty = parseFloat(id(`picking-qty-${cid}`).value);

        if(!pickerName) return window.showNotif('Informe o nome do responsável.', true);
        if(!scanCode || qty <= 0 || isNaN(qty)) return window.showNotif('Informe o código e quantidade válida.', true);
        
        window.lastPickerName = pickerName;
        document.querySelectorAll('.picker-name-input').forEach(i => i.value = pickerName);

        const prod = localInventory.find(i => String(i.code) === scanCode || String(i.barcode) === scanCode);
        if(!prod) return window.showNotif('Produto não encontrado no sistema.', true);

        show(id('loading-overlay'));
        try {
            let remainingToAdd = qty;
            const activeOps = localProductionOrders.filter(o => (o.status === 'pendente' || o.status === 'em_andamento') && o.recipeCategory === cat);
            
            let itemBelongsToLine = false;

            for(let op of activeOps) {
                if(remainingToAdd <= 0) break;
                
                const opIng = (op.ingredients || []).find(i => i.productId === prod.id);
                if(opIng) {
                    itemBelongsToLine = true;
                    if(!op.picking) op.picking = { status: 'em_andamento', responsible: pickerName, pickedItems: {} };
                    if(!op.picking.pickedItems) op.picking.pickedItems = {};
                    
                    const neededForThisOp = opIng.quantity * op.quantityMultiplier;
                    const pickedSoFar = op.picking.pickedItems[prod.id] || 0;
                    const missing = neededForThisOp - pickedSoFar;
                    
                    if(missing > 0) {
                        const addHere = Math.min(missing, remainingToAdd);
                        op.picking.pickedItems[prod.id] = pickedSoFar + addHere;
                        op.picking.responsible = pickerName;
                        op.status = 'em_andamento';
                        remainingToAdd -= addHere;
                        await DB.update('productionOrders', op);
                    }
                }
            }

            if(remainingToAdd > 0 && itemBelongsToLine) {
                for(let op of activeOps) {
                    const opIng = (op.ingredients || []).find(i => i.productId === prod.id);
                    if(opIng) {
                        if(!op.picking) op.picking = { status: 'em_andamento', responsible: pickerName, pickedItems: {} };
                        if(!op.picking.pickedItems) op.picking.pickedItems = {};
                        op.picking.pickedItems[prod.id] = (op.picking.pickedItems[prod.id] || 0) + remainingToAdd;
                        op.picking.responsible = pickerName;
                        op.status = 'em_andamento';
                        remainingToAdd = 0;
                        await DB.update('productionOrders', op);
                        break;
                    }
                }
            }

            if(!itemBelongsToLine) {
                window.showNotif(`O item ${prod.name} não faz parte das receitas desta linha!`, true);
            } else {
                window.showNotif(`+${qty} de ${prod.name} separado!`);
                id(`picking-scan-${cid}`).value = '';
                id(`picking-qty-${cid}`).value = 1;
                id(`picking-scan-${cid}`).focus();
                await refreshData();
            }
        } catch(err) {
            window.showNotif('Erro ao processar separação.', true);
        } finally {
            hide(id('loading-overlay'));
        }
    });

    addEvt('picking-lines-container', 'keypress', e => {
        if(e.key === 'Enter' && e.target.id && e.target.id.startsWith('picking-scan-')) {
            e.preventDefault();
            const cid = e.target.id.replace('picking-scan-', '');
            const btn = document.querySelector(`.btn-pick-add[data-cid="${cid}"]`);
            if(btn) btn.click();
        }
    });

    // --- CONSUMO MENSAL ---
    window.renderConsum = function() {
        const body = id('consumption-table-body');
        if(!body) return;
        body.innerHTML = `<tr><td colspan="2" class="base-td text-center text-ios-textMuted py-8">Os relatórios mensais são gerados no fechamento do período.</td></tr>`;
    }

    window.updateSidebarBadges = function() {
        const badgeProd = id('badge-nav-prod');
        const activeOps = localProductionOrders.filter(o => o.status === 'pendente' || o.status === 'em_andamento');
        if(badgeProd) { activeOps.length > 0 ? show(badgeProd) : hide(badgeProd); }
        
        const badgePick = id('badge-nav-picking');
        if(badgePick) { activeOps.length > 0 ? show(badgePick) : hide(badgePick); }
    }

    // --- ENTRADA DE ESTOQUE EM MASSA (CSV/XLSX) ---
    addEvt('btn-upload-backup', 'click', () => id('backup-file-input')?.click());
    
    addEvt('backup-file-input', 'change', e => {
        const file = e.target.files[0]; if(!file) return; 
        const reader = new FileReader();
        reader.onload = async ev => {
            try {
                show(id('loading-overlay'));
                const data = new Uint8Array(ev.target.result); 
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0]; 
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {defval: ""});
                if(!json || json.length === 0) throw new Error("Planilha vazia");

                let countNovos = 0, countAtualizados = 0;
                for(const row of json) {
                    const cleanKeys = Object.keys(row).map(k => ({ original: k, clean: k.replace(/^\uFEFF/, '').trim() }));
                    const getVal = (key) => { const found = cleanKeys.find(k => k.clean.toLowerCase().includes(key.toLowerCase())); return found ? row[found.original] : ""; };
                    
                    const name = getVal('Nome do Produto'); 
                    const code = String(getVal('Código')).trim(); 
                    const supplier = getVal('Fornecedor');
                    const batchCodeRaw = getVal('Lote'); 
                    const batchCode = (!batchCodeRaw || batchCodeRaw === 'N/A') ? 'LT-' + crypto.randomUUID().substring(0,6).toUpperCase() : String(batchCodeRaw).trim();
                    const batchQty = parseFloat(getVal('Quantidade do Lote')) || parseFloat(getVal('Quantidade Física')) || parseFloat(getVal('Quantidade')) || 0;
                    const location = getVal('Local') || getVal('Endereço') || getVal('Rua') || '';

                    if(!name || batchQty <= 0) continue;

                    let p = null;
                    if (code && code !== 'N/A') p = await DB.getByIndex('inventory', 'code', code);
                    if (!p) p = (await DB.getAll('inventory')).find(x => String(x.name).toLowerCase() === String(name).toLowerCase());

                    if(!p) {
                        p = { code: code !== 'N/A' ? code : '', name: name, type: 'insumo', supplier: supplier, totalQuantity: 0, minStock: parseFloat(getVal('Estoque Mínimo')) || 0, leadTime: 0 };
                        p.id = await DB.add('inventory', p); countNovos++;
                    } else {
                        if(supplier && supplier !== 'N/A') p.supplier = supplier;
                        await DB.update('inventory', p); countAtualizados++;
                    }

                    let expiry = null; const expRaw = getVal('Validade');
                    if(expRaw && expRaw !== 'N/A') {
                        if(!isNaN(expRaw) && typeof expRaw === 'number') { const d = new Date(Math.round((expRaw - 25569)*86400*1000)); expiry = d.toISOString().split('T')[0]; } 
                        else if(typeof expRaw === 'string') { const pts = expRaw.split('/'); if(pts.length === 3) expiry = `${pts[2]}-${pts[1]}-${pts[0]}`; }
                    }
                    
                    p.totalQuantity = (Number(p.totalQuantity) || 0) + batchQty; await DB.update('inventory', p);
                    await DB.add('batches', { productId: p.id, code: batchCode, location: String(location).toUpperCase(), quantity: batchQty, expiryDate: expiry, isReleased: (String(p.code) !== '8110') });
                    await DB.add('history', { productId: p.id, batchCode: batchCode, type: 'entrada', quantity: batchQty, date: new Date().toISOString().split('T')[0], reason: `Importação Planilha` });
                }

                await refreshData();
                window.showNotif(`Importação concluída! ${countNovos} produtos criados, ${countAtualizados} atualizados.`);
            } catch(err) { window.showNotif('Erro na leitura do arquivo CSV/Excel. Verifique o formato.', true); } finally { if(id('backup-file-input')) id('backup-file-input').value=''; hide(id('loading-overlay')); }
        }; 
        reader.readAsArrayBuffer(file);
    });

</script>
</body>
</html>
