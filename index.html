<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Rendimentos - Gestão de Produção</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        
        /* Scrollbar Personalizada */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f3f4f6; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        
        /* Variáveis CSS */
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --primary-light: #ffedd5;
        }

        .bg-primary { background-color: var(--primary) !important; }
        .text-primary { color: var(--primary) !important; }
        .border-primary { border-color: var(--primary) !important; }
        .hover-bg-primary:hover { background-color: var(--primary-dark) !important; }
        
        /* Estilos de Impressão */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .shadow-sm, .shadow-lg { box-shadow: none !important; }
            .border { border-color: #000 !important; }
            
            /* Reset de cores de fundo para economizar tinta, mas manter legibilidade */
            .bg-gray-100, .bg-gray-50, .bg-orange-50 { background-color: #f5f5f5 !important; }
            .bg-primary { background-color: #ddd !important; color: black !important; border: 1px solid #000; }
            .text-white { color: black !important; }
            
            /* Forçar quebra de página */
            .page-break { break-after: page; page-break-after: always; }
            .avoid-break { break-inside: avoid; page-break-inside: avoid; }
            
            /* Tabelas de Impressão */
            .print-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: Arial, sans-serif; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 4px 6px; text-align: left; }
            .print-table th { background-color: #eee !important; font-weight: bold; text-transform: uppercase; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helpers ---
        const toKg = (qty, unit) => {
            const val = parseFloat(qty) || 0;
            const u = (unit || '').toLowerCase().trim();
            if (u === 'g' || u === 'grama' || u === 'gramas') return val / 1000;
            if (u === 'mg') return val / 1000000;
            if (u === 'ml') return val / 1000;
            return val;
        };

        const isPackaging = (name) => {
            const n = (name || '').toLowerCase();
            return n.includes('embalagem') || n.includes('etiqueta') || n.includes('bobina') || n.includes('saco') || n.includes('fita') || n.includes('caixa');
        };

        const extractColor = (imgSrc) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imgSrc;
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1;
                    canvas.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                    resolve(`rgb(${r}, ${g}, ${b})`);
                };
                img.onerror = () => resolve('#f97316');
            });
        };

        const formatDate = (isoString) => {
            if (!isoString) return 'Data desconhecida';
            if (isoString.includes('T')) {
                return new Date(isoString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
            }
            const parts = isoString.split('-');
            if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`;
            return isoString;
        };

        const groupBySection = (ingredients) => {
            return ingredients.reduce((acc, ing) => {
                const sec = ing.section || 'Geral';
                if (!acc[sec]) acc[sec] = [];
                acc[sec].push(ing);
                return acc;
            }, {});
        };

        // --- Ícones ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                ChefHat: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg>,
                ClipboardList: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
                Activity: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
                Settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
                Plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                BarChart3: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
                ArrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
                X: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
                CheckCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
                AlertTriangle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
                Edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                Calendar: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                Upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                Image: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
                Box: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22.08V12"/></svg>,
                Eye: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
                Sparkles: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
                ArrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
                Info: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
                Scale: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
                Download: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                Database: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
                ExternalLink: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
                Search: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                Filter: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
                Book: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
                Printer: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
            };
            return icons[name] || <span className="text-xs">?</span>;
        };

        // --- SearchableSelect ---
        const SearchableSelect = ({ options, value, onChange, placeholder, labelKey = 'label', valueKey = 'value', disabled = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                if (!value) {
                    setSearchTerm('');
                } else {
                    const selected = options.find(opt => (typeof opt === 'object' ? opt[valueKey] : opt) === value);
                    if (selected) {
                        setSearchTerm(typeof selected === 'object' ? selected[labelKey] : selected);
                    }
                }
            }, [value, options, labelKey, valueKey]);

            const filteredOptions = useMemo(() => {
                if (!searchTerm) return options;
                return options.filter(opt => {
                    const label = typeof opt === 'object' ? opt[labelKey] : opt;
                    return String(label).toLowerCase().includes(searchTerm.toLowerCase());
                });
            }, [options, searchTerm, labelKey]);

            const handleSelect = (opt) => {
                const val = typeof opt === 'object' ? opt[valueKey] : opt;
                const label = typeof opt === 'object' ? opt[labelKey] : opt;
                onChange(val);
                setSearchTerm(String(label));
                setIsOpen(false);
            };

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <div className="relative">
                        <input
                            type="text"
                            className={`w-full p-2 border ${isOpen ? 'border-primary ring-1 ring-orange-500' : 'border-gray-300'} rounded-lg outline-none text-sm bg-white disabled:bg-gray-100 disabled:text-gray-400`}
                            placeholder={placeholder}
                            value={searchTerm}
                            onChange={(e) => {
                                setSearchTerm(e.target.value);
                                setIsOpen(true);
                                if(e.target.value === '') onChange('');
                            }}
                            onClick={() => !disabled && setIsOpen(true)}
                            disabled={disabled}
                        />
                        <div className="absolute right-2 top-2.5 text-gray-400 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                    </div>
                    {isOpen && !disabled && (
                        <ul className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto custom-scroll" style={{ zIndex: 9999 }}>
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map((opt, idx) => {
                                    const val = typeof opt === 'object' ? opt[valueKey] : opt;
                                    const label = typeof opt === 'object' ? opt[labelKey] : opt;
                                    return (
                                        <li 
                                            key={idx} 
                                            onClick={() => handleSelect(opt)}
                                            className={`p-2 text-sm cursor-pointer hover:bg-gray-50 break-words ${val === value ? 'bg-gray-100 text-primary font-medium' : 'text-gray-700'}`}
                                        >
                                            {String(label)}
                                        </li>
                                    );
                                })
                            ) : (
                                <li className="p-2 text-sm text-gray-400 italic">Nenhuma opção encontrada</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };

        // --- Dados Iniciais ---
        const initialRecipes = [
            {
                id: 1,
                name: "Pão Francês Tradicional",
                line: "Padaria",
                lastUpdated: new Date().toISOString(),
                sections: { "Massa": { processLossPct: 15, tolerancePct: 10, targetSharePct: 100 } },
                ingredients: [
                    { id: 1, name: "Farinha de Trigo", qty: 25000, unit: "g", lossPct: 0, section: "Massa", fixedQty: 0 },
                    { id: 2, name: "Água Gelada", qty: 15000, unit: "g", lossPct: 0, section: "Massa", fixedQty: 0 },
                    { id: 3, name: "Sal Refinado", qty: 500, unit: "g", lossPct: 0, section: "Massa", fixedQty: 0 },
                    { id: 4, name: "Fermento Biológico", qty: 800, unit: "g", lossPct: 0, section: "Massa", fixedQty: 0 },
                    { id: 5, name: "Melhorador", qty: 250, unit: "g", lossPct: 0, section: "Massa", fixedQty: 0 }
                ],
                outputType: 'kg', 
                outputUnitWeight: 0
            },
            {
                id: 2,
                name: "PANACOTA",
                line: "Confeitaria",
                lastUpdated: new Date().toISOString(),
                outputType: "unit",
                outputUnitWeight: 130,
                outputUnitMeasure: "g",
                sections: {
                    "CREME": { processLossPct: 0, tolerancePct: 5, targetSharePct: 73 },
                    "COBERTURA": { processLossPct: 0, tolerancePct: 5, targetSharePct: 27 },
                    "EMBALAGEM": { processLossPct: 0, tolerancePct: 0, targetSharePct: 0 }
                },
                ingredients: [
                    { name: "Creme de Leite", qty: 0.027, unit: "kg", lossPct: 0, section: "CREME", fixedQty: 0 },
                    { name: "Leite Condensado", qty: 0.013, unit: "kg", lossPct: 0, section: "CREME", fixedQty: 0 },
                    { name: "Chantilly Sabor Nata", qty: 0.054, unit: "kg", lossPct: 0, section: "CREME", fixedQty: 0 },
                    { name: "Gelatina sem Sabor", qty: 0.001, unit: "kg", lossPct: 0, section: "CREME", fixedQty: 0 },
                    { name: "Preparado de Morango", qty: 0.035, unit: "kg", lossPct: 0, section: "COBERTURA", fixedQty: 0 },
                    { name: "G 679 - Embalagem Sobremesa", qty: 1, unit: "und", lossPct: 0, section: "EMBALAGEM", fixedQty: 0 },
                    { name: "Etiqueta", qty: 1, unit: "und", lossPct: 0, section: "EMBALAGEM", fixedQty: 0 }
                ]
            },
            {
                id: 3,
                name: "MOUSSE MORANGO",
                line: "Confeitaria",
                lastUpdated: new Date().toISOString(),
                outputType: "unit",
                outputUnitWeight: 100,
                outputUnitMeasure: "g",
                sections: {
                    "MOUSSE": { processLossPct: 0, tolerancePct: 5, targetSharePct: 15 },
                    "MOUSSE (BRIGADEIRO BRANCO)": { processLossPct: 6.8, tolerancePct: 5, targetSharePct: 70 },
                    "DECORAÇÃO": { processLossPct: 0, tolerancePct: 5, targetSharePct: 15 },
                    "EMBALAGEM": { processLossPct: 0, tolerancePct: 0, targetSharePct: 0 }
                },
                ingredients: [
                    { name: "Creme Culinário", qty: 0.007, unit: "kg", lossPct: 0, section: "MOUSSE", fixedQty: 0 },
                    { name: "Preparo de Morango", qty: 0.008, unit: "kg", lossPct: 0, section: "MOUSSE", fixedQty: 0 },
                    { name: "Creme Culinário", qty: 0.026, unit: "kg", lossPct: 0, section: "MOUSSE (BRIGADEIRO BRANCO)", fixedQty: 0 },
                    { name: "Leite Condensado", qty: 0.054, unit: "kg", lossPct: 0, section: "MOUSSE (BRIGADEIRO BRANCO)", fixedQty: 0 },
                    { name: "Preparo de Morango", qty: 0.015, unit: "kg", lossPct: 0, section: "DECORAÇÃO", fixedQty: 0 },
                    { name: "Embalagem Mousse/Cheesecake", qty: 1, unit: "und", lossPct: 0, section: "EMBALAGEM", fixedQty: 0 },
                    { name: "Etiqueta", qty: 1, unit: "und", lossPct: 0, section: "EMBALAGEM", fixedQty: 0 }
                ]
            }
        ];

        const initialLines = ["Padaria", "Confeitaria", "Salgados", "Cozinha Industrial"];
        const initialStages = ["Massa", "Recheio", "Cobertura", "Montagem", "Outros"];

        // --- Gráfico ---
        const ControlChart = ({ data, targetYield, stageName, tolerance }) => {
            const safeTolerance = tolerance !== undefined ? tolerance : 10;
            if (!data || data.length < 2) return <div className="h-48 flex items-center justify-center text-gray-400 text-sm bg-gray-50 rounded-lg border border-dashed">Dados insuficientes para gráfico (mínimo 2 registros)</div>;
            const values = data.map(d => d.yieldPct);
            const dates = data.map(d => new Date(d.date));
            const mean = targetYield || 0;
            const upperLimit = mean * (1 + safeTolerance / 100);
            const lowerLimit = mean * (1 - safeTolerance / 100);
            const height = 220, width = 600, padding = 50;
            const maxVal = Math.max(...values, upperLimit) * 1.05;
            const minVal = Math.min(...values, lowerLimit) * 0.95;
            const range = (maxVal - minVal) || 1;
            const getY = (val) => height - padding - ((val - minVal) / range) * (height - (padding * 2));
            const getX = (idx) => padding + (idx / (Math.max(values.length - 1, 1))) * (width - (padding * 2));
            const points = values.map((val, idx) => `${getX(idx)},${getY(val)}`).join(' ');

            return (
                <div className="w-full overflow-x-auto">
                    <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} className="bg-white rounded-lg shadow-sm border border-gray-200 min-w-[600px]">
                        <rect x={padding} y={padding} width={width - padding * 2} height={height - padding * 2} fill="#f9fafb" />
                        <line x1={padding} y1={getY(mean)} x2={width - padding} y2={getY(mean)} stroke="var(--primary)" strokeWidth="2" strokeDasharray="4" />
                        <text x={width - padding + 5} y={getY(mean) + 3} className="text-[10px] fill-emerald-600 font-bold">Meta: {mean.toFixed(1)}%</text>
                        <line x1={padding} y1={getY(upperLimit)} x2={width - padding} y2={getY(upperLimit)} stroke="#ef4444" strokeWidth="1" strokeDasharray="2" />
                        <text x={width - padding + 5} y={getY(upperLimit) + 3} className="text-[10px] fill-red-500">LCS</text>
                        <line x1={padding} y1={getY(lowerLimit)} x2={width - padding} y2={getY(lowerLimit)} stroke="#ef4444" strokeWidth="1" strokeDasharray="2" />
                        <text x={width - padding + 5} y={getY(lowerLimit) + 3} className="text-[10px] fill-red-500">LCI</text>
                        <polyline points={points} fill="none" stroke="#6b7280" strokeWidth="2" />
                        {values.map((val, idx) => (
                            <g key={idx}>
                                <circle cx={getX(idx)} cy={getY(val)} r="4" fill={val > upperLimit || val < lowerLimit ? "#ef4444" : "#6b7280"} stroke="white" strokeWidth="2"><title>{formatDate(data[idx].date)}: {val.toFixed(2)}%</title></circle>
                                { (data.length <= 10 || idx % Math.ceil(data.length/10) === 0) && <text x={getX(idx)} y={height - 15} textAnchor="middle" className="text-[9px] fill-gray-500 font-medium" fontSize="9">{formatDate(data[idx].date).slice(0,5)}</text> }
                            </g>
                        ))}
                    </svg>
                    <div className="text-center text-xs text-gray-500 mt-2">Rendimento Real vs Meta ({mean.toFixed(1)}%)</div>
                </div>
            );
        };

        // --- Componente Livreto ---
        const RecipeBooklet = ({ recipes, settings, onBack }) => {
            const sortedRecipes = useMemo(() => {
                return [...recipes].sort((a,b) => a.name.localeCompare(b.name));
            }, [recipes]);

            const today = new Date().toLocaleDateString('pt-BR');

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Controles de Impressão */}
                    <div className="no-print bg-white p-4 border-b border-gray-200 sticky top-0 z-50 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="flex items-center gap-2 text-gray-600 hover:text-gray-900 font-medium">
                                <Icon name="ArrowLeft" size={20} /> Voltar
                            </button>
                            <div>
                                <h2 className="font-bold text-lg text-gray-800">Modo Livreto</h2>
                                <p className="text-xs text-gray-500">Layout otimizado para impressão (1 Receita por página)</p>
                            </div>
                        </div>
                        <button onClick={() => window.print()} className="bg-primary text-white px-6 py-2 rounded-lg font-bold shadow-sm hover:bg-orange-600 flex items-center gap-2 transition-colors">
                            <Icon name="Printer" size={20} /> Imprimir Livreto
                        </button>
                    </div>

                    {/* Área Imprimível */}
                    <div className="max-w-[210mm] mx-auto bg-white min-h-screen shadow-lg p-12 print:p-0 print:shadow-none print:w-full print:max-w-none">
                        
                        {/* CAPA */}
                        <div className="page-break flex flex-col items-center justify-center text-center min-h-[80vh] border-b-2 border-dashed border-gray-200 mb-12 print:border-none print:h-screen print:justify-center">
                            {settings.logo && (
                                <img src={settings.logo} className="h-40 w-auto object-contain mb-12" alt="Logo" />
                            )}
                            {!settings.logo && (
                                <div className="h-32 w-32 bg-gray-100 rounded-full flex items-center justify-center mb-12">
                                    <Icon name="ChefHat" size={64} className="text-gray-400" />
                                </div>
                            )}
                            <h1 className="text-5xl font-extrabold text-gray-900 mb-6 tracking-tight">MANUAL DE RECEITAS</h1>
                            <p className="text-2xl text-gray-500 font-light mb-12">Fichas Técnicas de Produção</p>
                            
                            <div className="mt-auto border-t border-gray-200 pt-8 w-full max-w-md">
                                <p className="text-sm text-gray-400 font-mono">Gerado em: {today}</p>
                                <p className="text-sm text-gray-400 font-mono">Total de Receitas: {recipes.length}</p>
                            </div>
                        </div>

                        {/* LISTA DE RECEITAS */}
                        {sortedRecipes.map((recipe, index) => {
                             const sections = groupBySection(recipe.ingredients);
                             
                             return (
                                <div key={recipe.id} className="page-break py-4">
                                    {/* Cabeçalho da Receita */}
                                    <div className="border-b-4 border-gray-800 pb-4 mb-8 flex flex-col md:flex-row justify-between items-start md:items-end">
                                        <div>
                                            <span className="text-xs font-bold uppercase tracking-widest text-gray-500 mb-1 block">{recipe.line}</span>
                                            <h2 className="text-4xl font-bold text-gray-900 leading-none">{recipe.name}</h2>
                                        </div>
                                        <div className="mt-4 md:mt-0 text-right">
                                            {recipe.outputType === 'unit' || recipe.outputType === 'package' ? (
                                                 <div className="bg-gray-100 px-3 py-1 rounded">
                                                    <span className="text-xs font-bold text-gray-500 uppercase block">Peso Padrão</span>
                                                    <span className="font-mono font-bold text-lg">
                                                        {recipe.outputUnitWeight} {recipe.outputUnitMeasure}
                                                    </span>
                                                 </div>
                                            ) : (
                                                <div className="bg-gray-100 px-3 py-1 rounded">
                                                    <span className="text-xs font-bold text-gray-500 uppercase block">Venda</span>
                                                    <span className="font-mono font-bold text-lg">Granel (kg)</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Corpo da Receita */}
                                    <div className="space-y-8">
                                        {Object.entries(sections).map(([sectionName, ingredients]) => {
                                            const sectionConfig = recipe.sections?.[sectionName];
                                            
                                            return (
                                                <div key={sectionName} className="avoid-break">
                                                    <div className="flex items-center justify-between mb-3 border-b border-gray-200 pb-1">
                                                        <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                                            <div className="w-2 h-6 bg-gray-800"></div>
                                                            {sectionName}
                                                        </h3>
                                                        {sectionConfig && sectionConfig.processLossPct > 0 && (
                                                            <span className="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                                                Perda Técnica: {sectionConfig.processLossPct}%
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    <table className="w-full text-sm border-collapse">
                                                        <thead>
                                                            <tr className="bg-gray-50 border-b border-gray-300">
                                                                <th className="py-2 px-3 text-left w-2/3 font-bold text-gray-600 uppercase text-xs">Ingrediente</th>
                                                                <th className="py-2 px-3 text-right font-bold text-gray-600 uppercase text-xs">Quantidade Base</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {ingredients.map((ing, idx) => (
                                                                <tr key={idx} className="border-b border-gray-100">
                                                                    <td className="py-2 px-3 align-top">
                                                                        <span className="font-medium text-gray-800">{ing.name}</span>
                                                                        {ing.fixedQty > 0 && (
                                                                            <span className="block text-xs text-gray-400 italic mt-0.5">
                                                                                + {ing.fixedQty} {ing.unit} (Startup)
                                                                            </span>
                                                                        )}
                                                                    </td>
                                                                    <td className="py-2 px-3 text-right align-top font-mono font-medium text-gray-700">
                                                                        {parseFloat(ing.qty).toFixed(3)} {ing.unit}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* Rodapé da Receita */}
                                    <div className="mt-12 pt-4 border-t border-gray-200 flex justify-between items-end text-xs text-gray-400">
                                        <div>
                                            <p>Documento interno de produção.</p>
                                        </div>
                                        <div className="text-right">
                                            <p>Atualizado em: {formatDate(recipe.lastUpdated)}</p>
                                            <p>Página {index + 1}</p>
                                        </div>
                                    </div>
                                </div>
                             );
                        })}
                    </div>
                </div>
            );
        };

        // --- Componentes do Dashboard ---

        const Dashboard = ({ setView }) => (
            <div className="space-y-6 animate-fade-in">
                <h2 className="text-2xl font-bold text-gray-800">Painel de Controle</h2>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div onClick={() => setView('production')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow group">
                        <div className="flex justify-between items-start">
                            <div><p className="text-gray-500 text-sm font-medium">Operacional</p><h3 className="text-lg font-bold text-gray-800 mt-1">Ordens de Produção</h3></div>
                            <div className="p-3 bg-orange-50 text-primary rounded-lg transition-colors"><Icon name="ClipboardList" /></div>
                        </div>
                    </div>
                    <div onClick={() => setView('monitoring')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow group">
                        <div className="flex justify-between items-start">
                            <div><p className="text-gray-500 text-sm font-medium">Qualidade</p><h3 className="text-lg font-bold text-gray-800 mt-1">Acompanhamento</h3></div>
                            <div className="p-3 bg-purple-50 text-purple-600 rounded-lg transition-colors"><Icon name="Activity" /></div>
                        </div>
                    </div>
                    <div onClick={() => setView('recipes')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow group">
                        <div className="flex justify-between items-start">
                            <div><p className="text-gray-500 text-sm font-medium">Técnica</p><h3 className="text-lg font-bold text-gray-800 mt-1">Minhas Receitas</h3></div>
                            <div className="p-3 bg-emerald-50 text-emerald-600 rounded-lg transition-colors"><Icon name="ChefHat" /></div>
                        </div>
                    </div>
                    <div onClick={() => setView('settings')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow group">
                        <div className="flex justify-between items-start">
                            <div><p className="text-gray-500 text-sm font-medium">Sistema</p><h3 className="text-lg font-bold text-gray-800 mt-1">Configurações</h3></div>
                            <div className="p-3 bg-gray-50 text-gray-600 rounded-lg transition-colors"><Icon name="Settings" /></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const MonitoringView = ({ recipes, logs, setLogs }) => {
            const [selectedRecipeId, setSelectedRecipeId] = useState('');
            const [yieldValue, setYieldValue] = useState('');
            const [entryDate, setEntryDate] = useState(new Date().toISOString().split('T')[0]); // Default today
            const [logSearch, setLogSearch] = useState('');

            const selectedRecipe = useMemo(() => recipes.find(r => r.id == selectedRecipeId), [recipes, selectedRecipeId]);
            
            // Filter logs for the chart (specific to selected recipe)
            const recipeLogs = useMemo(() => {
                if(!selectedRecipe) return [];
                return (logs || [])
                    .filter(l => l.recipeId === selectedRecipe.id)
                    .sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [logs, selectedRecipe]);

            // Filter logs for the history table (global or filtered)
            const filteredHistory = useMemo(() => {
                let filtered = logs || [];
                if (logSearch) {
                    const term = logSearch.toLowerCase();
                    filtered = filtered.filter(l => {
                        const recipe = recipes.find(r => r.id === l.recipeId);
                        const recipeName = recipe ? recipe.name.toLowerCase() : '';
                        const dateStr = formatDate(l.date).toLowerCase();
                        return recipeName.includes(term) || dateStr.includes(term);
                    });
                }
                return filtered.sort((a,b) => new Date(b.date) - new Date(a.date)); // Newest first
            }, [logs, logSearch, recipes]);

            const handleAddLog = () => {
                if(!selectedRecipe || !yieldValue || !entryDate) return;
                const newLog = {
                    id: Date.now(),
                    recipeId: selectedRecipe.id,
                    yieldPct: parseFloat(yieldValue),
                    date: entryDate 
                };
                setLogs([...(logs||[]), newLog]);
                setYieldValue('');
            };

            const handleDeleteLog = (id) => {
                if(confirm('Remover este registro?')) {
                    setLogs(logs.filter(l => l.id !== id));
                }
            };

            return (
                <div className="space-y-6">
                     {/* Entry Form */}
                     <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icon name="Activity" className="text-purple-600" /> Monitoramento de Qualidade
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Selecione a Receita</label>
                                <SearchableSelect 
                                    options={recipes.map(r => ({label: r.name, value: r.id}))}
                                    value={selectedRecipeId}
                                    onChange={setSelectedRecipeId}
                                    placeholder="Buscar Receita para Lançamento"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                <input 
                                    type="date" 
                                    value={entryDate} 
                                    onChange={e => setEntryDate(e.target.value)} 
                                    className="w-full p-2 border border-gray-300 rounded-lg text-sm" 
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Rendimento Real (%)</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="number" 
                                        value={yieldValue} 
                                        onChange={e => setYieldValue(e.target.value)} 
                                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" 
                                        placeholder="Ex: 95" 
                                    />
                                    <button 
                                        onClick={handleAddLog} 
                                        className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-sm font-medium"
                                        disabled={!selectedRecipe || !yieldValue}
                                    >
                                        Lançar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Chart Section */}
                    {selectedRecipe && recipeLogs.length > 0 && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 animate-fade-in">
                             <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-gray-700">Gráfico de Controle: {selectedRecipe.name}</h3>
                                <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Baseado nos registros filtrados</span>
                             </div>
                             <ControlChart 
                                data={recipeLogs} 
                                targetYield={100 - (Object.values(selectedRecipe.sections || {})[0]?.processLossPct || 0)} 
                                tolerance={10} 
                            />
                        </div>
                    )}

                    {/* History Table with Search */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-4 border-b border-gray-200 bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                <Icon name="ClipboardList" size={18} /> Histórico de Registros
                            </h3>
                            <div className="relative w-full md:w-64">
                                <div className="absolute left-3 top-2.5 text-gray-400">
                                    <Icon name="Search" size={16} />
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar por produto ou data..." 
                                    className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                                    value={logSearch}
                                    onChange={(e) => setLogSearch(e.target.value)}
                                />
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-gray-600 uppercase font-bold text-xs">
                                    <tr>
                                        <th className="px-6 py-3">Data</th>
                                        <th className="px-6 py-3">Produto / Receita</th>
                                        <th className="px-6 py-3 text-right">Rendimento Registrado</th>
                                        <th className="px-6 py-3 text-center">Status</th>
                                        <th className="px-6 py-3 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredHistory.length > 0 ? (
                                        filteredHistory.map(log => {
                                            const recipe = recipes.find(r => r.id === log.recipeId);
                                            const recipeName = recipe ? recipe.name : 'Receita Excluída';
                                            // Calculate simple target from first section just for visual status
                                            const loss = recipe ? (Object.values(recipe.sections || {})[0]?.processLossPct || 0) : 0;
                                            const target = 100 - loss;
                                            const diff = log.yieldPct - target;
                                            
                                            return (
                                                <tr key={log.id} className="hover:bg-gray-50">
                                                    <td className="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">
                                                        {formatDate(log.date)}
                                                    </td>
                                                    <td className="px-6 py-3 text-gray-700">
                                                        {recipeName}
                                                    </td>
                                                    <td className="px-6 py-3 text-right font-bold">
                                                        {log.yieldPct.toFixed(2)}%
                                                    </td>
                                                    <td className="px-6 py-3 text-center">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${Math.abs(diff) <= 5 ? 'bg-green-100 text-green-700' : (diff < -5 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')}`}>
                                                            {Math.abs(diff) <= 5 ? 'Dentro da Meta' : (diff < -5 ? 'Abaixo' : 'Acima')}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-3 text-right">
                                                        <button onClick={() => handleDeleteLog(log.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="Excluir Registro">
                                                            <Icon name="Trash2" size={16} />
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    ) : (
                                        <tr>
                                            <td colSpan="5" className="px-6 py-8 text-center text-gray-400 italic">
                                                Nenhum registro encontrado.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        }

        const SettingsView = ({ lines, setLines, stages, setStages, settings, setSettings, recipes, setRecipes, logs, setLogs, onError, showNotification }) => {
            const [newLine, setNewLine] = useState('');
            const [newStage, setNewStage] = useState('');
            const fileInputRef = useRef(null);
            const importInputRef = useRef(null);

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const logoBase64 = reader.result;
                        const color = await extractColor(logoBase64);
                        setSettings({ ...settings, logo: logoBase64, themeColor: color });
                        showNotification("Logo atualizada e tema ajustado!");
                    };
                    reader.readAsDataURL(file);
                }
            };

            const addLine = () => { if (!newLine) return; if (lines.includes(newLine)) { onError("Linha já existe"); return; } setLines([...lines, newLine]); setNewLine(''); };
            const removeLine = (l) => setLines(lines.filter(x => x !== l));
            const addStage = () => { if (!newStage) return; if (stages.includes(newStage)) { onError("Etapa já existe"); return; } setStages([...stages, newStage]); setNewStage(''); };
            const removeStage = (s) => setStages(stages.filter(x => x !== s));

            const handleExportData = () => {
                const dataStr = JSON.stringify({
                    recipes,
                    lines,
                    stages,
                    settings,
                    logs,
                    backupDate: new Date().toISOString()
                }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.download = `backup_producao_${new Date().toISOString().slice(0, 10)}.json`;
                link.href = url;
                link.click();
                showNotification("Backup exportado com sucesso!");
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validação simples para evitar carregar arquivo vazio ou inválido
                        if (!importedData || typeof importedData !== 'object') throw new Error("Arquivo inválido");

                        if (Array.isArray(importedData.recipes)) setRecipes(importedData.recipes);
                        if (Array.isArray(importedData.lines)) setLines(importedData.lines);
                        if (Array.isArray(importedData.stages)) setStages(importedData.stages);
                        if (importedData.settings) setSettings(importedData.settings);
                        if (Array.isArray(importedData.logs)) setLogs(importedData.logs);
                        
                        showNotification("Dados restaurados com sucesso!");
                    } catch (error) {
                        onError("Erro ao ler arquivo de backup. Verifique se é um JSON válido.");
                    }
                };
                reader.readAsText(file);
                e.target.value = null; // Reset input
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Personalização da Marca</h3>
                        <div className="flex items-center gap-6">
                            <div 
                                className="w-24 h-24 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 relative group cursor-pointer hover:border-primary transition-colors"
                                onClick={() => fileInputRef.current.click()}
                            >
                                {settings.logo ? <img src={settings.logo} className="w-full h-full object-contain" /> : <Icon name="Image" className="text-gray-400" size={32} />}
                                <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-medium">Alterar</div>
                            </div>
                            <div>
                                <p className="text-sm font-medium text-gray-700">Logo da Empresa</p>
                                <p className="text-xs text-gray-500 mt-1">O sistema irá extrair a cor da sua logo<br/>para personalizar o tema.</p>
                                <div className="flex items-center gap-2 mt-3">
                                    <span className="text-xs text-gray-500">Cor do Tema:</span>
                                    <div className="w-6 h-6 rounded-full border border-gray-200 shadow-sm" style={{ backgroundColor: settings.themeColor }}></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Gerenciamento de Dados</h3>
                        <p className="text-sm text-gray-500 mb-4">Faça backup de todos os seus dados (receitas, histórico, configurações) ou restaure de um arquivo anterior.</p>
                        <div className="flex gap-4">
                            <button onClick={handleExportData} className="flex items-center gap-2 px-4 py-2 bg-orange-50 text-primary border border-orange-100 rounded-lg hover:bg-orange-100 transition-colors font-medium text-sm">
                                <Icon name="Download" size={18} /> Exportar Backup (JSON)
                            </button>
                            <button onClick={() => importInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm">
                                <Icon name="Upload" size={18} /> Importar Backup
                            </button>
                            <input ref={importInputRef} type="file" accept=".json" className="hidden" onChange={handleImportData} />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Linhas de Produção</h3>
                            <div className="flex gap-2 mb-4"><input value={newLine} onChange={e => setNewLine(e.target.value)} placeholder="Nova linha..." className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" /><button onClick={addLine} className="bg-primary text-white px-3 rounded-lg"><Icon name="Plus" size={18}/></button></div>
                            <ul className="space-y-2">{lines.map(l => (<li key={l} className="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">{l}<button onClick={() => removeLine(l)} className="text-red-500"><Icon name="Trash2" size={16}/></button></li>))}</ul>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Etapas da Receita</h3>
                            <div className="flex gap-2 mb-4"><input value={newStage} onChange={e => setNewStage(e.target.value)} placeholder="Nova etapa..." className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" /><button onClick={addStage} className="bg-primary text-white px-3 rounded-lg"><Icon name="Plus" size={18}/></button></div>
                            <ul className="space-y-2">{stages.map(s => (<li key={s} className="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">{s}<button onClick={() => removeStage(s)} className="text-red-500"><Icon name="Trash2" size={16}/></button></li>))}</ul>
                        </div>
                    </div>
                </div>
            );
        };

        const RecipeDetails = ({ recipe, onEdit, onBack, onDelete }) => {
            const sections = useMemo(() => {
                const map = {};
                recipe.ingredients.forEach(ing => {
                    const sec = ing.section || 'Geral';
                    if (!map[sec]) map[sec] = [];
                    map[sec].push(ing);
                });
                return map;
            }, [recipe]);

            // Cálculo dos totais
            const totalStats = useMemo(() => {
                let grandTotalWeight = 0;
                let grandTotalLoss = 0;

                Object.keys(sections).forEach(sectionName => {
                    const sectionIngs = sections[sectionName];
                    const sectionConfig = recipe.sections?.[sectionName] || { processLossPct: 0 };
                    const isPkgStage = sectionName.toLowerCase().includes('embalagem');
                    
                    // Soma apenas se NÃO for embalagem (Item ou Etapa inteira)
                    const sectionWeight = sectionIngs.reduce((acc, i) => {
                        if (isPkgStage || isPackaging(i.name)) return acc;
                        return acc + toKg(i.qty, i.unit);
                    }, 0);

                    const sectionLoss = sectionWeight * (sectionConfig.processLossPct / 100);
                    
                    grandTotalWeight += sectionWeight;
                    grandTotalLoss += sectionLoss;
                });

                const finalWeight = grandTotalWeight - grandTotalLoss;
                const totalLossPct = grandTotalWeight > 0 ? (grandTotalLoss / grandTotalWeight) * 100 : 0;

                return { finalWeight, totalLossPct };
            }, [sections, recipe.sections]);

            // Cálculo de rendimento estimado em unidades/pacotes
            const estimatedOutput = useMemo(() => {
                if (recipe.outputType === 'unit' || recipe.outputType === 'package') {
                    const unitWeightKg = recipe.outputUnitMeasure === 'g' 
                        ? (recipe.outputUnitWeight / 1000) 
                        : recipe.outputUnitWeight;
                    
                    if (unitWeightKg > 0) {
                        return {
                            count: Math.floor(totalStats.finalWeight / unitWeightKg),
                            label: recipe.outputType === 'unit' ? 'Unidades' : 'Pacotes'
                        };
                    }
                }
                return null;
            }, [totalStats.finalWeight, recipe]);

            return (
                <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden animate-fade-in">
                    <div className="bg-orange-50 p-6 border-b border-orange-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <div className="flex items-center gap-2 mb-2">
                                <button onClick={onBack} className="text-gray-400 hover:text-primary transition-colors flex items-center gap-1 text-sm font-medium">
                                    <Icon name="ArrowLeft" size={16} /> Voltar
                                </button>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">{recipe.name}</h2>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="px-2 py-0.5 bg-orange-100 text-primary text-xs font-bold rounded-full uppercase tracking-wide">{recipe.line}</span>
                                <span className="text-gray-400 text-sm">• {recipe.ingredients.length} Ingredientes</span>
                                {recipe.lastUpdated && <span className="text-xs text-gray-400 ml-2">• Atualizado em {formatDate(recipe.lastUpdated)}</span>}
                            </div>
                            <div className="flex flex-wrap gap-2 mt-3">
                                {recipe.outputType === 'unit' && (
                                    <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <Icon name="Box" size={12} />
                                        Vendido por Unidade ({recipe.outputUnitWeight} {recipe.outputUnitMeasure})
                                    </span>
                                )}
                                {recipe.outputType === 'package' && (
                                    <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        <Icon name="Box" size={12} />
                                        Vendido por Pacote ({recipe.outputUnitWeight} {recipe.outputUnitMeasure})
                                    </span>
                                )}
                                {(!recipe.outputType || recipe.outputType === 'kg') && (
                                    <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <Icon name="Scale" size={12} />
                                        Vendido a Granel (Kg)
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => onDelete(recipe.id)} className="px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 flex items-center gap-2">
                                <Icon name="Trash2" size={16} /> Excluir
                            </button>
                            <button onClick={() => onEdit(recipe)} className="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover-bg-primary flex items-center gap-2 shadow-sm">
                                <Icon name="Edit" size={16} /> Editar Receita
                            </button>
                        </div>
                    </div>

                    <div className="p-6 space-y-8">
                        {/* --- Loop de Seções com Visualização de Meta vs Real --- */}
                        {Object.keys(sections).map(sectionName => {
                            const sectionIngs = sections[sectionName];
                            const sectionConfig = recipe.sections?.[sectionName] || { processLossPct: 0, tolerancePct: 10, targetSharePct: 0 };
                            const isPkgStage = sectionName.toLowerCase().includes('embalagem');
                            
                            // Soma peso da seção ignorando embalagens
                            const totalWeight = sectionIngs.reduce((acc, i) => {
                                if (isPkgStage || isPackaging(i.name)) return acc;
                                return acc + toKg(i.qty, i.unit);
                            }, 0);

                            const netWeight = totalWeight * (1 - (sectionConfig.processLossPct / 100));
                            const actualShare = totalStats.finalWeight > 0 ? (netWeight / totalStats.finalWeight) * 100 : 0;
                            const targetShare = parseFloat(sectionConfig.targetSharePct) || 0;
                            
                            const diff = actualShare - targetShare;
                            const statusColor = Math.abs(diff) < 1.0 ? 'bg-emerald-500' : (diff > 0 ? 'bg-blue-500' : 'bg-orange-500');

                            // --- NOVO: Cálculo de Sugestão de Correção ---
                            let suggestionText = null;
                            const targetFraction = targetShare / 100;

                            if (targetShare > 0 && totalStats.finalWeight > 0) {
                                const otherMass = totalStats.finalWeight - netWeight;
                                // Prevent division by zero if target is 100%
                                if (targetFraction < 1) {
                                    const idealWeight = (targetFraction * otherMass) / (1 - targetFraction);
                                    const weightDiff = idealWeight - netWeight;
                                    
                                    if (Math.abs(weightDiff) > 0.001) { // Threshold de 1g
                                         const action = weightDiff > 0 ? "Adicionar" : "Reduzir";
                                         const cssClass = weightDiff > 0 ? "text-blue-600" : "text-orange-600";
                                         suggestionText = (
                                             <span className={`text-[10px] font-bold ${cssClass} mt-1 block flex items-center gap-1`}>
                                                <Icon name="Info" size={10} />
                                                Sugestão: {action} {Math.abs(weightDiff).toFixed(3)} kg para atingir a meta
                                             </span>
                                         );
                                    }
                                }
                            }

                            return (
                                <div key={sectionName} className="border border-gray-200 rounded-xl overflow-hidden">
                                    <div className="bg-orange-50 px-4 py-3 border-b border-orange-100 flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div className="flex items-center gap-3 w-full md:w-auto">
                                            <h3 className="font-bold text-gray-700 flex items-center gap-2 whitespace-nowrap">
                                                <div className="w-2 h-6 bg-primary rounded-full"></div>
                                                {sectionName}
                                                {isPkgStage && <span className="text-[10px] bg-white border border-orange-200 px-2 rounded-full text-orange-400 font-normal">Não conta no peso</span>}
                                            </h3>
                                        </div>

                                        {/* --- Barra de Progresso Comparativa (Meta vs Real) --- */}
                                        {!isPkgStage && totalStats.finalWeight > 0 && (
                                            <div className="flex-1 w-full md:mx-8">
                                                <div className="flex justify-between text-[10px] uppercase font-bold text-gray-500 mb-1">
                                                    <span>Real: {actualShare.toFixed(1)}%</span>
                                                    <span>Meta: {targetShare.toFixed(1)}%</span>
                                                </div>
                                                <div className="relative h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    {/* Marcador de Meta */}
                                                    {targetShare > 0 && (
                                                        <div className="absolute top-0 bottom-0 w-0.5 bg-black z-20" style={{ left: `${Math.min(targetShare, 100)}%` }} title={`Meta: ${targetShare}%`}></div>
                                                    )}
                                                    {/* Barra de Valor Real */}
                                                    <div className={`h-full ${statusColor} z-10 transition-all duration-500`} style={{width: `${Math.min(actualShare, 100)}%`}}></div>
                                                </div>
                                                {/* Exibe a sugestão de correção aqui */}
                                                {suggestionText}
                                            </div>
                                        )}

                                        <div className="flex gap-4 text-xs whitespace-nowrap">
                                            <div className="flex flex-col items-end">
                                                <span className="text-gray-500 uppercase font-bold text-[10px]">Perda Teórica</span>
                                                <span className="font-bold text-gray-700">{sectionConfig.processLossPct}%</span>
                                            </div>
                                            <div className="flex flex-col items-end">
                                                <span className="text-gray-500 uppercase font-bold text-[10px]">Tolerância</span>
                                                <span className="font-bold text-gray-700">± {sectionConfig.tolerancePct}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="divide-y divide-gray-100">
                                        {sectionIngs.map((ing, idx) => (
                                            <div key={idx} className="px-4 py-3 flex justify-between items-center hover:bg-gray-50 transition-colors">
                                                <div className="font-medium text-gray-700 flex flex-col">
                                                    <span>{ing.name}</span>
                                                    {(isPkgStage || isPackaging(ing.name)) && <span className="text-[10px] text-gray-400 uppercase tracking-wide">Item de Embalagem (Não pesa)</span>}
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <div className="text-right">
                                                        <span className={`font-bold ${(isPkgStage || isPackaging(ing.name)) ? 'text-gray-400' : 'text-gray-800'}`}>{parseFloat(ing.qty).toFixed(3)}</span> <span className="text-xs text-gray-500">{ing.unit}</span>
                                                    </div>
                                                    
                                                    {ing.fixedQty > 0 && (
                                                        <div className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 font-medium whitespace-nowrap">
                                                            + {parseFloat(ing.fixedQty)} {ing.unit} (Startup)
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="bg-orange-50/50 px-4 py-3 border-t border-orange-100 flex justify-between items-center text-sm">
                                        <span className="font-bold text-orange-800">Peso Bruto da Etapa</span>
                                        <span className="font-bold text-orange-800">{totalWeight.toFixed(3)} kg</span>
                                    </div>
                                </div>
                            );
                        })}

                        {/* Novo Bloco de Totais Gerais */}
                        <div className="mt-8 border-t-2 border-gray-100 pt-6">
                            <div className="bg-gray-50 rounded-xl p-6 border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="BarChart3" className="text-primary" /> 
                                    Resumo Final do Processo
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col justify-between items-start">
                                        <div>
                                            <p className="text-sm text-gray-500 font-medium">Peso Final Estimado</p>
                                            <p className="text-xs text-gray-400">Produto Acabado</p>
                                        </div>
                                        <div className="text-right w-full mt-2">
                                            <span className="text-2xl font-bold text-emerald-600">{totalStats.finalWeight.toFixed(3)}</span>
                                            <span className="text-sm text-gray-500 ml-1">kg</span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col justify-between items-start">
                                        <div>
                                            <p className="text-sm text-gray-500 font-medium">Perda Total do Processo</p>
                                            <p className="text-xs text-gray-400">Quebra Acumulada</p>
                                        </div>
                                        <div className="text-right w-full mt-2">
                                            <span className="text-2xl font-bold text-red-500">{totalStats.totalLossPct.toFixed(2)}</span>
                                            <span className="text-sm text-gray-500 ml-1">%</span>
                                        </div>
                                    </div>
                                    {estimatedOutput && (
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 shadow-sm flex flex-col justify-between items-start">
                                            <div>
                                                <p className="text-sm text-blue-600 font-medium">Rendimento em {estimatedOutput.label}</p>
                                                <p className="text-xs text-blue-400">Baseado no peso unitário</p>
                                            </div>
                                            <div className="text-right w-full mt-2">
                                                <span className="text-2xl font-bold text-blue-700">{estimatedOutput.count}</span>
                                                <span className="text-sm text-blue-500 ml-1">{estimatedOutput.label}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="flex items-start gap-3 bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                            <Icon name="Info" className="text-blue-500 mt-0.5" />
                            <p>Esta é a ficha técnica oficial. Utilize a aba "Produção" para gerar ordens de serviço escalonadas ou "Monitoramento" para lançar dados reais de chão de fábrica.</p>
                        </div>
                    </div>
                </div>
            );
        };

        const RecipeList = ({ recipes, lines, onCreate, onView, onImport, onBooklet }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterLine, setFilterLine] = useState('');
            const [sortOrder, setSortOrder] = useState('updated'); // 'name', 'updated'
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => { 
                if (e.target.files && e.target.files.length > 0) { 
                    onImport(e.target.files); 
                    e.target.value = null; 
                } 
            };

            const filteredAndSortedRecipes = useMemo(() => {
                let r = recipes;
                // Filtro por Nome
                if (searchTerm) {
                    r = r.filter(recipe => recipe.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }
                // Filtro por Linha
                if (filterLine) {
                    r = r.filter(recipe => recipe.line === filterLine);
                }
                // Ordenação
                return [...r].sort((a, b) => {
                    if (sortOrder === 'name') {
                        return a.name.localeCompare(b.name);
                    } else if (sortOrder === 'updated') {
                        // Data mais recente primeiro. Se não tiver data, vai para o fim.
                        const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
                        const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
                        return dateB - dateA;
                    }
                    return 0;
                });
            }, [recipes, searchTerm, filterLine, sortOrder]);

            return (
                <div className="space-y-6">
                    {/* Header de Controle */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="ChefHat" className="text-primary" /> 
                                Catálogo de Receitas
                            </h2>
                            <div className="flex gap-2">
                                <button onClick={onBooklet} className="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-50 flex items-center gap-2 shadow-sm whitespace-nowrap transition-colors">
                                    <Icon name="Book" size={16} /> Imprimir Livreto
                                </button>
                                <button onClick={onCreate} className="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-primary-dark flex items-center gap-2 shadow-sm whitespace-nowrap transition-colors">
                                    <Icon name="Plus" size={16} /> Nova Receita
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row gap-4">
                            {/* Barra de Busca */}
                            <div className="flex-1 relative">
                                <div className="absolute left-3 top-2.5 text-gray-400">
                                    <Icon name="Search" size={18} />
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar receita pelo nome..." 
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>

                            {/* Filtros e Ordenação */}
                            <div className="flex gap-2 flex-wrap md:flex-nowrap">
                                <div className="w-48">
                                    <SearchableSelect 
                                        options={[{label: 'Todas as Linhas', value: ''}, ...lines.map(l => ({label: l, value: l}))]} 
                                        value={filterLine} 
                                        onChange={setFilterLine} 
                                        placeholder="Filtrar por Linha" 
                                    />
                                </div>
                                <select 
                                    value={sortOrder} 
                                    onChange={(e) => setSortOrder(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 outline-none focus:border-orange-500 cursor-pointer"
                                >
                                    <option value="updated">Mais Recentes</option>
                                    <option value="name">A - Z</option>
                                </select>
                                <button 
                                    onClick={() => fileInputRef.current.click()} 
                                    className="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600"
                                    title="Importar Excel"
                                >
                                    <Icon name="Upload" size={18} />
                                </button>
                                {/* Atributo multiple adicionado para permitir selecionar vários arquivos */}
                                <input type="file" accept=".xlsx, .xls, .csv" multiple ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                            </div>
                        </div>
                    </div>

                    {/* Grid de Cards - Estilo Livro/Fichário */}
                    {filteredAndSortedRecipes.length === 0 ? (
                        <div className="p-12 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                            <Icon name="Search" size={48} className="mx-auto mb-3 text-gray-200" />
                            <p>Nenhuma receita encontrada com esses critérios.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {filteredAndSortedRecipes.map(recipe => (
                                <div 
                                    key={recipe.id} 
                                    onClick={() => onView(recipe)}
                                    className="group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-xl hover:border-orange-300 transition-all duration-300 cursor-pointer flex flex-col h-full relative overflow-hidden"
                                >
                                    {/* Faixa decorativa lateral (lombada do livro) */}
                                    <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-orange-300 to-orange-500 group-hover:w-2 transition-all"></div>
                                    
                                    <div className="p-5 flex flex-col h-full pl-6">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="text-[10px] font-bold uppercase tracking-wider text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100">
                                                {recipe.line}
                                            </span>
                                        </div>
                                        
                                        <h3 className="font-bold text-gray-800 text-lg leading-tight mb-2 group-hover:text-primary transition-colors line-clamp-2">
                                            {recipe.name}
                                        </h3>
                                        
                                        <div className="mt-auto pt-4 border-t border-gray-100 w-full">
                                            <div className="flex justify-between items-center text-xs text-gray-500">
                                                <div className="flex items-center gap-1">
                                                    <Icon name="Box" size={14} /> 
                                                    <span>{recipe.ingredients.length} itens</span>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-2 text-[10px] text-gray-400 flex items-center gap-1 italic">
                                                <Icon name="Edit" size={10} />
                                                {recipe.lastUpdated ? `Atualizado em ${formatDate(recipe.lastUpdated)}` : 'Sem data de edição'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const RecipeEditor = ({ recipe, lines, stages, onSave, onCancel, onError }) => {
            const safeRecipe = { ...recipe, ingredients: recipe.ingredients.map(i => ({...i, section: i.section || stages[0], fixedQty: i.fixedQty || 0 })), sections: recipe.sections || {} };
            const [form, setForm] = useState(safeRecipe);
            const updateField = (field, value) => setForm({ ...form, [field]: value });
            const updateIngredient = (idx, field, value) => { const newIngs = [...form.ingredients]; newIngs[idx][field] = value; setForm({ ...form, ingredients: newIngs }); };
            const addIngredient = (sectionName) => { setForm({ ...form, ingredients: [...form.ingredients, { name: '', qty: 0, unit: 'g', lossPct: 0, section: sectionName, fixedQty: 0 }] }); };
            const removeIngredient = (idx) => { const newIngs = form.ingredients.filter((_, i) => i !== idx); setForm({ ...form, ingredients: newIngs }); };
            
            // Atualiza campos específicos da seção (tolerancePct, targetSharePct, etc)
            const updateSectionConfig = (sectionName, field, value) => { 
                setForm({ 
                    ...form, 
                    sections: { 
                        ...form.sections, 
                        [sectionName]: { 
                            ...form.sections?.[sectionName], 
                            [field]: value 
                        } 
                    } 
                }); 
            };

            const calculateSectionData = (sectionName) => {
                const sectionIngs = form.ingredients.filter(i => (i.section || stages[0]) === sectionName);
                const totalInputWeightKg = sectionIngs.reduce((acc, curr) => acc + toKg(curr.qty, curr.unit), 0);
                const lossPct = form.sections?.[sectionName]?.processLossPct || 0;
                const theoreticalYieldKg = totalInputWeightKg * (1 - (lossPct/100));
                return { totalInputWeightKg, theoreticalYieldKg };
            };

            const handleYieldChange = (sectionName, newYieldKg) => {
                const { totalInputWeightKg } = calculateSectionData(sectionName);
                if (totalInputWeightKg === 0) return;
                let newLossPct = ((totalInputWeightKg - newYieldKg) / totalInputWeightKg) * 100;
                if (newLossPct < 0) newLossPct = 0;
                setForm({ ...form, sections: { ...form.sections, [sectionName]: { ...form.sections?.[sectionName], processLossPct: newLossPct } } });
            };

            const activeSections = Array.from(new Set(form.ingredients.map(i => i.section || stages[0])));
            useEffect(() => {
                const newSections = { ...form.sections };
                let changed = false;
                activeSections.forEach(s => { 
                    if (!newSections[s]) { 
                        newSections[s] = { processLossPct: 0, tolerancePct: 10, targetSharePct: 0 }; 
                        changed = true; 
                    } 
                });
                if (changed) setForm(prev => ({ ...prev, sections: newSections }));
            }, [activeSections.length]);

            // Cálculo do total das metas para validação visual
            const totalTargetShare = activeSections.reduce((sum, s) => {
                return sum + (parseFloat(form.sections?.[s]?.targetSharePct) || 0);
            }, 0);

            const handleSubmit = (e) => {
                e.preventDefault();
                if(!form.name || !form.line) { onError("Preencha o nome da receita e a linha."); return; }
                if(form.ingredients.length === 0) { onError("Adicione pelo menos um ingrediente."); return; }
                onSave(form);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-gray-200 p-6 max-w-4xl mx-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{form.id ? 'Editar Receita' : 'Nova Receita'}</h2>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Nome da Receita</label><input required type="text" value={form.name} onChange={e => updateField('name', e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Ex: Bolo de Chocolate" /></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">Linha de Produção</label><div className="w-full"><SearchableSelect options={lines} value={form.line} onChange={(val) => updateField('line', val)} placeholder="Selecione a Linha" /></div></div>
                        </div>

                        {/* Configuração de Unidade de Saída */}
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 className="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                                <Icon name="Box" size={16} /> Definição do Produto Final
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Formato de Saída</label>
                                    <select 
                                        value={form.outputType || 'kg'} 
                                        onChange={e => updateField('outputType', e.target.value)}
                                        className="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"
                                    >
                                        <option value="kg">Kg (Granel)</option>
                                        <option value="unit">Unidades (un)</option>
                                        <option value="package">Pacotes/Caixas</option>
                                    </select>
                                </div>
                                {(form.outputType === 'unit' || form.outputType === 'package') && (
                                    <React.Fragment>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">
                                                {form.outputType === 'unit' ? 'Peso Médio Unitário' : 'Peso Líquido do Pacote'}
                                            </label>
                                            <div className="flex items-center gap-2">
                                                <input 
                                                    type="number" step="0.001" onWheel={(e) => e.target.blur()}
                                                    value={form.outputUnitWeight || ''} 
                                                    onChange={e => updateField('outputUnitWeight', e.target.value)}
                                                    className="w-full p-2 border border-blue-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
                                                    placeholder="0.000"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">Unidade de Medida</label>
                                            <select 
                                                value={form.outputUnitMeasure || 'g'} 
                                                onChange={e => updateField('outputUnitMeasure', e.target.value)}
                                                className="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"
                                            >
                                                <option value="g">Gramas (g)</option>
                                                <option value="kg">Quilos (kg)</option>
                                            </select>
                                        </div>
                                    </React.Fragment>
                                )}
                            </div>
                        </div>

                        <div className="space-y-6">
                            {activeSections.map((secName) => {
                                const { totalInputWeightKg, theoreticalYieldKg } = calculateSectionData(secName);
                                return (
                                    <div key={secName} className="border border-gray-200 rounded-lg overflow-hidden">
                                        <div className="bg-orange-50 p-3 border-b border-orange-200">
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                                <div className="flex items-center gap-3">
                                                    <h3 className="font-bold text-gray-700">{secName}</h3>
                                                </div>
                                                
                                                <div className="flex gap-4">
                                                    {/* INPUT DE META POR ETAPA */}
                                                    <div className="flex flex-col items-end">
                                                        <span className="text-[10px] font-bold text-gray-500 uppercase">Meta % Final</span>
                                                        <div className="flex items-center bg-white px-2 py-1 rounded border border-gray-300 w-24">
                                                            <input 
                                                                type="number" 
                                                                step="0.1"
                                                                placeholder="0"
                                                                onWheel={(e) => e.target.blur()} 
                                                                className="w-full text-xs font-bold text-right outline-none text-blue-600" 
                                                                value={form.sections?.[secName]?.targetSharePct || ''} 
                                                                onChange={(e) => updateSectionConfig(secName, 'targetSharePct', parseFloat(e.target.value))} 
                                                            />
                                                            <span className="text-xs text-gray-400 ml-1">%</span>
                                                        </div>
                                                    </div>

                                                    <div className="flex flex-col items-end">
                                                        <span className="text-[10px] font-bold text-gray-500 uppercase">Tolerância</span>
                                                        <div className="flex items-center bg-white px-2 py-1 rounded border border-gray-300 w-20">
                                                            <span className="text-xs text-gray-400 mr-1">±</span>
                                                            <input 
                                                                type="number" 
                                                                onWheel={(e) => e.target.blur()} 
                                                                className="w-full text-xs font-bold text-center outline-none" 
                                                                value={form.sections?.[secName]?.tolerancePct || 10} 
                                                                onChange={(e) => updateSectionConfig(secName, 'tolerancePct', parseFloat(e.target.value))} 
                                                            />
                                                            <span className="text-xs text-gray-400 ml-1">%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="p-3 bg-white space-y-3">
                                            <div className="hidden md:flex gap-2 px-1 text-[10px] font-bold text-gray-500 uppercase"><div className="flex-grow">Ingrediente</div><div className="w-24">Qtd (1 un)</div><div className="w-16">Und</div><div className="w-20 text-blue-500">Startup*</div><div className="w-8"></div></div>
                                            {form.ingredients.map((ing, idx) => {
                                                if ((ing.section || stages[0]) !== secName) return null;
                                                return (
                                                    <div key={idx} className="flex flex-wrap md:flex-nowrap gap-2 items-center">
                                                        <div className="flex-grow w-full md:w-auto"><input required placeholder="Nome do Ingrediente" value={ing.name} onChange={e => updateIngredient(idx, 'name', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm" /></div>
                                                        <div className="w-1/2 md:w-24"><input required type="number" step="0.0001" onWheel={(e) => e.target.blur()} placeholder="Qtd" value={ing.qty} onChange={e => updateIngredient(idx, 'qty', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm" /></div>
                                                        <div className="w-1/2 md:w-16"><select value={ing.unit} onChange={e => updateIngredient(idx, 'unit', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="un">un</option></select></div>
                                                        
                                                        {/* CAMPO NOVO: QTD FIXA */}
                                                        <div className="w-full md:w-20 relative" title="Quantidade Fixa de Partida (Startup) - Adicionada uma única vez ao total da ordem">
                                                            <input type="number" step="0.0001" onWheel={(e) => e.target.blur()} placeholder="Fixo" value={ing.fixedQty || 0} onChange={e => updateIngredient(idx, 'fixedQty', e.target.value)} className="w-full p-2 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700 font-medium" />
                                                        </div>

                                                        <button type="button" onClick={() => removeIngredient(idx)} className="text-gray-400 hover:text-red-500 p-2"><Icon name="Trash2" size={16} /></button>
                                                    </div>
                                                );
                                            })}
                                            <div className="pt-2"><button type="button" onClick={() => addIngredient(secName)} className="text-sm text-white bg-orange-500 px-3 py-1 rounded hover:bg-orange-600 flex items-center gap-1 shadow-sm"><Icon name="Plus" size={14}/> Adicionar Item em {secName}</button></div>
                                        </div>
                                        <div className="bg-orange-50 p-4 border-t border-orange-100 flex flex-col md:flex-row gap-4 items-center justify-between">
                                            <div className="text-sm text-orange-800"><span className="block text-xs text-orange-500 uppercase font-bold">Peso Total Ingredientes (Entrada)</span><span className="font-bold text-lg">{totalInputWeightKg.toFixed(3)} <small>kg</small></span></div>
                                            <div className="flex items-center gap-2"><Icon name="ArrowRight" className="text-orange-300 hidden md:block" /></div>
                                            <div>
                                                <label className="block text-xs text-orange-500 uppercase font-bold mb-1">Peso Final Teórico (Saída)</label>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" step="0.0001" onWheel={(e) => e.target.blur()} value={parseFloat(theoreticalYieldKg.toFixed(3))} onChange={(e) => handleYieldChange(secName, parseFloat(e.target.value))} className="w-32 p-2 border border-orange-300 rounded-lg text-orange-900 font-bold text-right" /><span className="text-sm text-orange-700">kg</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            {activeSections.length < stages.length && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 text-center">
                                    <p className="text-sm text-gray-500 mb-2">Adicionar nova etapa à receita:</p>
                                    <div className="flex justify-center gap-2 flex-wrap">{stages.filter(s => !activeSections.includes(s)).map(s => (<button key={s} type="button" onClick={() => addIngredient(s)} className="text-xs bg-white border border-gray-300 px-3 py-1 rounded-full hover:bg-orange-50 hover:text-orange-600 transition-colors">+ {s}</button>))}</div>
                                </div>
                            )}
                        </div>

                        {/* RODAPÉ COM TOTALIZADOR DE METAS */}
                        <div className={`p-4 rounded-lg border flex justify-between items-center ${Math.abs(totalTargetShare - 100) < 1 ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                            <span className="text-sm font-bold">Total das Metas: {totalTargetShare.toFixed(1)}%</span>
                            {Math.abs(totalTargetShare - 100) >= 1 && <span className="text-xs">Ajuste as metas para somar 100%</span>}
                            {Math.abs(totalTargetShare - 100) < 1 && <span className="text-xs flex items-center gap-1"><Icon name="CheckCircle" size={14}/> Balanceado</span>}
                        </div>

                        <div className="flex justify-end gap-3 pt-4"><button type="button" onClick={onCancel} className="px-6 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg">Cancelar</button><button type="submit" className="px-6 py-2 bg-primary text-white font-medium hover-bg-primary rounded-lg shadow-sm">Salvar Receita</button></div>
                    </form>
                </div>
            );
        };

        const ProductionOrders = ({ recipes, lines, onError }) => {
            const [selectedLine, setSelectedLine] = useState('');
            const [selectedRecipeId, setSelectedRecipeId] = useState('');
            const [mode, setMode] = useState('batch'); // 'batch', 'target', 'proportional'
            const [inputValue, setInputValue] = useState(1);
            const [basisItem, setBasisItem] = useState(''); // "SECTION:Massa" or "ING:Farinha"

            const filteredRecipes = useMemo(() => {
                if (!selectedLine) return recipes;
                return recipes.filter(r => r.line === selectedLine);
            }, [recipes, selectedLine]);

            const selectedRecipe = useMemo(() => recipes.find(r => r.id == selectedRecipeId), [recipes, selectedRecipeId]);

            const basisOptions = useMemo(() => {
                if (!selectedRecipe) return [];
                const opts = [];
                const sections = Array.from(new Set(selectedRecipe.ingredients.map(i => i.section || 'Geral')));
                sections.forEach(s => opts.push({ label: `[ETAPA] ${s}`, value: `SECTION:${s}` }));
                selectedRecipe.ingredients.forEach(i => opts.push({ label: `[ING] ${i.name}`, value: `ING:${i.name}:${i.section}` }));
                return opts;
            }, [selectedRecipe]);

            const calculation = useMemo(() => {
                if (!selectedRecipe) return null;

                const ingredientsBySection = {};
                selectedRecipe.ingredients.forEach(ing => {
                    const sec = ing.section || "Outros";
                    if (!ingredientsBySection[sec]) ingredientsBySection[sec] = [];
                    ingredientsBySection[sec].push(ing);
                });

                const sectionsData = {};
                let totalNetYieldKg = 0;

                Object.keys(ingredientsBySection).forEach(secName => {
                    const sectionIngs = ingredientsBySection[secName];
                    const sectionLossPct = selectedRecipe.sections?.[secName]?.processLossPct || 0;
                    const isPkgStage = secName.toLowerCase().includes('embalagem');
                    
                    // Calcula peso base ignorando embalagens (Item ou Etapa inteira)
                    // NOTA: O peso fixo NÃO entra no cálculo de rendimento unitário da receita, ele é custo de setup
                    const sectionBaseWeightKg = sectionIngs.reduce((acc, curr) => {
                        if (isPkgStage || isPackaging(curr.name)) return acc;
                        return acc + toKg(curr.qty, curr.unit);
                    }, 0);

                    const sectionYieldKg = sectionBaseWeightKg * (1 - (sectionLossPct / 100));

                    sectionsData[secName] = {
                        baseWeightKg: sectionBaseWeightKg,
                        yieldKg: sectionYieldKg,
                        lossPct: sectionLossPct,
                        ingredients: sectionIngs
                    };
                    totalNetYieldKg += sectionYieldKg;
                });
                
                let factor = 1;
                let targetBatches = 0;
                let referenceLabel = "Padrão";

                if (mode === 'batch') {
                    factor = parseFloat(inputValue) || 0;
                    targetBatches = factor;
                    referenceLabel = `${factor} Receitas`;
                } else if (mode === 'target') {
                    const targetKg = (parseFloat(inputValue) || 0);
                    if (totalNetYieldKg > 0) factor = targetKg / totalNetYieldKg;
                    targetBatches = factor;
                    referenceLabel = `Meta: ${targetKg}kg Produto Final`;
                } else if (mode === 'proportional' && basisItem) {
                    const [type, name, sec] = basisItem.split(':');
                    const targetQty = parseFloat(inputValue) || 0;
                    let baseQty = 0;

                    if (type === 'SECTION') {
                        if (sectionsData[name]) {
                            // CORREÇÃO: Usar o peso líquido (yieldKg) como base, pois o usuário informa o que sobrou (pronto)
                            baseQty = sectionsData[name].yieldKg;
                        }
                    } else if (type === 'ING') {
                        const ing = selectedRecipe.ingredients.find(i => i.name === name && (i.section || 'Geral') === (sec || 'Geral'));
                        // Se basear cálculo num item de embalagem, usa a quantidade nominal
                        if (ing) baseQty = toKg(ing.qty, ing.unit);
                    }

                    if (baseQty > 0) {
                        factor = targetQty / baseQty;
                        targetBatches = factor;
                        referenceLabel = `Base: ${targetQty}kg de ${name}`;
                    }
                }

                const finalSections = [];
                let grandTotalGrossKg = 0;

                Object.keys(sectionsData).forEach(secName => {
                    const data = sectionsData[secName];
                    const isPkgStage = secName.toLowerCase().includes('embalagem');

                    const scaledIngs = data.ingredients.map(ing => {
                        const variableQty = ing.qty * factor;
                        const fixedQty = parseFloat(ing.fixedQty || 0);
                        const totalReqOriginalUnit = variableQty + fixedQty;
                        const weightInKg = toKg(ing.qty, ing.unit);
                        const totalReqKg = toKg(totalReqOriginalUnit, ing.unit);
                        const cleanLossPct = parseFloat(ing.lossPct) || 0;
                        
                        // Itens de embalagem não sofrem perda de processo (quebra técnica) no cálculo de necessidade bruta
                        // Apenas itens comestíveis sofrem perda
                        // Se a etapa inteira for embalagem, tudo conta como embalagem
                        const isPack = isPkgStage || isPackaging(ing.name);
                        const grossReqKg = (cleanLossPct >= 100 || isPack) ? totalReqKg : totalReqKg / (1 - (cleanLossPct/100));
                        
                        return {
                            ...ing,
                            calcNet: totalReqOriginalUnit,
                            calcGrossKg: grossReqKg,
                            isPackaging: isPack,
                            variablePart: variableQty,
                            fixedPart: fixedQty
                        };
                    });

                    // Soma apenas itens não-embalagem para o peso da seção
                    const sectionTotalGrossKg = scaledIngs.reduce((sum, i) => {
                        if (i.isPackaging) return sum;
                        return sum + i.calcGrossKg;
                    }, 0);

                    // O Peso final esperado da seção é baseado no output dos lotes + o que sobrou do fixo (se sobrar)
                    const sectionFinalWeightKg = (data.yieldKg * factor) + (scaledIngs.reduce((acc, i) => acc + toKg(i.fixedPart, i.unit), 0) * (1 - (data.lossPct/100)));
                    
                    grandTotalGrossKg += sectionTotalGrossKg;

                    finalSections.push({
                        name: secName,
                        processLossPct: data.lossPct,
                        ingredients: scaledIngs,
                        finalWeightKg: sectionFinalWeightKg
                    });
                });

                const finalProductWeightKg = finalSections.reduce((acc, sec) => acc + sec.finalWeightKg, 0);

                // --- NOVO: Cálculo de Rendimento em Unidades/Pacotes ---
                let finalUnitCount = 0;
                let unitLabel = '';

                if (selectedRecipe.outputType === 'unit' || selectedRecipe.outputType === 'package') {
                    const weightInKg = selectedRecipe.outputUnitMeasure === 'g' 
                        ? (selectedRecipe.outputUnitWeight / 1000) 
                        : selectedRecipe.outputUnitWeight;
                    
                    if (weightInKg > 0) {
                        finalUnitCount = finalProductWeightKg / weightInKg;
                        unitLabel = selectedRecipe.outputType === 'unit' ? 'Unidades' : 'Pacotes';
                    }
                }

                return {
                    factor,
                    targetBatches,
                    referenceLabel,
                    sections: finalSections,
                    totalGrossKg: grandTotalGrossKg,
                    finalProductWeightKg,
                    finalUnitCount,
                    unitLabel
                };

            }, [selectedRecipe, mode, inputValue, basisItem]);

            const logoSrc = useMemo(() => {
                const saved = localStorage.getItem('prod_settings');
                if(saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        return parsed.logo;
                    } catch(e) { return null; }
                }
                return null;
            }, []);

            return (
                // REMOVIDO: overflow-hidden que estava cortando a lista suspensa
                <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div className="p-6 border-b border-gray-100 no-print">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icon name="ClipboardList" className="text-primary" /> 
                            Gerar Ordem de Produção
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Linha de Produção</label>
                                <div className="w-full">
                                    <SearchableSelect 
                                        options={[{label: 'Todas as Linhas', value: ''}, ...lines.map(l => ({label: l, value: l}))]}
                                        value={selectedLine}
                                        onChange={(val) => { setSelectedLine(val); setSelectedRecipeId(''); }}
                                        placeholder="Filtrar Linha"
                                    />
                                </div>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Selecione a Receita</label>
                                <div className="w-full">
                                    <SearchableSelect 
                                        options={filteredRecipes.map(r => ({label: r.name, value: r.id}))}
                                        value={selectedRecipeId}
                                        onChange={setSelectedRecipeId}
                                        placeholder="Buscar Receita"
                                        disabled={filteredRecipes.length === 0}
                                    />
                                </div>
                            </div>
                        </div>

                        {selectedRecipe && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="flex flex-col gap-4">
                                    <div className="flex bg-white rounded-lg p-1 border border-gray-200 overflow-x-auto">
                                        <button onClick={() => setMode('batch')} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors whitespace-nowrap ${mode === 'batch' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:bg-gray-100'}`}>Por Receitas</button>
                                        <button onClick={() => setMode('target')} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors whitespace-nowrap ${mode === 'target' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:bg-gray-100'}`}>Peso Final Total</button>
                                        <button onClick={() => setMode('proportional')} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors whitespace-nowrap ${mode === 'proportional' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:bg-gray-100'}`}>Proporcional (Item)</button>
                                    </div>
                                    
                                    <div className="flex flex-col md:flex-row gap-4 items-end">
                                        {mode === 'proportional' && (
                                            <div className="flex-1 w-full">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Basear cálculo em:</label>
                                                <SearchableSelect 
                                                    options={basisOptions}
                                                    value={basisItem}
                                                    onChange={setBasisItem}
                                                    placeholder="Ex: Massa, Farinha..."
                                                />
                                            </div>
                                        )}
                                        
                                        <div className="flex-1 w-full">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                {mode === 'batch' ? 'Número de Receitas' : 
                                                mode === 'target' ? 'Quantidade Final Desejada (Kg)' :
                                                'Quantidade que você tem (Kg)'}
                                            </label>
                                            <input type="number" min="0" step="0.01" placeholder="0.00" onWheel={(e) => e.target.blur()} value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-lg font-bold text-gray-800" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {calculation && (
                        <div className="p-6 bg-gray-50/30">
                            <div className="print-header print-only hidden">
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    {logoSrc && <img src={logoSrc} alt="Logo" style={{ height: '50px', objectFit: 'contain' }} />}
                                    <div>
                                        <h1 style={{ margin: 0, fontSize: '18px', fontWeight: 'bold' }}>ORDEM DE PRODUÇÃO</h1>
                                        <p style={{ margin: 0, fontSize: '12px' }}>{selectedRecipe.name}</p>
                                    </div>
                                </div>
                                <div style={{ textAlign: 'right', fontSize: '12px' }}>
                                    <p style={{ margin: 0 }}>Data: {new Date().toLocaleDateString()}</p>
                                    <p style={{ margin: 0 }}>Ref: {calculation.referenceLabel}</p>
                                    <p style={{ margin: 0, fontWeight: 'bold' }}>Receitas Equivalentes: {calculation.targetBatches.toFixed(3)}</p>
                                </div>
                            </div>

                            <div className="mb-6 flex flex-wrap gap-4 justify-between items-center bg-white p-4 rounded-lg border border-gray-200 shadow-sm no-print">
                                <div>
                                    <p className="text-sm text-gray-500">Ref. Cálculo</p>
                                    <p className="text-lg font-bold text-gray-800">{calculation.referenceLabel}</p>
                                </div>
                                
                                <div className="text-center bg-orange-50 px-4 py-2 rounded-lg border border-orange-100">
                                    <p className="text-xs text-orange-500 font-bold uppercase tracking-wider">Receitas Equivalentes</p>
                                    <p className="text-2xl font-bold text-orange-700">{calculation.targetBatches.toFixed(3)}</p>
                                </div>

                                <div className="text-right"><p className="text-sm text-emerald-600 font-medium">Produto Final Estimado</p><p className="text-3xl font-bold text-emerald-600">{calculation.finalProductWeightKg.toFixed(3)} <span className="text-lg">kg</span></p></div>

                                {/* NOVO: Exibição de Rendimento em Unidades/Pacotes */}
                                {calculation.finalUnitCount > 0 && (
                                    <div className="text-center bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
                                        <p className="text-xs text-blue-500 font-bold uppercase tracking-wider">Rendimento Estimado</p>
                                        <p className="text-2xl font-bold text-blue-700">
                                            {Math.floor(calculation.finalUnitCount)} <span className="text-sm font-normal">{calculation.unitLabel}</span>
                                        </p>
                                        <p className="text-[10px] text-blue-400">
                                            ({(selectedRecipe.outputUnitWeight || 0)} {selectedRecipe.outputUnitMeasure} / {calculation.unitLabel.slice(0,-1).toLowerCase()})
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-6">
                                <div className="print-only hidden">
                                    <table className="print-table">
                                        <thead>
                                            <tr>
                                                <th style={{ width: '70%' }}>INGREDIENTE</th>
                                                <th style={{ width: '30%', textAlign: 'right' }}>QTD (Receita)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {calculation.sections.map((section, sIdx) => (
                                                <React.Fragment key={sIdx}>
                                                    <tr className="print-section-header break-inside-avoid">
                                                        <td colSpan="2">
                                                            {section.name} (Perda: {section.processLossPct.toFixed(2)}% | Peso Final: {section.finalWeightKg.toFixed(3)} kg)
                                                        </td>
                                                    </tr>
                                                    {section.ingredients.map((ing, idx) => (
                                                        <tr key={`${sIdx}-${idx}`} className="break-inside-avoid">
                                                            <td>
                                                                {ing.name}
                                                                {ing.fixedPart > 0 && <span style={{fontSize: '9px', fontStyle: 'italic', marginLeft: '5px'}}> (Inc. {ing.fixedPart} {ing.unit} fixo)</span>}
                                                            </td>
                                                            <td style={{ textAlign: 'right' }}>{ing.calcNet.toFixed(3)} {ing.unit}</td>
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div style={{ marginTop: '20px', borderTop: '1px solid #000', paddingTop: '10px', display: 'flex', justifyContent: 'space-between', fontSize: '12px' }}>
                                        <span><strong>TOTAL BRUTO:</strong> {calculation.totalGrossKg.toFixed(3)} kg</span>
                                        <span><strong>PRODUTO FINAL ESTIMADO:</strong> {calculation.finalProductWeightKg.toFixed(3)} kg</span>
                                        {calculation.finalUnitCount > 0 && (
                                            <span><strong>RENDIMENTO:</strong> {Math.floor(calculation.finalUnitCount)} {calculation.unitLabel}</span>
                                        )}
                                    </div>
                                </div>

                                <div className="no-print">
                                    {calculation.sections.map((section, sIdx) => (
                                        <div key={sIdx} className="overflow-hidden rounded-lg border border-gray-200 bg-white mb-4">
                                            <div className="bg-orange-100 px-4 py-2 border-b border-orange-200 flex justify-between items-center">
                                                <div className="flex items-center gap-2"><span className="font-bold text-gray-700">{section.name}</span><span className="text-xs bg-white border border-gray-300 px-2 py-0.5 rounded-full text-gray-500">Perda: {section.processLossPct.toFixed(2)}%</span></div>
                                                <div className="text-xs text-gray-500">Peso Esperado: <strong>{section.finalWeightKg.toFixed(3)} kg</strong></div>
                                            </div>
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-white text-gray-500 uppercase text-[10px] font-bold border-b border-gray-100">
                                                    <tr><th className="p-3 w-1/3">Ingrediente</th><th className="p-3 text-right">Qtd Calculada</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {section.ingredients.map((ing, idx) => (
                                                        <tr key={idx} className="hover:bg-gray-50">
                                                            <td className="p-3 font-medium text-gray-800">{ing.name}</td>
                                                            <td className="p-3 text-right font-medium text-orange-600">{ing.calcNet.toFixed(3)} <span className="text-[10px] text-gray-400">{ing.unit}</span></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="mt-6 flex justify-end gap-3 no-print">
                                <button onClick={() => window.print()} className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 shadow-lg flex items-center gap-2 font-bold w-full md:w-auto justify-center">
                                    <Icon name="ClipboardList" size={20} /> Imprimir Ordem
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            // Estado Principal com Persistência LocalStorage robusta
            const [view, setView] = useState('dashboard');
            
            // Helper para carregar do localStorage com segurança (evita crash se dados corrompidos)
            const safeLoad = (key, fallback) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : fallback;
                } catch (e) {
                    console.error(`Erro ao carregar ${key} do localStorage`, e);
                    return fallback;
                }
            };

            const [recipes, setRecipes] = useState(() => safeLoad('prod_recipes', initialRecipes));
            const [lines, setLines] = useState(() => safeLoad('prod_lines', initialLines));
            const [stages, setStages] = useState(() => safeLoad('prod_stages', initialStages));
            const [settings, setSettings] = useState(() => safeLoad('prod_settings', { logo: null, themeColor: '#f97316' }));
            const [logs, setLogs] = useState(() => safeLoad('prod_logs', []));

            const [editingRecipe, setEditingRecipe] = useState(null);
            const [notification, setNotification] = useState(null);

            // Efeitos de Salvamento
            useEffect(() => { localStorage.setItem('prod_recipes', JSON.stringify(recipes)); }, [recipes]);
            useEffect(() => { localStorage.setItem('prod_lines', JSON.stringify(lines)); }, [lines]);
            useEffect(() => { localStorage.setItem('prod_stages', JSON.stringify(stages)); }, [stages]);
            useEffect(() => { localStorage.setItem('prod_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('prod_logs', JSON.stringify(logs)); }, [logs]);

            // Sistema de Notificação
            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // CRUD Receitas
            const handleSaveRecipe = (recipe) => {
                if (recipe.id) {
                    setRecipes(recipes.map(r => r.id === recipe.id ? { ...recipe, lastUpdated: new Date().toISOString() } : r));
                } else {
                    setRecipes([...recipes, { ...recipe, id: Date.now(), lastUpdated: new Date().toISOString() }]);
                }
                setEditingRecipe(null);
                setView('recipes');
                showNotification("Receita salva com sucesso!");
            };

            const handleDeleteRecipe = (id) => {
                if (confirm('Tem certeza que deseja excluir esta receita?')) {
                    setRecipes(recipes.filter(r => r.id !== id));
                    setEditingRecipe(null);
                    setView('recipes');
                    showNotification("Receita excluída.");
                }
            };

            // Lógica Central de Importação e Processamento do Excel (Em lote)
            const handleImportRecipe = async (files) => {
                const fileArray = Array.from(files);
                let importedCount = 0;
                let newRecipesBuffer = [];
                
                for (let file of fileArray) {
                    try {
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // NOVO: Loop em todas as abas (pastas de trabalho/planilhas) do arquivo Excel
                        for (const sheetName of workbook.SheetNames) {
                            const worksheet = workbook.Sheets[sheetName];
                            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                            if (!rows || rows.length === 0) continue; // Ignora abas vazias

                            // 1. Tentar extrair o nome da receita
                            let recipeName = sheetName; // Usa o nome da aba como padrão
                            
                            // Procurar por tag 'Preparação: '
                            for (let i=0; i < Math.min(rows.length, 15); i++) {
                                const row = rows[i];
                                for (let j=0; j < row.length; j++) {
                                    if (typeof row[j] === 'string' && row[j].toLowerCase().includes('preparação:')) {
                                        recipeName = row[j].replace(/preparação:/i, '').trim();
                                    }
                                }
                            }

                            // 2. Identificar cabeçalhos dinamicamente
                            let headerRowIdx = -1;
                            let idxIng = -1;
                            let idxQty = -1;

                            for (let i=0; i < Math.min(rows.length, 20); i++) {
                                const row = rows[i];
                                idxIng = row.findIndex(c => typeof c === 'string' && c.toLowerCase().trim() === 'ingrediente');
                                idxQty = row.findIndex(c => typeof c === 'string' && c.toLowerCase().trim() === 'quantidade');
                                
                                if (idxIng !== -1 && idxQty !== -1) {
                                    headerRowIdx = i;
                                    break;
                                }
                            }

                            if (headerRowIdx === -1) {
                                console.warn(`Cabeçalhos não encontrados na aba "${sheetName}" do arquivo ${file.name}. Verifique a estruturação.`);
                                continue; // Pula esta aba específica se for inválida
                            }

                            const parsedIngredients = [];
                            let currentSection = 'Geral';

                            // 3. Loop nas linhas de ingredientes
                            for (let i = headerRowIdx + 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row || row.length === 0) continue;

                                // Identificar Seção (Geralmente está na primeira coluna e não é vazia)
                                const col0 = String(row[0] || '').trim();
                                if (col0 && col0.length > 1 && !col0.toLowerCase().includes('total') && !col0.toLowerCase().includes('rendimento')) {
                                    currentSection = col0.toUpperCase();
                                }

                                const ingName = String(row[idxIng] || '').trim();
                                let qtyRaw = row[idxQty];
                                
                                // Critérios de parada e sanitização
                                if (ingName.toLowerCase().includes('total') || ingName.toLowerCase().includes('rendimento')) break;
                                if (col0.toLowerCase().includes('total') || col0.toLowerCase().includes('rendimento')) break;
                                if (!ingName) continue;

                                // Tratamento da quantidade (converte , para . e tenta fazer o parse)
                                let qty = typeof qtyRaw === 'number' ? qtyRaw : parseFloat(String(qtyRaw).replace(',', '.'));
                                
                                if (isNaN(qty)) continue;

                                // Tratamento de Unidade de Medida
                                let unit = String(row[idxQty + 1] || 'kg').trim().toLowerCase();
                                if (!unit || unit === '') unit = 'kg';

                                parsedIngredients.push({
                                    name: ingName,
                                    qty: qty,
                                    unit: unit,
                                    lossPct: 0,
                                    section: currentSection,
                                    fixedQty: 0
                                });
                            }

                            // 4. Se encontrou ingredientes validos, encapsular numa nova receita
                            if (parsedIngredients.length > 0) {
                                const newRecipe = {
                                    id: Date.now() + Math.floor(Math.random() * 100000) + importedCount, // IDs únicos
                                    name: recipeName || "Receita Importada",
                                    line: "Confeitaria", // Vinculando inicialmente como Confeitaria (Editável)
                                    lastUpdated: new Date().toISOString(),
                                    sections: {},
                                    ingredients: parsedIngredients,
                                    outputType: 'kg',
                                    outputUnitWeight: 0,
                                    outputUnitMeasure: 'g'
                                };
                                
                                // Cria as sub-seções iniciais
                                const uniqueSections = Array.from(new Set(parsedIngredients.map(i => i.section)));
                                uniqueSections.forEach(s => {
                                    newRecipe.sections[s] = { processLossPct: 0, tolerancePct: 10, targetSharePct: 0 };
                                });

                                newRecipesBuffer.push(newRecipe);
                                importedCount++;
                            }
                        }
                    } catch (err) {
                        console.error(`Falha no processamento de ${file.name}:`, err);
                    }
                }
                
                // Conclusão com feedback visual
                if (importedCount > 0) {
                    setRecipes(prev => {
                        // Evita duplicatas exatas pelo nome ignorando maiúsculas/minúsculas
                        const existingNames = prev.map(r => r.name.toLowerCase().trim());
                        const filteredNew = newRecipesBuffer.filter(nr => !existingNames.includes(nr.name.toLowerCase().trim()));
                        return [...prev, ...filteredNew];
                    });
                    showNotification(`${importedCount} receita(s) importada(s) de todas as abas com sucesso!`);
                    
                    // Garante que a linha Confeitaria exista para o filtro do catálogo
                    setLines(prev => prev.includes("Confeitaria") ? prev : [...prev, "Confeitaria"]);
                } else {
                    showNotification("Aviso: Nenhuma receita válida foi identificada nas abas.");
                }
            };

            // Roteamento de Views
            let content;
            if (view === 'dashboard') {
                content = <Dashboard setView={setView} />;
            } else if (view === 'production') {
                content = (
                    <div>
                        <div className="mb-4 no-print"><button onClick={() => setView('dashboard')} className="text-sm text-gray-500 hover:text-primary flex items-center gap-1"><Icon name="ArrowLeft" size={16}/> Voltar ao Painel</button></div>
                        <ProductionOrders recipes={recipes} lines={lines} onError={showNotification} />
                    </div>
                );
            } else if (view === 'monitoring') {
                content = (
                    <div>
                        <div className="mb-4 no-print"><button onClick={() => setView('dashboard')} className="text-sm text-gray-500 hover:text-primary flex items-center gap-1"><Icon name="ArrowLeft" size={16}/> Voltar ao Painel</button></div>
                         <MonitoringView recipes={recipes} logs={logs} setLogs={setLogs} />
                    </div>
                )
            } else if (view === 'recipes') {
                if (editingRecipe) {
                    if (editingRecipe.isViewOnly) {
                        content = <RecipeDetails recipe={editingRecipe} onBack={() => setEditingRecipe(null)} onEdit={(r) => setEditingRecipe({ ...r, isViewOnly: false })} onDelete={handleDeleteRecipe} />;
                    } else {
                        content = <RecipeEditor recipe={editingRecipe} lines={lines} stages={stages} onSave={handleSaveRecipe} onCancel={() => setEditingRecipe(null)} onError={showNotification} />;
                    }
                } else {
                    content = (
                        <div>
                            <div className="mb-4 no-print"><button onClick={() => setView('dashboard')} className="text-sm text-gray-500 hover:text-primary flex items-center gap-1"><Icon name="ArrowLeft" size={16}/> Voltar ao Painel</button></div>
                            <RecipeList 
                                recipes={recipes} 
                                lines={lines} 
                                onCreate={() => setEditingRecipe({ ingredients: [], sections: {} })} 
                                onView={(r) => setEditingRecipe({ ...r, isViewOnly: true })} 
                                onImport={handleImportRecipe} 
                                onBooklet={() => setView('booklet')}
                            />
                        </div>
                    );
                }
            } else if (view === 'booklet') {
                content = (
                    <RecipeBooklet recipes={recipes} settings={settings} onBack={() => setView('recipes')} />
                );
            } else if (view === 'settings') {
                content = (
                    <div>
                        <div className="mb-4 no-print"><button onClick={() => setView('dashboard')} className="text-sm text-gray-500 hover:text-primary flex items-center gap-1"><Icon name="ArrowLeft" size={16}/> Voltar ao Painel</button></div>
                        <SettingsView 
                            lines={lines} setLines={setLines} 
                            stages={stages} setStages={setStages} 
                            settings={settings} setSettings={setSettings}
                            recipes={recipes} setRecipes={setRecipes}
                            logs={logs} setLogs={setLogs}
                            onError={showNotification}
                            showNotification={showNotification}
                        />
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20 print:pb-0" style={{ backgroundColor: '#f9fafb' }}>
                    {/* Header Principal */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('dashboard')}>
                                    {settings.logo ? <img src={settings.logo} className="h-8 w-auto object-contain" /> : <div className="h-8 w-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold"><Icon name="ChefHat" /></div>}
                                    <h1 className="text-lg font-bold text-gray-800 hidden md:block">Gestão de Produção</h1>
                                </div>
                                <div className="text-xs text-gray-400 font-mono">v2.1.0</div>
                            </div>
                        </div>
                    </div>

                    {/* Conteúdo */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 print:p-0 print:max-w-none">
                        {content}
                    </main>

                    {/* Notificação Toast */}
                    {notification && (
                        <div className="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in flex items-center gap-3 no-print">
                            <Icon name="Info" size={20} className="text-primary" />
                            {notification}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
